<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller</title>
</head>

<body>
    <script src="js/SystemGenerator.js"></script>
    <script src="js/SophontGenerator.js"></script>
    <script src="js/names.js"></script>
    <style>
        body{
            background-color:black;
            color:white;
        }
        body.light{
            background-color:white;
            color:black;
        }
        @font-face {
            font-family: Bahnschrift;
            src: url(/Traveller/fonts/BAHNSCHRIFT.TTF);
        }
        nav.menu{
            display:block;
        }
        nav.menu ul{ margin:0px; }
        nav.menu li{display:inline-block;font-family: Bahnschrift; user-select: none; }
        nav.menu li a{cursor:pointer; text-decoration: none; color:white; background-color:black; display:inline-block; 
            padding:0.75rem; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; border:1px solid white; border-bottom:0px;}
        nav.menu li a:hover{ color:black; background-color: rgb(198, 198, 198);}
        nav.menu li a.selected{ color:black; background-color: white; border:1px solid black;}
        [data-nav]{ display:none; border:1px solid gray;}
        [data-nav='map']{display:block; border:0px;}
        div.control-block{
            display:inline-block; vertical-align:text-top;
        }
        div.controls{
            font-family: 'Consolas', 'Inconsolas', 'Courier New', Courier, monospace;
            resize:horizontal; overflow:hidden; border:1px solid gray; width:63rem;
        }
        fieldset {
            font-family: 'Consolas', 'Inconsolas', 'Courier New', Courier, monospace;
            display:block;
            resize:horizontal; overflow:hidden;
            max-width: 70rem;
            
        }
        fieldset.collapsed{
            display:inline-block;
            vertical-align:top;
        }
        
        canvas{
            vertical-align:text-top;
        }
        fieldset legend {
            cursor: pointer;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        fieldset legend:hover {
            color: red;
        }

        label {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        fieldset>fieldset {
            background-color: rgba(0, 0, 0, 0.05);
        }

        fieldset * {
            line-height: 1.5em;
        }
        
        fieldset.collapsed *:not(legend){
            display: none;
        }

        fieldset>legend::before{
            content: "‚ñº ";
        }

        fieldset.collapsed>legend::before {
            content: "‚ñ∫ ";
        }
        #SystemDetailsContainer fieldset {
            font-family: 'Bahnschrift Light', 'Bahnschrift', sans-serif;
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 20px;
            box-shadow: 1px 1px 4px rgba(50, 50, 100, 1);
            display: block;
            margin-bottom: 4px;
        }

        #SystemDetailsContainer fieldset>legend::before {
            content: "- ";
        }

        #SystemDetailsContainer fieldset.collapsed>legend::before {
            content: "+ ";
        }

        #SystemDetailsContainer fieldset legend {
            background-color: white;
            font-weight: bold;
        }

        canvas {
            border: 1px solid black;
            background-color: white;
        }

        .travelcodepickers select option[value="Amber"] {
            background: rgb(255, 255, 127);
        }

        .travelcodepickers select[data-color="Amber"] {
            background-color: rgb(255, 255, 127);
            ;
        }

        .travelcodepickers select option[value="Red"] {
            background: pink;
        }

        .travelcodepickers select[data-color="Red"] {
            background-color: pink;
        }

        #SystemDetailsContainer {
            display: inline-block;
            position: absolute;
            border: 1px solid gray;
            background-color: white;
            color: black;
            box-shadow: 2px 2px 4px black;
            font-family: 'Bahnschrift Light', 'Bahnschrift', sans-serif;
            min-width: 30rem;
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        body.light #AddSystemContainer{
            background-color: white;
            color: black;
        }
        #AddSystemContainer{
            font-size:smaller;
            display: inline-block;
            position: absolute;
            border: 1px solid gray;
            color:white;
            background-color:black;
            box-shadow: 2px 2px 4px black;
            font-family: 'Bahnschrift Light', 'Bahnschrift', sans-serif;
            min-width: 20rem;
            text-align: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #SystemDetailsContainer fieldset h4 .subtitle {
            font-weight: bold;
        }

        #SystemDetailsContainer fieldset .subnormal {
            font-weight: normal;
        }

        #SystemDetails {
            position: relative;
            display: inline-block;
            text-align: left;
            width:100%;
            font-size:smaller;
        }

        #SystemDetails h1,
        #SystemDetails h2,
        #SystemDetails h3,
        #SystemDetails h4 {
            font-family: 'Bahnschrift', sans-serif;
            margin-top: 0;
            margin-bottom: 0;
        }
        #SystemDetails h1 [data-system="tcoord"]{
            cursor:move;
        }
        #SystemDetails ul {
            margin-top: 0px;
        }

        fieldset label {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #maplist {
            list-style-image: url(images/world.png);
            border-radius: 20px;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 10px;
            box-shadow: 1px 1px 4px rgba(50, 50, 100, 1);
        }

        #maplist .star {
            list-style-image: url(images/star.png);
        }

        #maplist .Mainworld,
        #maplist .mainworld {
            color: black;
            list-style-image: url(images/hospitable.png);
            font-weight: 800;
        }

        #maplist .populated {
            color: black;
        }

        #maplist .Large.Gas.Giant {
            list-style-image: url(images/giant.png);
        }

        #maplist .Small.Gas.Giant {
            list-style-image: url(images/sgiant.png);
        }

        #maplist .Ice.Giant {
            list-style-image: url(images/igiant.png);
        }

        #maplist .Belt {
            list-style-image: url(images/belt.png);
        }

        #maplist .Asteroid.Belt {
            list-style-image: url(images/asteroidbelt.png);
            font-weight: 800;
        }

        #maplist .BigWorld {
            list-style-image: url(images/bworld.png);
        }

        #maplist .Ring {
            list-style-image: url(images/ring.png);
        }

        #maplist .Inner {
            list-style-image: url(images/inner.png);
        }

        #maplist .Inner {
            list-style-image: url(images/outer.png);
        }

        #maplist .Inferno {
            list-style-image: url(images/inferno.png);
        }

        #maplist .Iceworld {
            list-style-image: url(images/ice.png);
        }

        #maplist .RadWorld {
            list-style-image: url(images/rad.png);
        }

        #maplist .Hospitable {
            list-style-image: url(images/hospitable.png);
        }

        #maplist .StormWorld {
            list-style-image: url(images/storm.png);
        }

        #maplist .Occupied {
            list-style-image: url(images/occupied.png);
        }

        #maplist .Solar.Surface {
            list-style-image: url(images/surface.png);
        }

        #maplist .Worldlet {
            list-style-image: url(images/worldlet.png);
        }

        #maplist ul {
            margin-bottom: 8px;
            background-color: rgba(150, 150, 200, 0.1);
            border-radius: 20px;
            box-shadow: 1px 1px 4px rgba(50, 50, 100, 1);
            padding-left: 30px;
        }

        #maplist ul:empty {
            margin: 0px;
            display: none;
        }
        #maplist li{
            padding-bottom:0.5rem;
        }
        #dialog_close {
            float: right;
            font-weight: normal;
            cursor: pointer;
            font-size: 1rem;
            font-family: sans-serif;
            border: 1px solid black;
            padding: 4px;
            width: 2rem;
            text-align: center;
            border-radius: 4px;
        }
        #randSystemDetails #dialog_close{
            display:none;
        }
        #dialog_close:hover {
            background-color: darkred;
            color: white;
        }

        #nativedetails table,
        #nativedetails tr,
        #nativedetails td {
            vertical-align: top;
        }

        #nativedetails .table {
            box-shadow: 1px 1px 3px #555;
            border-radius: 0.3rem;
            border-collapse: collapse;
            overflow: hidden;
            border: 0.1rem solid black;
            display: inline-block;
            vertical-align: text-top;
            background-color:white;
        }

        #nativedetails .table tr:first-child {
            border-bottom: 1px solid black;
            background-color: #dfdfdf;
        }

        #nativedetails .table tr:nth-child(even) {
            background-color: #f0f0f0;
        }

        #nativedetails .table th,
        #nativedetails .table th td {
            text-align: left;
            font-weight: bold;
            vertical-align: text-top;
        }

        #nativedetails .table td+td,
        #nativedetails .table th+th {
            border-left: 0.01rem solid black;
        }

        #nativedetails .table td:empty,
        #nativedetails .table th:empty {
            border: 0px solid transparent !important;
        }

        .traitlist ul {
            list-style: none;
            padding: 0px;
            margin: 0px;
        }

        #nativedetails .collapsed .table {
            display: none;
        }

        .traitlist li {
            padding-left: 2rem;
        }

        #nativedetails .roller {
            display: inline-block;
            vertical-align: text-top;
        }

        #nativedetails .collapsed .roller {
            display: none;
        }

        .summarytext {
            max-width: 50rem;
            margin-top: .4rem;
            margin-bottom: .4rem;
        }
        #shipList{ font-family: Bahnschrift;}
        #shipList h2{ margin-bottom:0px; font-size:medium; cursor:pointer; user-select: none;}
        #shipList h2:hover { color:red;}
        #shipList ol{ margin-top:0px;}
        #shipList li{ font-style:italic;}
        #shipList h2.collapsed { text-decoration: underline;}
        #shipList h2.collapsed + ol{display:none;}
        #nilOutput table{ border-collapse: collapse; border:1px solid black; font-family:Bahnschrift;}
        #nilOutput th{ border-bottom:1px solid black; vertical-align: bottom; font-weight:normal; background-color:rgb(25, 45, 57); color:white;}
        #nilOutput td{ border-bottom:1px solid black; vertical-align: middle; text-align:center; font-size:smaller;}
        #nilOutput tr:nth-child(even) { background-color:rgba(240,240,240,0.2);}
        #randSystemDetails [data-copy='donot']{display:none;}
        .CargoContainer{
            border-radius:10px;
            text-align:left;
            padding:1rem;
            border:1px solid gray;
            display:inline-block;
            vertical-align: text-top;

        }
        #DestinationDetails{display:none;}
        #txtUWP{ width:5rem;}
        .dice{font-size:1rem; user-select:none; min-width:2rem; text-align:center; cursor:pointer; display:inline-block; vertical-align:middle; opacity: 0.6;}
        .dice:hover{opacity:1;}
    </style>
    <nav class="menu">
        <ul>
            <li><a target="map" class="selected">Map</a></li>
            <li><a target="tools">Tools</a></li>
            <li><a target="analysis">Analysis</a></li>
            <span style="display:block;float:right;"><label for="chkLightTheme"><input id="chkLightTheme" type="checkbox"> Light Theme</label></span>
        </ul>
    </nav>
    <div data-nav="map">
        <div class="control-block">
            <div class="controls">
                <label for="chkUseRandom"><input id="chkUseRandom" type="checkbox" checked="checked"> Use Random Seed</label>
                <label for="txtSeed"><input title="random seed" id="txtSeed" type="text"></label>
                <select name="slctMapSize" id="slctMapSize">
                    <option value="Sector" data-subsectorxoffset="0" data-subsectoryoffset="0" >Sector (32x40)</option>
                    <option value="Quadrant" data-subsectorxoffset="0" data-subsectoryoffset="0" >Alpha Quadrant (16x20)</option>
                    <option value="Quadrant" data-subsectorxoffset="16" data-subsectoryoffset="0">Beta Quadrant</option>
                    <option value="Quadrant" data-subsectorxoffset="0" data-subsectoryoffset="20">Gamma Quadrant</option>
                    <option value="Quadrant" data-subsectorxoffset="16" data-subsectoryoffset="20">Delta Quadrant</option>
                    <option value="Subsector" data-subsectorxoffset="0" data-subsectoryoffset="0" selected="selected">Subsector A (8x10)</option>
                    <option value="Subsector" data-subsectorxoffset="8" data-subsectoryoffset="0">Subsector B</option>
                    <option value="Subsector" data-subsectorxoffset="16" data-subsectoryoffset="0">Subsector C</option>
                    <option value="Subsector" data-subsectorxoffset="24" data-subsectoryoffset="0">Subsector D</option>
                    <option value="Subsector" data-subsectorxoffset="0" data-subsectoryoffset="10">Subsector E</option>
                    <option value="Subsector" data-subsectorxoffset="8" data-subsectoryoffset="10">Subsector F</option>
                    <option value="Subsector" data-subsectorxoffset="16" data-subsectoryoffset="10">Subsector G</option>
                    <option value="Subsector" data-subsectorxoffset="24" data-subsectoryoffset="10">Subsector H</option>
                    <option value="Subsector" data-subsectorxoffset="0" data-subsectoryoffset="20">Subsector I</option>
                    <option value="Subsector" data-subsectorxoffset="8" data-subsectoryoffset="20">Subsector J</option>
                    <option value="Subsector" data-subsectorxoffset="16" data-subsectoryoffset="20">Subsector K</option>
                    <option value="Subsector" data-subsectorxoffset="24" data-subsectoryoffset="20">Subsector L</option>
                    <option value="Subsector" data-subsectorxoffset="0" data-subsectoryoffset="30">Subsector M</option>
                    <option value="Subsector" data-subsectorxoffset="8" data-subsectoryoffset="30">Subsector N</option>
                    <option value="Subsector" data-subsectorxoffset="16" data-subsectoryoffset="30">Subsector O</option>
                    <option value="Subsector" data-subsectorxoffset="24" data-subsectoryoffset="30">Subsector P</option>
                </select>
                <select name="slctStellarDensity" id="slctStellarDensity">
                    <option value="Extra Galactic">Extra Galactic (1%)</option>
                    <option value="Rift">Rift (3%)</option>
                    <option value="Sparse">Sparse (17%)</option>
                    <option value="Scattered">Scattered (33%)</option>
                    <option value="Standard" selected="selected">Standard (50%)</option>
                    <option value="Dense">Dense (66%)</option>
                    <option value="Cluster">Cluster (83%)</option>
                    <option value="Core">Core (97%)</option>
                    <option value="Clump">Dense in middle</option>
                </select>
                <label for="btnPopulateSystems"><input type="button" id="btnPopulateSystems" name="btnPopulateSystems"
                        value="Populate Map"></label>
                <label for="btnClearSystems"><input type="button" id="btnClearSystems" name="btnClearSystems"
                        value="Clear Map"></label>
                <label for="btnSaveImg"><input type="button" id="btnSaveImg" name="btnSaveImage" value="Save .png" /></label>
                <br />
                <fieldset class="collapsed">
                    <legend>Appearance</legend>
                    <label for="sizeSlider">Scale: <span id="sizeIndicator"></span></label><input type="range" min="4" max="50"
                        id="sizeSlider" />
                    <label for="slctStyle">Theme: </label><select name="slctStyle" id="slctStyle" data-text="white"
                        data-canvasbg="black" data-ctext="transparent" data-hexfg="cyan" data-hexbg="rgba(0,200,255,0.2)">
                        <option value="light">light</option>
                        <option value="dark">dark</option>
                        <option value="transparent">transparent</option>
                        <option selected="selected" value="custom">custom</option>
                    </select>
                    <br />
                    <fieldset id="customSettings" class="collapsed">
                        <legend>Advanced</legend>
                        <label for="textColor">Primary Text Color: <input type="text" name="textColor" id="textColor" /></label><br />
                        <label for="coordTextColor">Coordinate Text Color: <input type="text" name="coordTextColor" id="coordTextColor" /></label><br />
                        <label for="hexBorderColor">Border Color: <input type="text" name="hexBorderColor"
                                id="hexBorderColor" /></label><br />
                        <label for="hexBackgroundColor">Hex Fill: <input type="text" id="hexBackgroundColor"
                                name="hexBackgroundColor" /></label><br />
                        <label for="canvasBackgroundColor">Background Color: <input type="text" name="canvasBackgroundColor"
                                id="canvasBackgroundColor" /></label><br />
                        <label for="fontFamily">Font: <input type="text" id="fontFamily" name="fontFamily"
                                value="Segoe UI, sans-serif" /></label><br/>
                        <label for="tradeRouteColor">Trade Route Color: <input type="text" name="tradeRouteColor" id="tradeRouteColor" value="rgba(50,200,80,1)"></label>
                    </fieldset>
                </fieldset>
                <fieldset class="collapsed">
                    <legend>Overlays</legend>
                    
                    <label for="slcHeatMap">Heat Map: <select name="slcHeatMap" id="slcHeatMap">
                            <option value="-1" selected=selected>No Heatmap</option>
                            <option value="0">Starport</option>
                            <option value="1">Size</option>
                            <option value="2">Atmosphere</option>
                            <option value="3">Hydrography</option>
                            <option value="4">Mainworld Population</option>
                            <option value="5">Government Type</option>
                            <option value="6">Law Level</option>
                            <option value="7">Tech Level</option>
                            <option value="8">Importance</option>
                            <option value="9">Total System Pop</option>
                            <option value="10">Economy</option>
                            <option value="11">Native Intelligent Life</option>
                        </select>
                    </label><br />
                    <label for="chkShowTravelCodes"><input type="checkbox" name="chkShowTravelCodes" id="chkShowTravelCodes"
                            checked="checked" /> Show Travel Codes&nbsp;</label><label for="chkShowTradeRoutes">&nbsp;<input type="checkbox" checked="checked" name="chkShowTradeRoutes" id="chkShowTradeRoutes"/> Show Trade Routes</label>
                            <fieldset class="collapsed">
                                <legend>Trade Routes</legend>
                                <label for="numProfitThreshold">(Minimum Profit Threshold: <input id="numProfitThreshold" type="number" style="width:4em" value="1250"/></label>
                                <label for="numParsecPremium">Premium per Parsec: <input id="numParsecPremium" type="number" style="width:4em" value="1250"/>)</label>
                            <br/><label for="slctMinJump1Starport">Jump-1 Route Min Starport: <select id="slctMinJump1Starport">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option selected="selected" value="D">D</option>
                                <option value="E">E</option>
                                <option value="X">X</option>
                            </select></label> 
                            <label for="slctMinJump1Importance">Min Importance: <select id="slctMinJump1Importance">
                                <option value="6">+6 Very Important</option>
                                <option value="5">+5 Very Important</option>
                                <option value="4">+4 Important</option>
                                <option value="3">+3 Ordinary</option>
                                <option value="2">+2 Ordinary</option>
                                <option value="1">+1 Ordinary</option>
                                <option selected="selected" value="0">0 Unimportant</option>
                                <option value="-1">-1 Unimportant</option>
                                <option value="-2">-2 Very Unimportant</option>
                                <option value="-3">-3 Very Unimportant</option>
                            </select></label>
                            <br/>
                            <label for="slctMinJump2Starport">Jump-2 Route Min Starport: <select id="slctMinJump2Starport">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option selected="selected" value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="X">X</option>
                            </select></label>
                            <label for="slctMinJump2Importance">Min Importance: <select id="slctMinJump2Importance">
                                <option value="6">+6 Very Important</option>
                                <option value="5">+5 Very Important</option>
                                <option value="4">+4 Important</option>
                                <option value="3">+3 Ordinary</option>
                                <option value="2">+2 Ordinary</option>
                                <option selected="selected" value="1">+1 Ordinary</option>
                                <option value="0">0 Unimportant</option>
                                <option value="-1">-1 Unimportant</option>
                                <option value="-2">-2 Very Unimportant</option>
                                <option value="-3">-3 Very Unimportant</option>
                            </select></label>
                            <br/>
                            <label for="slctMinJump3Starport">Jump-3 Route Min Starport: <select id="slctMinJump3Starport">
                                <option value="A">A</option>
                                <option selected="selected" value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="X">X</option>
                            </select></label>
                            <label for="slctMinJump3Importance">Min Importance: <select id="slctMinJump3Importance">
                                <option value="6">+6 Very Important</option>
                                <option value="5">+5 Very Important</option>
                                <option value="4">+4 Important</option>
                                <option value="3">+3 Ordinary</option>
                                <option selected="selected" value="2">+2 Ordinary</option>
                                <option value="1">+1 Ordinary</option>
                                <option value="0">0 Unimportant</option>
                                <option value="-1">-1 Unimportant</option>
                                <option value="-2">-2 Very Unimportant</option>
                                <option value="-3">-3 Very Unimportant</option>
                            </select></label>
                            <br/>
                        </fieldset>
                        </fieldset>
                <fieldset class="collapsed">
                    <legend>Configuration</legend>
                    <fieldset class="collapsed">
                        <legend>Astrographics</legend>
                        <label for="slctMainworldRules">System Gen Ruleset:
                            <select name="slctMainworldRules" id="slctMainworldRules">
                                <option value="T5">T5</option>
                            </select></label><br />
                        <label for="slctGGFrequency">Gas Giant Occurrence: <select name="slctGGFrequency" id="slctGGFrequency">
                                <option selected=selected value=8>8- on 2D (T5) 72%</option>
                                <option value=9>9- on 2D (CE) 83%</option>
                            </select></label><br />
                            <label for="chkApplyHillSphereLimits"><input type="checkbox" checked="checked"
                                id="chkApplyHillSphereLimits" name="chkApplyHillSphereLimits">Limit satellite orbits to Hill sphere</label><br />
                            <label for="chkAllowInnerWhiteDwarfs"><input type="checkbox" checked="checked"
                                id="chkAllowInnerWhiteDwarfs" name="chkAllowInnerWhiteDwarfs">Allow white dwarfs in inner orbits</label><br />
                    </fieldset>
                    <fieldset class="collapsed">
                        <legend>Demographics</legend>
                        <label for="slctMaxTechLevel">Maximum Tech Level:
                            <select name="slctMaxTechLevel" id="slctMaxTechLevel">
                                <option value=22>22 (N)</option>
                                <option value=21>21 (M)</option>
                                <option value=20>20 (L)</option>
                                <option value=19>19 (K)</option>
                                <option value=18>18 (J)</option>
                                <option value=17>17 (H)</option>
                                <option value=16 selected="selected">16 (G)</option>
                                <option value=15>15 (F)</option>
                                <option value=14>14 (E)</option>
                                <option value=13>13 (D)</option>
                                <option value=12>12 (C)</option>
                                <option value=11>11 (B)</option>
                                <option value=10>10 (A)</option>
                                <option value=9>9</option>
                                <option value=8>8</option>
                                <option value=7>7</option>
                                <option value=6>6</option>
                                <option value=5>5</option>
                                <option value=4>4</option>
                                <option value=3>3</option>
                                <option value=2>2</option>
                                <option value=1>1</option>
                                <option value=0>0</option>
                            </select>
                        </label>
                        <br />
                        <label for="chkPermitDieback" title="Dieback worlds have 0 population but TL>0"><input checked="checked"
                                type="checkbox" name="chkPermitDieback" id="chkPermitDieback" /> Permit Dieback Worlds</label>
                        <br />
                        <label for="chkPopulateNonMainworlds"
                            title="Check to allow population on worlds other than the system's mainworld"><input
                                checked="checked" type="checkbox" name="chkPopulateNonMainworlds"
                                id="chkPopulateNonMainworlds" /> Allow Non-Mainworld Pops</label>
                        <br />
                        <fieldset class="collapsed">
                            <legend>Capitals</legend>
                            <label for="chkDesignateSubsectorCapitals">Designate Subsector Capital(s) <input checked="checked"
                                    type="checkbox" id="chkDesignateSubsectorCapitals"></label><br />
                            <label for="chkDesignateSectorCapital">Designate Sector Capital <input
                                    type="checkbox" id="chkDesignateSectorCapital"></label>
                        </fieldset>
                        <br />
                        <fieldset class="collapsed">
                            <legend>Native Life</legend>
                            <label for="chkGenerateNatives"><input type="checkbox" id="chkGenerateNatives"
                                    title="chkGenerateNatives" checked="checked"> Generate Native Sophonts </label><br />
                            <label for="slctNativeLikelihood">Likelihood <select id="slctNativeLikelihood">
                                    <option value="really">All Candidate Worlds</option>
                                    <option value="everywhere">Pervasive</option>
                                    <option value="common" selected="selected">Common</option>
                                    <option value="reasonable">Reasonable</option>
                                    <option value="rare">Rare</option>
                                </select></label>
                            <br /><span style="font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Candidate homeworlds
                                have Atmo 2+ and Pop 7+.
                                <br />Unless "All Candidate Worlds" selected, natives less likely in exotic atmo.</span>
                        </fieldset>
                    </fieldset>
                    <fieldset class="collapsed travelcodepickers">
                        <legend>Travel Zones</legend>
                        <input type="button" value="Remove travel codes" id="btnClearTravelCodes" /><br />
                        <fieldset class="collapsed">
                            <legend>Automatic Assignment</legend>
                            <input type="button" disabled=true value="Apply travel zones" id="btnApplyTravelCodes" />
                            <input type="button" disabled=true value="Thriggle Defaults" id="btnResetTravelCodes">
                            <input type="button" value="CE Defaults" id="btnCETravelCodes">
                            <input type="button" value="T5 Defaults" id="btnT5TravelCodes">
                            <br />
                            <fieldset class="collapsed">
                                <legend>Habitation</legend>
                                <label for="slctRedZoneX" title="Pop>0 but Starport=X"><select data-color="Red"
                                        name="slctRedZoneX" id="slctRedZoneX">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option selected="selected" value="Red">Red</option>
                                    </select> Inhabited w/out Starport</label><br />
                                <label for="slctAmberZoneBa" title="Barren worlds have 0 population and TL=0"><select
                                        data-color="Amber" name="slctAmberZoneBa" id="slctAmberZoneBa">
                                        <option value="N/A">N/A</option>
                                        <option selected="selected" value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Barren Worlds </label><br />
                                <label for="slctAmberZoneBaX" title="Pop=0 and Starport=X"><select data-color="N/A"
                                        name="slctAmberZoneBaX" id="slctAmberZoneBaX">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Uninhabited w/out Starport</label><br />
                                <label for="slctAmberDieback" title="Dieback worlds have 0 population but TL>0"><select
                                        data-color="Red" name="slctAmberDieback" id="slctAmberDieback">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option selected="selected" value="Red">Red</option>
                                    </select> Dieback Worlds </label><br />
                            </fieldset>
                            <fieldset class="collapsed">
                                <legend>Atmosphere</legend>
                                <label for="slctAmberZoneAtmo"><select data-color="Amber" name="slctAmberZoneAtmo"
                                        id="slctAmberZoneAtmo">
                                        <option value="N/A">N/A</option>
                                        <option selected="selected" value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Dangerous Atmospheres (<select id="slctDangerousAtmoThreshold">
                                        <option value=10>10</option>
                                        <option value=11>11</option>
                                        <option selected="selected" value=12>12</option>
                                        <option value=13>13</option>
                                        <option value=14>14</option>
                                        <option value=15>15</option>
                                    </select>+, <select id="slctDangerousAtmoThresholdMax">
                                        <option value=10>10</option>
                                        <option value=11>11</option>
                                        <option selected="selected" value=12>12</option>
                                        <option value=13>13</option>
                                        <option value=14>14</option>
                                        <option value=15>15</option>
                                    </select>-)</label><br />
                            </fieldset>
                            <fieldset class="collapsed">
                                <legend>Law Level</legend>
                                <label for="slctRedGovLaw"><select name="slctRedGovLaw" data-color="Amber" id="slctRedGovLaw">
                                        <option value="N/A">N/A</option>
                                        <option selected="selected" value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Law + Government >= <select id="slctRedGovLawThreshold">
                                        <option value=30>30</option>
                                        <option value=29>29</option>
                                        <option value=28>28</option>
                                        <option value=27>27</option>
                                        <option value=26>26</option>
                                        <option value=25>25</option>
                                        <option value=24>24</option>
                                        <option value=23>23</option>
                                        <option value=22>22</option>
                                        <option selected=selected value=21>21</option>
                                        <option value=20>20</option>
                                        <option value=19>19</option>
                                    </select></label><br />
                                <label for="slctAmberGovLaw"><select name="slctAmberGovLaw" data-color="N/A"
                                        id="slctAmberGovLaw">
                                        <option selected="selected" value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Law + Government >= <select id="slctAmberGovLawThreshold">
                                        <option value=30>30</option>
                                        <option value=29>29</option>
                                        <option value=28>28</option>
                                        <option value=27>27</option>
                                        <option value=26>26</option>
                                        <option value=25>25</option>
                                        <option value=24>24</option>
                                        <option value=23>23</option>
                                        <option value=22>22</option>
                                        <option value=21>21</option>
                                        <option selected=selected value=20>20</option>
                                        <option value=19>19</option>
                                    </select></label><br />
                                <label for="slctAmberZoneLL"><select name="slctAmberZoneLL" data-color="N/A"
                                        id="slctAmberZoneLL">
                                        <option selected="selected" value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Highest LL World(s) (min <select id="slctMaxLawLevelThreshold">
                                        <option value=15>15</option>
                                        <option value=14>14</option>
                                        <option value=13>13</option>
                                        <option value=12>12</option>
                                        <option value=11>11</option>
                                        <option value=10>10</option>
                                        <option selected=selected value=9>9</option>
                                        <option value=8>8</option>
                                    </select>+)</label><br />
                                <label for="slctAmberZone9LL"><select data-color="N/A" name="slctAmberZone9LL"
                                        id="slctAmberZone9LL">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> High Law (<select id="slctLawLevelThreshold">
                                        <option value=15>15</option>
                                        <option value=14>14</option>
                                        <option value=13>13</option>
                                        <option value=12>12</option>
                                        <option value=11>11</option>
                                        <option value=10>10</option>
                                        <option selected=selected value=9>9</option>
                                        <option value=8>8</option>
                                    </select>+) Worlds </label><br />
                                <label for="slctAmberZone0LL"><select data-color="N/A" name="slctAmberZone0LL"
                                        id="slctAmberZone0LL">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Lawless Worlds</label><br />
                            </fieldset>
                            <fieldset class="collapsed">
                                <legend>Government</legend>
                                <label for="slctAmberZoneGov0"><select data-color="N/A" name="slctAmberZoneGov0"
                                        id="slctAmberZoneGov0">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Ungoverned Worlds</label><br />
                                <label for="slctAmberZoneGov7"><select data-color="N/A" name="slctAmberZoneGov7"
                                        id="slctAmberZoneGov7">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Balkanized Worlds</label><br />
                                <label for="slctAmberZoneGov10"><select data-color="N/A" name="slctAmberZoneGov10"
                                        id="slctAmberZoneGov10">
                                        <option value="N/A">N/A</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Red">Red</option>
                                    </select> Charismatic Dictatorships</label><br />
                            </fieldset>
        
                        </fieldset>
        
                    </fieldset>
        
                </fieldset>
        
                <fieldset class="collapsed">
                    <legend>Export/Import</legend>
                    <fieldset class="collapsed">
                        <legend>T5 Tab Delimited Format</legend>
                        <label for="sectordata"><textarea placeholder="sectordata" title="sectordata" name="sectordata"
                                id="sectordata" cols="128" rows="10"></textarea></label>
                        <br />
                        <input type="button" value="Export to .tsv" id="btnExportCsv" />
                        <input type="button" value="Export to Excel-friendly .tsv" id="btnExportExcel" />
                        <input type="button" value="Export to .txt" id="btnExportTxt" />
                        <input type="button" value="Export to .png Poster from TravellerMap.com" id="btnTravellerMapPoster" />
                    </fieldset>
                    <fieldset class="collapsed">
                        <legend>JSON</legend>
                        <label for="data"><textarea title="data" placeholder="data" name="data" id="data" cols="45"
                                rows="5"></textarea></label>
                        <br />
                        <input type="button" value="Export to .json" id="btnExportJSON" />
                        <input type="button" value="Apply above JSON" id="btnApplyData"><br />
                        <label for="btnImportJSON">Load .json from file: </label><input type="file" Text="Import JSON"
                            id="btnImportJSON" accept="text/*,.json" />
                    </fieldset>
                    <input type="button" value="Save" onclick="document.getElementById('btnExportJSON').click();"/>
                    <input type="button" value="Load" onclick="document.getElementById('btnImportJSON').click();"/>
                </fieldset>
            </div>
        </div>
        <canvas id="canvas"></canvas>
        <div id="AddSystemContainer" style="display:none;">
            <h1></h1>
            <h2>Add new system here?</h2>
            <input type="button" id="btnAddNewSystem" id="btnAddNewSystem" value="Yes" /> <input type="button" name="btnCancelAddNewSystem" id="btnCancelAddNewSystem" value="No">
        </div>
        <div id="SystemDetailsContainer" style="display:none;">
            <div id="SystemDetails">
                <h1><span title="Reroll system name" class="dice" data-randomize="systemname">üé≤</span>&nbsp;<span data-system="tcoord"></span>: <span data-system="name" >System Name</span><span title="Edit system name" id="btnEditSystemName" class="dice">üñäÔ∏è</span><input type="text" title="Change the system name" id="txtSystemName" style="display:none"/><span id="btnSaveSystemName" title="Update system name" class="dice" style="display:none;">üíæ</span><SPAN class="dice" title="Cancel editing system name" style="display:none;" id="btnCancelSystemName">‚ùå</SPAN><span id="btnDeleteSystem" title="Delete this system" class="dice">üóëÔ∏è</span><span
                        id="dialog_close">X</span></h1>
                <h2><span title="Reroll UWP and system" class="dice" data-randomize="system">üé≤</span>&nbsp;<span title="Universal World Profile" data-system="uwp"></span><span title="Edit UWP" id="btnEditUWP" class="dice">üñäÔ∏è</span><input type="text" title="Change the UWP" id="txtUWP" style="display:none"/><span id="btnBuildFromUWP" title="Generate new system using given UWP" class="dice" style="display:none;">‚öóÔ∏è</span><span id="btnUpdateUWP" title="Update the mainworld UWP without changing system details" class="dice" style="display:none;">üíæ</span><SPAN class="dice" title="Cancel editing UWP" style="display:none;" id="btnCancelEditUWP">‚ùå</SPAN> <span title="Trade Codes"
                        data-mainworld="tradecodes" data-join=" "></span></h2>
                <h3 style="font-weight:normal; font-size:medium;" data-mainworld="tradecodes" data-lookup="tradecode"
                    data-join=", "></h3>
                <h3
                    style="font-weight: normal; font-family:'Consolas','Inconsolas','Courier New', Courier, monospace; font-size:small;">
                    <span title="Universal World Profile" data-system="uwp"></span> <span title="Trade Codes"
                        data-mainworld="tradecodes" data-join=" "></span> {<span data-importance="extension"
                        title="Importance Extension" data-showsign="true">Importance</span>} (<span
                        title="Economic Extension: Resources, Labor, Infrastructure, +Efficiency"
                        data-economics="extension">Economics</span>) [<span
                        title="Cultural Extension: Heterogeneity, Acceptance, Strangness, Symbols"
                        data-culture="extension">Culture</span>] <span title="Nobility" data-system="nobility"
                        data-join=""></span></h3>
                <h3 style="color:darkred"><span data-system="travelcodenotes"></span></h3>
                <fieldset>
                    <legend>Importance and Economy</legend>
                    <h4><span data-importance="description">System Importance</span> system (<span class="subnormal"
                            data-importance="weeklytraffic"></span> ships/week)</h3>
                        <h4><span class="subtitle">Available Resource Units:</span> <span class="subnormal"
                                data-economics="RU"></span></h3>
                            <h4>
                                <span class="subtitle">Bases:</span> <span class="subnormal" data-system="bases"
                                    data-join=", " data-ifblank="None">None</span>
                                <span class="subtitle">Gas Giants:</span> <span class="subnormal" data-system="gg"
                                    data-ifblank="None">None</span>
                                <span class="subtitle">Planetoid Belts:</span> <span class="subnormal"
                                    data-system="planetoidBelts" data-ifblank="None">None</span>
                            </h4>
                            <h4><span class="subtitle">Nobility:</span> <span class="subnormal" data-system="nobility"
                                    data-lookup="nobility" data-join=", "></span></h4>
                </fieldset>
    
                <fieldset>
                    <legend>Mainworld Details</legend>
    
                    <ul class="mainworlddetails">
                        <li><strong>Starport</strong> <span data-mainworld="starport" data-lookup="port"></span> <span
                                data-mainworld="highport" data-iftrue="(Has Highport)" data-iffalse="(No Highport)"></span>
                        </li>
                        <li><strong>Size:</strong> <span data-mainworld="size" data-lookup="size"></span></li>
                        <li><strong>Atmosphere:</strong> <span data-mainworld="atmo" data-lookup="atmo"></span></li>
                        <li><strong>Hydrographics:</strong> <span data-mainworld="hydro" data-lookup="hydro"></span></li>
                        <li><strong>Population:</strong> ~<span data-format="number" data-mainworld="roughpop"></span>
                            (<span data-mainworld="popdigit"></span><span data-mainworld="pop"
                                data-lookup="pop"></span>)</span></li>
                        <li><strong>Government:</strong> <span data-mainworld="gov" data-lookup="gov"></span></li>
                        <li><strong>Law:</strong> <span data-mainworld="law" data-lookup="law"></span></li>
                        <li><strong>Tech Level:</strong> <span data-mainworld="tech" data-lookup="tech"></span></li>
                        <li><strong>Climate:</strong> <span data-mainworld="climate" data-ifblank="N/A"></span></li>
                        <li><span style="display:inline-block; vertical-align:text-top;"><strong>Culture:</strong></span>
                            <span style="display:inline-block; vertical-align:text-top; max-width:400px">
                                <span data-culture="heterogeneity" data-lookup="heterogeneity"></span><span
                                    data-culture="acceptance" data-lookup="acceptance"></span><span
                                    data-culture="strangeness" data-lookup="strangeness"></span><span data-culture="symbols"
                                    data-lookup="symbols"></span>
                            </span>
                        </li>
                    </ul>
                </fieldset>
                <fieldset class="collapsed">
                    <legend>System Map</legend>
                    <ul id="maplist"></ul>
                </fieldset>
                <fieldset id="nativedetailscontainer" class="collapsed">
                    <legend>Native Sophonts</legend>
                    <div id="nativedetails">
                        <h1>The <span data-detail="name" data-source="species"></span> of <span data-system="name"></span>
                        </h1>
                        <fieldset>
                            <legend>Physical Appearance</legend>
                            <p data-detail="physsummary" class="summarytext" data-source="species"></p>
                            <fieldset class="collapsed">
                                <legend>Appearance Details</legend>
                                <div><strong>Locomotion:</strong> <span data-detail="locomotion"
                                        data-source="species"></span></div>
                                <div><strong>Symmetry: </strong><span data-detail="symmetry" data-source="species"></span>
                                </div>
                                <div><strong>Stance: </strong></strong><span data-detail="stance"
                                        data-source="species"></span></div>
                                <div><strong>Manipulators: </strong><span data-detail="allmanipulators"
                                        data-source="species"></span></div>
                                <div><strong>Natural Weapon: </strong><span data-detail="naturalweapon"
                                        data-source="species"></span></div>
                                <div><strong>Body Covering: </strong><span data-detail="skin" data-source="species"></span>
                                </div>
                                <div><strong>Skeletal Structure: </strong><span data-detail="skeleton"
                                        data-source="species"></span> <strong>Body Fluids: </strong><span
                                        data-detail="fluids" data-source="species"></span> </div>
                                <div><strong>Size:</strong> <span data-detail="sizeclass" data-source="species"></span>
                                    (<span data-detail="size" data-source="species"></span> kg, <span data-detail="height"
                                        data-source="species"></span>) <strong>Profile:</strong> <span data-detail="bfp"
                                        data-source="species"></span> (<span data-detail="bfpdesc"
                                        data-source="species"></span>)</div>
                                <div><strong>Body Plan: </strong><span data-detail="bodystructure"
                                        data-source="species"></span></div>
                                <table class="table">
                                    <tr>
                                        <th>Segment</th>
                                        <th>Value</th>
                                        <th>Limbs</th>
                                        <th>Description</th>
                                    </tr>
                                    <tr>
                                        <td>Head</td>
                                        <td><span data-detail="head" data-source="species"></span></td>
                                        <td> </td>
                                        <td><span data-detail="headdesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Torso</td>
                                        <td><span data-detail="torso" data-source="species"></span></td>
                                        <td> </td>
                                        <td><span data-detail="torsodesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Front Limbs</td>
                                        <td><span data-detail="frontlimbs" data-source="species"></span></td>
                                        <td><span data-detail="frontlimbs1" data-source="species"></span> <span
                                                data-detail="frontlimbs2" data-source="species"></span></td>
                                        <td><span data-detail="frontlimbsdesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Rear Limbs</td>
                                        <td><span data-detail="rearlimbs" data-source="species"></span></td>
                                        <td><span data-detail="rearlimbs1" data-source="species"></span> <span
                                                data-detail="rearlimbs2" data-source="species"></span></td>
                                        <td><span data-detail="rearlimbsdesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Other</td>
                                        <td><span data-detail="tail" data-source="species"></span></td>
                                        <td><span data-detail="taillimbs" data-source="species"></span></span></td>
                                        <td><span data-detail="taildesc" data-source="species"></span></td>
                                    </tr>
                                </table>
                            </fieldset>
    
                        </fieldset>
                        <fieldset>
                            <legend>Senses</legend>
    
                            <p data-detail="sensesummary" class="summarytext" data-source="species"></p>
                            <fieldset class="collapsed">
                                <legend>Sense Details</legend>
                                <div><strong>Language: </strong><span data-detail="language" data-source="species"></span> </div>
                                <table class="table">
                                    <tr>
                                        <th>Sense</th>
                                        <th>Capability</th>
                                        <th>Notes</th>
                                    </tr>
                                    <tr>
                                        <td>Vision</td>
                                        <td><span data-detail="vision" data-source="species"></span></td>
                                        <td>
                                            <span data-detail="visiondesc" data-source="species"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Hearing</td>
                                        <td><span data-detail="hearing" data-source="species"></span></td>
                                        <td><span data-detail="hearingdesc" data-source="species"></span><br />
                                            <span data-detail="hearingrangedesc" data-source="species"></span>
                                            <br /><span data-detail="voicedesc" data-source="species"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Smell</td>
                                        <td><span data-detail="smell" data-source="species"></span></td>
                                        <td><span data-detail="smelldesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Touch</td>
                                        <td><span data-detail="touch" data-source="species"></span></td>
                                        <td><span data-detail="touchdesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Aware</td>
                                        <td><span data-detail="aware" data-source="species"></span></td>
                                        <td><span data-detail="awaredesc" data-source="species"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Percept</td>
                                        <td><span data-detail="percep" data-source="species"></span></td>
                                        <td><span data-detail="percepdesc" data-source="species"></span></td>
                                    </tr>
                                </table>
                                <div><strong>Note:</strong> Human senses are V-16-RGB, H-16-9382, S-10-02, and T-06-02</div>
                            </fieldset>
                        </fieldset>
                        <fieldset>
                            <legend>Habitat</legend>
    
                            <p data-detail="habitatsummary" class="summarytext" data-source="species"></p>
                            <fieldset class="collapsed">
                                <legend>Habitat Details</legend>
                                <div><strong>Breathes:</strong> <span data-detail="breathes" data-source="species"></span>
                                </div>
                                <div><strong>Native Terrain:</strong> <span data-detail="nativeTerrain"
                                        data-source="species"></span></div>
                                <div><strong>Climate:</strong> <span data-detail="climate" data-source="species"></span>
                                </div>
                                <div><strong>Niche:</strong> <span data-detail="class" data-source="species"></span> (<span
                                        data-detail="niche" data-source="species"></span>)</div>
                            </fieldset>
                        </fieldset>
                        <fieldset>
                            <legend>Life and Society</legend>
                            <p data-detail="lifesummary" class="summarytext" data-source="species"></p>
                        <fieldset class="collapsed">
                            <legend>Life Stages</legend>
                            
                            <div><strong>Life Expectancy:</strong> <span data-detail="lifeexpectancy"
                                    data-source="species"></span> years 
                                    <strong>Generation Length:</strong> <span data-detail="generation" data-source="species"> </span> years</div>
                            
                            <table class="table">
                                <tr>
                                    <th>#</th>
                                    <th>Life Stage</th>
                                    <th>Duration</th>
                                    <th>Ages</th>
                                    <th>Notes</th>
                                </tr>
                                <tr>
                                    <td>0</td>
                                    <td>Infant</td>
                                    <td><span data-detail="lifestages" data-index="0" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="0"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="0"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>1</td>
                                    <td>Child</td>
                                    <td><span data-detail="lifestages" data-index="1" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="1"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="1"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>Teen</td>
                                    <td><span data-detail="lifestages" data-index="2" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="2"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="2"
                                            data-source="species"></span></td>
                                    <td>Gender/Caste maturity.</td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>Young Adult</td>
                                    <td><span data-detail="lifestages" data-index="3" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="3"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="3"
                                            data-source="species"></span></td>
                                    <td>Career resolution begins.</td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>Adult</td>
                                    <td><span data-detail="lifestages" data-index="4" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="4"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="4"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>Peak</td>
                                    <td><span data-detail="lifestages" data-index="5" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="5"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="5"
                                            data-source="species"></span></td>
                                    <td>Physical aging begins.</td>
                                </tr>
                                <tr>
                                    <td>6</td>
                                    <td>Mid-Life</td>
                                    <td><span data-detail="lifestages" data-index="6" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="6"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="6"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td>Senior</td>
                                    <td><span data-detail="lifestages" data-index="7" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="7"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="7"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>Elder</td>
                                    <td><span data-detail="lifestages" data-index="8" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="8"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="8"
                                            data-source="species"></span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>9</td>
                                    <td>Retirement</td>
                                    <td><span data-detail="lifestages" data-index="9" data-source="species"></span> years
                                    </td>
                                    <td><span data-detail="lifestagelower" data-index="9"
                                            data-source="species"></span>-<span data-detail="lifestageupper" data-index="9"
                                            data-source="species"></span></td>
                                    <td>Mental aging begins.</td>
                                </tr>
                            </table>
                        </fieldset>
                        <p data-detail="gendersummary" class="summarytext" data-source="species"></p>
                            <p data-detail="castesummary" class="summarytext" data-source="species"></p>
                    </fieldset>
                        <fieldset>
                            <legend>Genetics and Abilities</legend>
                            <div><strong>Genetic Profile:</strong> <span data-detail="geneticprofile"
                                    data-source="species"></span> <strong>DNA:</strong> <span data-detail="dna"
                                    data-source="species"></span> <strong>Genders:</strong> <span data-detail="genderstructure" data-source="species"></span>,
                                <span data-detail="genderassignment"
                                    data-source="species"></span> (<span data-detail="gendershift"
                                    data-source="species"></span>)</div>
                                <div><strong>Caste:</strong> <span data-detail="castestructure" data-source="species">No</span>
                                    caste structure, <span data-detail="casteassignment"
                                        data-source="species"></span> (<span data-detail="casteshift"
                                        data-source="species"></span>) <strong>Caste-Gender Relation:</strong> <span data-detail="castegenderrelation"
                                        data-source="species"></span></div>
                            <table class="table">
                                <tr>
                                    <th colspan="2"></th>
                                    <th colspan="7">Genders</th>
                                    <th colspan="11" data-hideifzero="castes" data-source="species">Castes</th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th>Baseline</th>
                                    <th data-detail="genderdesc" data-index="0" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="1" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="2" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="3" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="4" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="5" data-source="species"></th>
                                    <th data-detail="genderdesc" data-index="6" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="0" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="1" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="2" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="3" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="4" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="5" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="6" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="7" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="8" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="9" data-source="species"></th>
                                    <th data-detail="castedesc" data-index="10" data-source="species"></th>
                                </tr>
                                <tr>
                                    <td><span data-detail="c1" data-source="species"></span></td>
                                    <td><span data-detail="c1val" data-source="species"></span></td>
                                    <td data-detail="genderc1s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc1s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec1s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="c2" data-source="species"></span></td>
                                    <td><span data-detail="c2val" data-source="species"></span></td>
                                    <td data-detail="genderc2s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc2s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec2s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="c3" data-source="species"></span></td>
                                    <td><span data-detail="c3val" data-source="species"></span></td>
                                    <td data-detail="genderc3s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc3s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec3s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="c4" data-source="species"></span></td>
                                    <td><span data-detail="c4val" data-source="species"></span></td>
                                    <td data-detail="genderc4s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc4s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec4s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="c5" data-source="species"></span></td>
                                    <td><span data-detail="c5val" data-source="species"></span></td>
                                    <td data-detail="genderc5s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc5s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec5s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="c6" data-source="species"></span></td>
                                    <td><span data-detail="c6val" data-source="species"></span></td>
                                    <td data-detail="genderc6s" data-index="0" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="1" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="2" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="3" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="4" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="5" data-source="species"></td>
                                    <td data-detail="genderc6s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="0" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="1" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="2" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="3" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="4" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="5" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="6" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="7" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="8" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="9" data-source="species"></td>
                                    <td data-detail="castec6s" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td>Odor</td>
                                    <td><span data-detail="scent" data-source="species"></span></td>
                                    <td data-detail="genderscents" data-index="0" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="1" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="2" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="3" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="4" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="5" data-source="species"></td>
                                    <td data-detail="genderscents" data-index="6" data-source="species"></td>
                                    <td data-detail="castescents" data-index="0" data-source="species"></td>
                                    <td data-detail="castescents" data-index="1" data-source="species"></td>
                                    <td data-detail="castescents" data-index="2" data-source="species"></td>
                                    <td data-detail="castescents" data-index="3" data-source="species"></td>
                                    <td data-detail="castescents" data-index="4" data-source="species"></td>
                                    <td data-detail="castescents" data-index="5" data-source="species"></td>
                                    <td data-detail="castescents" data-index="6" data-source="species"></td>
                                    <td data-detail="castescents" data-index="7" data-source="species"></td>
                                    <td data-detail="castescents" data-index="8" data-source="species"></td>
                                    <td data-detail="castescents" data-index="9" data-source="species"></td>
                                    <td data-detail="castescents" data-index="10" data-source="species"></td>
                                </tr>
                                <tr>
                                    <td colspan="2">Special Abilities</td>
                                    <td data-detail="genderabilities" data-index="0" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="1" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="2" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="3" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="4" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="5" data-source="species"></td>
                                    <td data-detail="genderabilities" data-index="6" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="0" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="1" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="2" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="3" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="4" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="5" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="6" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="7" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="8" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="9" data-source="species"></td>
                                    <td data-detail="casteabilities" data-index="10" data-source="species"></td>
                                </tr>
                            </table>
                            <table class="table">
                                <tr>
                                    <th>Gender</th>
                                    <th>2D</th>
                                    <th>Caste</th>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender2" data-source="species"></span></td>
                                    <td>2</td>
                                    <td><span data-detail="caste2" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender3" data-source="species"></span></td>
                                    <td>3</td>
                                    <td><span data-detail="caste3" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender4" data-source="species"></span></td>
                                    <td>4</td>
                                    <td><span data-detail="caste4" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender5" data-source="species"></span></td>
                                    <td>5</td>
                                    <td><span data-detail="caste5" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender6" data-source="species"></span></td>
                                    <td>6</td>
                                    <td><span data-detail="caste6" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender7" data-source="species"></span></td>
                                    <td>7</td>
                                    <td><span data-detail="caste7" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender8" data-source="species"></span></td>
                                    <td>8</td>
                                    <td><span data-detail="caste8" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender9" data-source="species"></span></td>
                                    <td>9</td>
                                    <td><span data-detail="caste9" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender10" data-source="species"></span></td>
                                    <td>10</td>
                                    <td><span data-detail="caste10" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender11" data-source="species"></span></td>
                                    <td>11</td>
                                    <td><span data-detail="caste11" data-source="species"></span></td>
                                </tr>
                                <tr>
                                    <td><span data-detail="gender12" data-source="species"></span></td>
                                    <td>12</td>
                                    <td><span data-detail="caste12" data-source="species"></span></td>
                                </tr>
                            </table>
                            <fieldset class="roller">
                                <legend>Roll for Special</legend>
                                <input type="button" value="Roll for Special Ability" id="btnGetSpecialAbility" />
                                <br /><span id="specialAbility"></span>
                                <div>
                                    <input type="button" value="Roll for Skilled Caste" id="btnGetCasteSkill" />
                                    <br /><span id="casteSkill"></span>
                                </div>
                            </fieldset>
                            <ul class="statnotes"></ul>
                            <div><strong>Other Features: </strong><span class="traitlist" data-detail="uniqueTraitDesc"
                                data-html="true" data-source="species"></span></div>
                        </fieldset>
                    </div>
                </fieldset>
                <fieldset class="collapsed" data-copy="donot">
                    <legend>Local Trade</legend>
                    <div id="TradePartners"></div>
                    <div class="CargoContainer">
                        <input type="button" value="Generate Cargo" id="btnGenerateCargo"><br/>
                        <h2 id="CargoCode">(Generate local cargo)</h2>
                        <div id="CargoDescription"></div>
                    </div>
                    <div class="CargoContainer">
                        <input id="btnCalculatePrice" type="button" value="Estimate Price at Destination" /><br/>
                        Tech Level: <input type="number" style="width:3em" id="destTL" name="destTL" value="12" /> &nbsp; 
                        Trade Codes: <input type="text" id="txtDestTradeCodes" name="txtDestTradeCodes" /> <br/>
                        
                        <h2 id="CargoPrice">Estimated Price at Destination</h2>
                    </div>
                    
                </fieldset>
            </div>
        </div>
    </div>
    <div data-nav="analysis">
        <fieldset>
            <legend>Native Intelligent Life</legend>
            <div id="nilOutput">

            </div>
        </fieldset>
        <fieldset>
            <legend>Technology Standards</legend>
            <div>

                <b>Average Community Tech Level:</b> <span data-sector="averagecommunitytech"></span> (<span style="font:small">Average TL of Important worlds</span>)<br>
                <b>Maximum Community Tech Level:</b> <span data-sector="maximumcommunitytech"></span> (<span style="font:small">Highest TL of Important Industrial worlds</span>)<br>
                <b>Average Inclusive Tech Level:</b> <span data-sector="averagetech"></span> (<span style="font:small">Average of all worlds</span>)<br>
                <b>Maximum Inclusive Tech Level:</b> <span data-sector="maximumtech"></span> (<span style="font:small">Highest TL of all worlds</span>)<br>        
            </div>
        </fieldset>
    </div>
    <div data-nav="tools">
        <fieldset>
            <legend>Random System</legend>
            <input type="button" id="btnPickRandomSystem" value="Pick Random System">
            <div id="randSystemDetails">
            </div>
        </fieldset>
        <fieldset>
            <legend>Ship Traffic</legend>
            <input type="button" id="btnGenerateTraffic" value="Roll up ship names">
            <input type="button" id="btnExpandCollapseTraffic" value="Expand All Systems" style="display:none;" data-action="expand">
            <div id="shipList">

            </div>
        </fieldset>
    </div>
    <script src="js/NameGenerator.js"></script>
    <script>
        
        (function () {
            //globalsRESH
            var wordMaker;
            var HEX_SIZE = 27,
                HEX_BORDER_COLOR = "white",
                HEX_BACKGROUND_COLOR = "rgba(0,0,0,0.7)",
                HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)",
                CANVAS_BACKGROUND_COLOR = "rgb(50,50,50)",
                CAPITAL_TEXT_COLOR = "rgb(255,100,100)",
                SECTORCAPITAL_TEXT_COLOR = "rgb(255,20,20)",
                CAPITAL_BACKGROUND_COLOR = "black",
                TRADE_ROUTE_COLOR = document.getElementById("tradeRouteColor").value,
                TEXT_COLOR = "white",
                COORD_TEXT_COLOR = "transparent",
                CANVAS_PADDING = 20,
                SUBSECTOR_WIDTH = 8,
                SUBSECTOR_HEIGHT = 10,
                SUBSECTOR_X_OFFSET = 8,
                SUBSECTOR_Y_OFFSET = 0,
                FONT = "sans-serif",
                TRADE_ROUTE_THRESHOLD = Number(document.getElementById("numProfitThreshold").value),
                TRADE_ROUTE_PREMIUM = Number(document.getElementById("numParsecPremium").value),
                MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
            var MIN_JUMP1_ROUTE_STARPORT = document.getElementById("slctMinJump1Starport").value, 
                MIN_JUMP2_ROUTE_STARPORT = document.getElementById("slctMinJump2Starport").value,
                MIN_JUMP3_ROUTE_STARPORT = document.getElementById("slctMinJump3Starport").value,
                MIN_JUMP1_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump1Importance").value),
                MIN_JUMP2_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump2Importance").value),
                MIN_JUMP3_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump3Importance").value);
            var HEX_MATH = {
                radius: HEX_SIZE,
                xOffset: HEX_SIZE * 3,
                yOffset: Math.sqrt(3) * HEX_SIZE*2,
                halfYOffset: Math.sqrt(3) * HEX_SIZE,
                diameter: HEX_SIZE * 2
            }
            var cargo = {};
            // 0-7 UWP, 8 importance, 9 total pop, 10 RU
            var mins = [-1, -1, -1, -1, -1, -1, -1, -1, -3, -1, -1],
                maxes = [0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                labels = ["starport", "size", "atmo", "hydro", "pop", "gov", "law", "tech"];
            var _systems = {}, systemArray = [];
            var routes = [], NIL = [];
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; // used for dragging system details dialog around
            var menus = document.querySelectorAll("nav.menu ul li a");
            for(var i = 0, len = menus.length; i < len; i++){
                var node = menus[i];
                node.addEventListener("click",onNavigate);
            }
            function onNavigate(e){
                var target = e.target.getAttribute("target");
                if(target){
                    var current = document.querySelector("nav.menu ul li a.selected");
                    current.classList.remove(current.className);
                    e.target.classList.add("selected");
                    document.querySelector("[data-nav='"+current.getAttribute("target")+"']").style.display = "none";
                    document.querySelector("[data-nav='"+target+"']").style.display = "block";
                    MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                }
            }
            var canvas = document.getElementById("canvas");
            canvas.setAttribute("width", SUBSECTOR_WIDTH * HEX_MATH.xOffset + HEX_MATH.radius + CANVAS_PADDING * 2);
            canvas.setAttribute("height", SUBSECTOR_HEIGHT * HEX_MATH.yOffset + HEX_MATH.halfYOffset + CANVAS_PADDING * 2);
            var ctx = canvas.getContext('2d');

            var mapContent = [];
            document.getElementById("sizeSlider").value = HEX_SIZE;
            mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT);
            updateStyle();
            var fontSize = HEX_SIZE * 1 / 3;
            ctx.font = "" + fontSize + "pt " + FONT;
            drawMap(mapContent);
            if (window.location.hash) {
                processHash();
            }
            //NameGenerator("js/names.jsonc", function (o) { wordMaker = o; populateSubsector(); }, null, MathRandom);
            NameGenerator(getNames(), function (o) { wordMaker = o; populateSubsector(); }, null, MathRandom,true);
            var lastHighlightedHex, lastSelectedHex;
            attachEventListeners();
            function processHash() {
                // first time process hash on page load
                var hash = window.location.hash;
                var seed = window.location.hash.substr(1);
                if (hash.indexOf("$") > 0) {
                    seed = "";
                    var hashParamPairs = hash.substr(1).split("&");
                    for (var i = 0, len = hashParamPairs.length; i < len; i++) {
                        var pair = hashParamPairs[i].split("=");
                        if (pair[0].toLowerCase() === "$seed") {
                            seed = pair[1];
                        }
                        if (pair[0].toLowerCase() === "$size") {
                            var newSize = pair[1];
                            if (typeof newSize !== "undefined" && newSize.length > 0) {
                                console.log("size = " + newSize);
                                if( document.getElementById("slctMapSize").value !== addCaps(newSize)){
                                    document.getElementById("slctMapSize").value = addCaps(newSize);
                                    mapSizeChanged();
                                }
                            }
                        }
                        if (pair[0].toLowerCase() === "$density") {
                            var newDensity = pair[1];
                            if (typeof newDensity !== "undefined" && newDensity.length > 0) {
                                console.log("density = " + newDensity);
                                document.getElementById("slctStellarDensity").value = addCaps(newDensity);
                            }
                        }
                    }
                }
                if (seed.length > 0) {
                    document.getElementById("txtSeed").value = decodeURI(seed);
                    document.getElementById("chkUseRandom").checked = false;
                    MathRandom = pseudoRandomNumberGenerator(decodeURI(seed));
                }
            }
            function roundCoords(clientX,clientY){
                var xZone = ((clientX + HEX_MATH.radius) / HEX_MATH.xOffset) >> 0;
                var yZone = ((clientY) / HEX_MATH.yOffset) >> 0;
                var obj = {x:xZone,y:yZone};
                return obj;
            }
            function attachEventListeners() {
                var abilityRoll = 0, skillRoll = 0;
                document.querySelector("[data-system=\"tcoord\"]").addEventListener("mousedown",startDraggingDialog);
                document.getElementById("btnGetSpecialAbility").addEventListener("click", function () {
                    var output = document.getElementById("specialAbility");
                    removeChildElements(output);
                    output.innerHTML = "Roll " + ++abilityRoll + ": " + getRandomSpecialAbility();
                });
                document.getElementById("chkLightTheme").addEventListener("click",function(){
                    if(document.getElementById("chkLightTheme").checked){
                        document.body.classList.add("light");
                    }else{
                        document.body.classList.remove("light");
                    }
                });
                document.getElementById("btnGetCasteSkill").addEventListener("click", function () {
                    var output = document.getElementById("casteSkill");
                    removeChildElements(output);
                    output.innerHTML = "Roll " + ++skillRoll + ": " + getCasteSkill();
                });
                document.getElementById("numParsecPremium").addEventListener("input",function(){
                    var newNum = Number(document.getElementById("numParsecPremium").value);
                    if( !isNaN(newNum)){
                        TRADE_ROUTE_PREMIUM = newNum;
                        var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                    }
                });
                document.getElementById("numProfitThreshold").addEventListener("input",function(){
                    var newNum = Number(document.getElementById("numProfitThreshold").value);
                    if( !isNaN(newNum)){
                        TRADE_ROUTE_THRESHOLD = newNum;
                        var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                    }
                });
                document.getElementById("tradeRouteColor").addEventListener("input",function(){
                    TRADE_ROUTE_COLOR = document.getElementById("tradeRouteColor").value;
                    if(document.getElementById("chkShowTradeRoutes").checked){
                        drawMap(mapContent);
                    }
                });
                document.getElementById("slctMinJump1Starport").addEventListener("change",function(){
                    MIN_JUMP1_ROUTE_STARPORT = document.getElementById("slctMinJump1Starport").value;
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("slctMinJump2Starport").addEventListener("change",function(){
                    MIN_JUMP2_ROUTE_STARPORT = document.getElementById("slctMinJump2Starport").value;
                        var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("slctMinJump1Importance").addEventListener("change",function(){
                    MIN_JUMP1_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump1Importance").value);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("slctMinJump2Importance").addEventListener("change",function(){
                    MIN_JUMP2_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump2Importance").value);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("slctMinJump3Starport").addEventListener("change",function(){
                    MIN_JUMP3_ROUTE_STARPORT = document.getElementById("slctMinJump3Starport").value;
                        var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("slctMinJump3Importance").addEventListener("change",function(){
                    MIN_JUMP3_ROUTE_IMPORTANCE = Number(document.getElementById("slctMinJump3Importance").value);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                        var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                        analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                        drawMap(mapContent);
                });
                document.getElementById("chkShowTradeRoutes").addEventListener("click",function(){
                    drawMap(mapContent);
                })
                canvas.addEventListener("mousemove", function (e) {
                    var hexIdentified = false;
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.halfYOffset - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    var redrawRequested = false;
                    if (lastHighlightedHex && lastHighlightedHex.highlighted) {
                        if (coordsInHexagon(x, y, lastHighlightedHex)) {
                            hexIdentified = true;
                            lastHighlightedHex.highlighted = true;
                            if(lastHighlightedHex.system){
                                mapContent[lastHighlightedHex.system.index].highlighted = true;
                                mapContent[lastHighlightedHex.system.index]
                            }
                            
                        } else {
                            lastHighlightedHex.highlighted = false;
                            redrawRequested = true;
                        }
                    }
                    if (!hexIdentified) {
                        var exampleCoords = roundCoords(x,y);
                        var testCoords = [
                        { x:exampleCoords.x, y:exampleCoords.y}, {x:exampleCoords.x-1, y:exampleCoords.y-1}, { x:exampleCoords.x, y:exampleCoords.y-1}, {x:exampleCoords.x+1, y:exampleCoords.y-1},
                            {x:exampleCoords.x-1, y:exampleCoords.y},  {x:exampleCoords.x+1, y:exampleCoords.y},
                            {x:exampleCoords.x-1, y:exampleCoords.y+1}, { x:exampleCoords.x, y:exampleCoords.y+1}, {x:exampleCoords.x+1, y:exampleCoords.y+1}
                        ];
                        for(var i = 0; i < testCoords.length; i++){
                            var testIndex = testCoords[i].x + (testCoords[i].y * SUBSECTOR_WIDTH);
                            if(testIndex >= 0 && testIndex < mapContent.length){
                                var hex = mapContent[testIndex];
                                if (coordsInHexagon(x, y, hex)) {
                                    hexIdentified = true;
                                    if (lastHighlightedHex) {
                                        lastHighlightedHex.highlighted = false;
                                    }
                                    lastHighlightedHex = hex;
                                    hex.highlighted = true;
                                    drawMap(mapContent);
                                    redrawRequested = false;
                                    break;
                                }
                            }
                        }
                        if(redrawRequested){
                            drawMap(mapContent);
                        }
                    }
                });
                canvas.addEventListener("click", function (e) {
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.halfYOffset - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    var hexFound = false;
                    document.getElementById("AddSystemContainer").style.display = "none";
                    for (var i = 0, len = mapContent.length; i < len; i++) {
                        var hex = mapContent[i];
                        if (coordsInHexagon(x, y, hex)) {
                            hexFound = true;
                            if (hex.selected) {
                                hex.selected = false;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                detailBlock.style.display = "none";
                                MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                            }
                            else {
                                if (lastSelectedHex) {
                                    lastSelectedHex.selected = false;
                                }
                                hex.selected = true;
                                lastSelectedHex = hex;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                if (hex.system) {
                                    renderSystem(hex.system);
                                    if(!MANUAL_SYSTEM_WINDOW_PLACEMENT){
                                        detailBlock.style.left = e.pageX + "px";// - canvas.getBoundingClientRect().left +"px";
                                        detailBlock.style.top = e.pageY + "px";//- canvas.getBoundingClientRect().top+"px";
                                        detailBlock.style.display = "inline-block";
                                        detailBlock.style.position = "absolute";
                                    }
                                    document.querySelector("[data-nav='map']").appendChild(detailBlock);
                                    document.getElementById("destTL").value = lastSelectedHex.system.mainworld.tech;
                                    document.getElementById("txtDestTradeCodes").value = lastSelectedHex.system.mainworld.tradecodes.join(" ");
                                    if(typeof cargo.tl !== "undefined"){
                                        var price = calculatePrice(cargo,lastSelectedHex.system.mainworld.tech,lastSelectedHex.system.mainworld.tradecodes);
                                        var profit = price - cargo.cost;
                                        document.getElementById("CargoPrice").innerHTML = "Cr " + price.toString() + " (" + (profit >= 0 ? "+":"") + (profit) +")";
                                    }
                                } else {
                                    detailBlock.style.display = "none";
                                    MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                                    var addSystemBlock = document.getElementById("AddSystemContainer");
                                    addSystemBlock.style.left = e.pageX + "px";// - canvas.getBoundingClientRect().left +"px";
                                    addSystemBlock.style.top = e.pageY + "px";//- canvas.getBoundingClientRect().top+"px";
                                    addSystemBlock.style.display = "inline-block";
                                    addSystemBlock.style.position = "absolute";
                                    addSystemBlock.querySelector("h1").innerText = XYCoordToTCoord(hex.x,hex.y);
                                }
                                break;
                            }
                        } else {
                            if (hex.selected) {
                                hex.selected = false;
                                
                            }
                        }
                    }
                    if(!hexFound){
                        MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("mouseout", function (e) {
                    for (var i = 0, len = mapContent.length; i < len; i++) {
                        var hex = mapContent[i];
                        if (hex.highlighted) {
                            hex.highlighted = false;
                        }
                    }
                    drawMap(mapContent);
                });
                var btnPickRandomSystem = document.getElementById("btnPickRandomSystem");
                btnPickRandomSystem.addEventListener("click",function(){
                    var numAttempts = 0, maxAttempts = 1280;
                    var i = Math.random()*mapContent.length >>> 0;
                    while(!(mapContent[i].system) && numAttempts < maxAttempts){
                        i = Math.random()*mapContent.length >>> 0;
                        numAttempts++;
                    }
                    if(mapContent[i].system){
                        renderSystem(mapContent[i].system);
                        MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                        var detailBlock = document.getElementById("SystemDetailsContainer");
                        var targetBlock = document.getElementById("randSystemDetails");
                        targetBlock.appendChild(detailBlock);
                        detailBlock.style.display = "inline-block";
                        detailBlock.style.position = "relative";
                        detailBlock.style.top = "0px";
                        detailBlock.style.left = "0px";
                    }
                });
                var btnGenerateTraffic = document.getElementById("btnGenerateTraffic");
                btnGenerateTraffic.addEventListener("click",generateShipTraffic);
                document.getElementById("btnExpandCollapseTraffic").addEventListener("click",expandCollapseTraffic);
                var collapserHandles = document.querySelectorAll("fieldset legend");
                for (var i = 0, len = collapserHandles.length; i < len; i++) {
                    var handle = collapserHandles[i];
                    handle.addEventListener("click", function (e) {
                        var parent = e.target.parentElement;
                        if (parent.classList.contains("collapsed")) {
                            parent.classList.remove("collapsed");
                        } else {
                            parent.classList.add("collapsed");
                        }
                    });
                }
                document.getElementById("dialog_close").addEventListener("click", function () {
                    document.getElementById("SystemDetailsContainer").style.display = "none";
                    if (lastSelectedHex) {
                        lastSelectedHex.selected = false;
                    }
                    removeChildElements(document.getElementById("specialAbility"));
                    removeChildElements(document.getElementById("casteSkill"));
                    MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                });
                document.getElementById("txtSeed").addEventListener("keyup", function (e) {
                    MathRandom = pseudoRandomNumberGenerator(this.value);
                    wordMaker.setRandom(MathRandom);
                    if (e.keyCode == 13) {
                        document.getElementById("chkUseRandom").checked = false;
                        populateSubsector();
                    }
                });
                document.getElementById("slctMapSize").addEventListener("input", mapSizeChanged);
                var randomizers = document.querySelectorAll("[data-randomize]");
                for(var i = 0, len = randomizers.length; i < len; i++){
                    randomizers[i].addEventListener("click",randomizerClicked);
                }
                document.getElementById("btnUpdateUWP").addEventListener("click",function(){
                    var txtUWP = document.getElementById("txtUWP");
                    txtUWP.style.display = "none";
                    updateSystemUWP(txtUWP.value.toUpperCase());
                    document.getElementById("btnCancelEditUWP").style.display = "none";
                    document.getElementById("btnUpdateUWP").style.display = "none";
                    document.getElementById("btnBuildFromUWP").style.display = "none";
                    document.getElementById("btnEditUWP").style.display = "inline-block";
                    document.querySelector("[data-system=\"uwp\"]").style.display = "inline";
                });
                document.getElementById("btnBuildFromUWP").addEventListener("click",function(){
                    var txtUWP = document.getElementById("txtUWP");
                    txtUWP.style.display = "none";                    
                    rerollSystemWithPredefinedUWP(txtUWP.value.toUpperCase());
                    document.getElementById("btnCancelEditUWP").style.display = "none";
                    document.getElementById("btnUpdateUWP").style.display = "none";
                    document.getElementById("btnBuildFromUWP").style.display = "none";
                    document.getElementById("btnEditUWP").style.display = "inline-block";
                    document.querySelector("[data-system=\"uwp\"]").style.display = "inline";
                });
                document.getElementById("btnEditUWP").addEventListener("click",function(){
                    var txtUWP = document.getElementById("txtUWP");
                    txtUWP.value = lastSelectedHex.system.uwp;
                    txtUWP.style.display = "inline-block";
                    document.getElementById("btnUpdateUWP").style.display = "inline-block";
                    document.getElementById("btnCancelEditUWP").style.display = "inline-block";
                    document.getElementById("btnBuildFromUWP").style.display = "inline-block";
                    document.getElementById("btnEditUWP").style.display = "none";
                    document.querySelector("[data-system=\"uwp\"]").style.display = "none";
                });
                document.getElementById("btnCancelEditUWP").addEventListener("click",function(){
                    document.getElementById("txtUWP").style.display = "none";
                    document.getElementById("btnUpdateUWP").style.display = "none";
                    document.getElementById("btnBuildFromUWP").style.display = "none";
                    document.getElementById("btnCancelEditUWP").style.display = "none";
                    document.getElementById("btnEditUWP").style.display = "inline-block";
                    document.querySelector("[data-system=\"uwp\"]").style.display = "inline";
                });
                document.getElementById("btnSaveSystemName").addEventListener("click",function(){
                    var txtSystemName = document.getElementById("txtSystemName");
                    txtSystemName.style.display = "none";
                    updateSystemName(txtSystemName.value);
                    document.getElementById("btnCancelSystemName").style.display = "none";
                    document.getElementById("btnSaveSystemName").style.display = "none";
                    document.getElementById("btnEditSystemName").style.display = "inline-block";
                    document.querySelector("[data-system=\"name\"]").style.display = "inline";
                });
                
                document.getElementById("btnEditSystemName").addEventListener("click",function(){
                    document.querySelector("[data-system=\"name\"]").style.display = "none";
                    document.getElementById("btnEditSystemName").style.display = "none";
                    var txtSystemName = document.getElementById("txtSystemName");
                    txtSystemName.value = lastSelectedHex.system.name;
                    txtSystemName.style.display = "inline-block";

                    var btnSaveSystemName = document.getElementById("btnSaveSystemName");
                    btnSaveSystemName.style.display = "inline-block";

                    var btnCancelSystemName =  document.getElementById("btnCancelSystemName");
                    btnCancelSystemName.style.display = "inline-block";                   
                });
                document.getElementById("btnCancelSystemName").addEventListener("click",function(){
                    document.getElementById("txtSystemName").style.display = "none";
                    document.getElementById("btnSaveSystemName").style.display = "none";
                    document.getElementById("btnCancelSystemName").style.display = "none";
                    document.getElementById("btnEditSystemName").style.display = "inline-block";
                    document.querySelector("[data-system=\"name\"]").style.display = "inline";
                });
                document.getElementById("fontFamily").addEventListener("keyup", updateStyle);
                document.getElementById("hexBorderColor").addEventListener("keyup", function () {
                    var newColor = document.getElementById("hexBorderColor").value;
                    updateHexBorderColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexfg", newColor);
                    drawMap(mapContent);
                });
                document.getElementById("textColor").addEventListener("keyup", function () {
                    var newColor = document.getElementById("textColor").value;
                    document.getElementById("slctStyle").setAttribute("data-text", newColor);
                    updateTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("coordTextColor").addEventListener("keyup", function () {
                    var newColor = document.getElementById("coordTextColor").value;
                    document.getElementById("slctStyle").setAttribute("data-ctext", newColor);
                    updateCoordTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("hexBackgroundColor").addEventListener("keyup", function () {
                    var newColor = document.getElementById("hexBackgroundColor").value;
                    updateHexBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexbg", newColor);
                    drawMap(mapContent);
                });
                document.getElementById("canvasBackgroundColor").addEventListener("keyup", function () {
                    var newColor = document.getElementById("canvasBackgroundColor").value;
                    updateCanvasBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-canvasbg", newColor);
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyData").addEventListener("click", function () {
                    mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, JSON.parse(document.getElementById("data").value));
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    var systems = [];
                    for (var i = 0, len = mapContent.length; i < len; i++) {
                        var hex = mapContent[i];
                        if (hex.system) {
                            systems.push(hex.system);
                            _systems[XYCoordToTCoord(hex.x,hex.y)] = hex.system;
                        }
                    }
                    systemArray = systems;
                    applyTravelCodes(mapContent);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                    var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                    analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                    drawMap(mapContent);
                    sortNatives();
                });
                document.getElementById("btnPopulateSystems").addEventListener("click", populateSubsector);
                document.getElementById("btnClearSystems").addEventListener("click", function () {
                    mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT);
                    MANUAL_SYSTEM_WINDOW_PLACEMENT = false;
                    drawMap(mapContent);
                });
                document.getElementById("slcHeatMap").addEventListener("change", function () {
                    drawMap(mapContent);
                });
                document.getElementById("chkShowTravelCodes").addEventListener("change", function () {
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyTravelCodes").addEventListener("click", function () {
                    applyTravelCodes(mapContent);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                    var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                    analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                    drawMap(mapContent);
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = true;
                });
                document.getElementById("btnClearTravelCodes").addEventListener("click", function () {
                    clearTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                });
                document.getElementById("btnResetTravelCodes").addEventListener("click", resetTravelCodes);
                document.getElementById("btnCETravelCodes").addEventListener("click", selectCETravelCodes);
                document.getElementById("btnT5TravelCodes").addEventListener("click", selectT5TravelCodes);
                var zonePickers = document.querySelectorAll("select[data-color]");
                for (var i = 0, len = zonePickers.length; i < len; i++) {
                    zonePickers[i].addEventListener("change", function (e) {
                        e.target.setAttribute("data-color", e.target.value);
                        document.getElementById("btnApplyTravelCodes").disabled = false;
                        document.getElementById("btnResetTravelCodes").disabled = false;
                    });
                }

                document.getElementById("slctAmberGovLawThreshold").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThreshold").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThresholdMax").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctRedGovLawThreshold").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctMaxLawLevelThreshold").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctLawLevelThreshold").addEventListener("change", function () {
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("btnExportCsv").addEventListener("click", function () {
                    var sectorData = document.getElementById("sectordata").value;
                    var a = document.createElement("a");
                    a.href = "data:text/tab-separated-values;charset=utf-8," + encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value + ".tsv";
                    a.click();
                });
                document.getElementById("btnExportExcel").addEventListener("click", function () {
                    var sectorData = document.getElementById("sectordata").value;
                    sectorData = sectorData.replace(/\t/g,"\"\t=\"");
                    sectorData = sectorData.replace(/\n/g,"\"\n=\"");
                    sectorData = "=\"" + sectorData + "\"";
                    var a = document.createElement("a");
                    a.href = "data:text/tab-separated-values;charset=utf-8," + encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value + ".tsv";
                    a.click();
                });
                
                document.getElementById("btnExportTxt").addEventListener("click", function () {
                    var sectorData = document.getElementById("sectordata").value;
                    var a = document.createElement("a");
                    a.href = "data:text/tab-separated-values;charset=utf-8," + encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value + ".txt";
                    a.click();
                });
                document.getElementById("btnExportJSON").addEventListener("click", function () {
                    var sectorData = document.getElementById("data").value;
                    var a = document.createElement("a");
                    a.href = "data:text/json;charset=utf-8," + encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value + ".json";
                    a.click();
                });
                document.getElementById("btnImportJSON").addEventListener("change", function () {
                    var curFiles = document.getElementById("btnImportJSON").files;
                    if (curFiles.length > 0) {
                        var reader = new FileReader();
                        reader.onload = function (event) {
                            document.getElementById("data").value = event.target.result;
                            document.getElementById("btnApplyData").click();
                            document.getElementById("txtSeed").value = curFiles[0].name.replace(".json", "");
                        }
                        reader.readAsText(curFiles[0]);

                    }
                });
                document.getElementById("btnSaveImg").addEventListener("click", function () {
                    var a = document.createElement("a");
                    a.href = canvas.toDataURL("image/png");
                    a.download = document.getElementById("txtSeed").value + ".png";
                    a.click();
                });
                document.getElementById("btnGenerateCargo").addEventListener("click",function(){
                    var TL = lastSelectedHex.system.mainworld.tech;
                    var tradeCodes = lastSelectedHex.system.mainworld.tradecodes;
                    cargo = getCargo(TL,tradeCodes);
                    document.getElementById("CargoCode").innerHTML = cargo.code;
                    document.getElementById("CargoDescription").innerHTML = cargo.description;
                });
                document.getElementById("btnCalculatePrice").addEventListener("click",function(){
                    if(typeof cargo.tl === "undefined"){
                        var TL = lastSelectedHex.system.mainworld.tech;
                        var tradeCodes = lastSelectedHex.system.mainworld.tradecodes;
                        cargo = getCargo(TL,tradeCodes);
                    }
                    
                    var destTl = Number( document.getElementById("destTL").value);
                    var destTradeCodes = document.getElementById("txtDestTradeCodes").value.split(" ");
                    var price = calculatePrice(cargo,destTl,destTradeCodes);
                    document.getElementById("CargoPrice").innerHTML = "Cr " + price.toString();
                });
                document.getElementById("btnTravellerMapPoster").addEventListener("click", function () {
                    var sectorData = document.getElementById("sectordata").value;
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "https://travellermap.com/api/poster", true);
                    xhr.responseType = "arraybuffer";
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                var bytes = new Uint8Array(xhr.response);
                                var len = bytes.byteLength, binary = '';
                                for (var i = 0; i < len; i++) {
                                    binary += String.fromCharCode(bytes[i]);
                                }
                                var blob = new Blob([xhr.response], { type: "image/png" });
                                var objectUrl = URL.createObjectURL(blob);
                                var img = document.createElement("a");
                                img.href = objectUrl;
                                img.download = "travmap_" + document.getElementById("txtSeed").value + ".png";
                                img.click();
                            }

                        }
                    };
                    var size = document.getElementById("slctMapSize").value;
                    var subsector = ""
                    if (size === "Subsector") {
                        subsector = "&subsector=A";
                    } else if (size === "Quadrant") {
                        subsector = "&quadrant=Alpha"
                    }
                    xhr.send("data=" + encodeURIComponent(sectorData) + subsector);
                });
                document.getElementById("btnAddNewSystem").addEventListener("click",function(){
                    if(lastSelectedHex.selected){
                        addSystemToHex(lastSelectedHex);
                        var detailBlock = document.getElementById("SystemDetailsContainer");
                        var addSystemBlock = document.getElementById("AddSystemContainer");
                        renderSystem(lastSelectedHex.system);
                        if(!MANUAL_SYSTEM_WINDOW_PLACEMENT){
                            detailBlock.style.left = addSystemBlock.style.left;// - canvas.getBoundingClientRect().left +"px";
                            detailBlock.style.top = addSystemBlock.style.top;//- canvas.getBoundingClientRect().top+"px";
                            detailBlock.style.display = "inline-block";
                            detailBlock.style.position = "absolute";
                        }
                        document.querySelector("[data-nav='map']").appendChild(detailBlock);
                        document.getElementById("destTL").value = lastSelectedHex.system.mainworld.tech;
                        document.getElementById("txtDestTradeCodes").value = lastSelectedHex.system.mainworld.tradecodes.join(" ");
                        if(typeof cargo.tl !== "undefined"){
                            var price = calculatePrice(cargo,lastSelectedHex.system.mainworld.tech,lastSelectedHex.system.mainworld.tradecodes);
                            var profit = price - cargo.cost;
                            document.getElementById("CargoPrice").innerHTML = "Cr " + price.toString() + " (" + (profit >= 0 ? "+":"") + (profit) +")";
                        }
                        addSystemBlock.style.display = "none";                        
                    }
                });
                document.getElementById("btnDeleteSystem").addEventListener("click",function(e){
                    if(lastSelectedHex.selected){
                        deleteSystem(lastSelectedHex);
                        var detailBlock = document.getElementById("SystemDetailsContainer");
                        var addSystemBlock = document.getElementById("AddSystemContainer");
                        detailBlock.style.display = "none";
                        //addSystemBlock.style.left = detailBlock.style.left;// - canvas.getBoundingClientRect().left +"px";
                        //addSystemBlock.style.top = detailBlock.style.top;//- canvas.getBoundingClientRect().top+"px";
                        //addSystemBlock.style.display = "inline-block";
                        //addSystemBlock.style.position = "absolute";
                    }
                });
                document.getElementById("btnCancelAddNewSystem").addEventListener("click",function(){
                    document.getElementById("AddSystemContainer").style.display = "none";
                });
                // event listener when window.location.hash changes
                window.addEventListener("hashchange", function () {
                    console.log("hash change");
                    var hash = window.location.hash;
                    if (hash.length > 0) {
                        var seed = hash.substring(1), newSize = "", newDensity = "";
                        if (hash.indexOf("$") >= 0) {
                            seed = "";
                            var hashParamPairs = hash.substr(1).split("&");
                            for (var i = 0, len = hashParamPairs.length; i < len; i++) {
                                var pair = hashParamPairs[i].split("=");
                                if (pair[0].toLowerCase() === "$seed") {
                                    seed = pair[1];
                                }
                                if (pair[0].toLowerCase() === "$size") {
                                    newSize = pair[1];
                                    if (typeof newSize !== "undefined" && newSize.length > 0) {
                                        newSize = addCaps(newSize);
                                        if( document.getElementById("slctMapSize").value !== addCaps(newSize)){
                                            document.getElementById("slctMapSize").value = addCaps(newSize);
                                            mapSizeChanged();
                                        }
                                    }
                                }
                                if (pair[0].toLowerCase() === "$density") {
                                    newDensity = pair[1];
                                    if (typeof newDensity !== "undefined" && newSize.length > 0) {
                                        newDensity = addCaps(newDensity);
                                        document.getElementById("slctStellarDensity").value = newDensity;
                                    }
                                }
                            }
                            var newValue = decodeURI(seed);
                            if (document.getElementById("txtSeed").value == newValue && document.getElementById("slctStellarDensity").value == newDensity && document.getElementById("slctMapSize").value == newSize) {

                            } else {
                                document.getElementById("txtSeed").value = newValue;
                                var wasChecked = document.getElementById("chkUseRandom").checked;
                                if (typeof seed === "undefined" || seed.length === 0) {
                                    document.getElementById("chkUseRandom").checked = true;
                                } else {
                                    document.getElementById("chkUseRandom").checked = false;
                                }
                                populateSubsector();
                                document.getElementById("chkUseRandom").checked = wasChecked;
                            }
                        }
                    }
                });
            }
            function startDraggingDialog(e){
                if(document.querySelector("[data-nav=\"map\"]").style.display !== "none"){
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = stopDraggingDialog;
                    document.onmousemove = dragDialog;
                    MANUAL_SYSTEM_WINDOW_PLACEMENT = true;
                }
                
            }
            function dragDialog(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                var dialog = document.getElementById("SystemDetailsContainer");
                dialog.style.top = (dialog.offsetTop - pos2) + "px";
                dialog.style.left = (dialog.offsetLeft - pos1) + "px";
            }

            function stopDraggingDialog() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
            function mapSizeChanged() {
                var choice = document.getElementById("slctMapSize").value;
                switch (choice) {
                    case "Subsector": SUBSECTOR_HEIGHT = 10; SUBSECTOR_WIDTH = 8; break;
                    case "Quadrant": SUBSECTOR_HEIGHT = 20; SUBSECTOR_WIDTH = 16; break;
                    case "Sector": SUBSECTOR_HEIGHT = 40; SUBSECTOR_WIDTH = 32; break;
                }
                //updateHexSize(+(document.getElementById("sizeSlider").value));
                canvas.setAttribute("width", SUBSECTOR_WIDTH * HEX_MATH.xOffset + HEX_MATH.radius + CANVAS_PADDING * 2);
                canvas.setAttribute("height", SUBSECTOR_HEIGHT * HEX_MATH.yOffset + HEX_MATH.halfYOffset + CANVAS_PADDING * 2);
                drawMap(mapContent);
            }
            document.getElementById("slctStyle").addEventListener("change", updateStyle);
            document.getElementById("sizeSlider").addEventListener("change", function () {
                updateHexSize(+(document.getElementById("sizeSlider").value));
                drawMap(mapContent);
            });
            function addSystemToHex(hex){
                var tcoord = XYCoordToTCoord(hex.x, hex.y);
                var name = tcoord;       
                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked,
                mainworldRules =  document.getElementById("slctMainworldRules").value;
                applyHillSphereLimits = document.getElementById("chkApplyHillSphereLimits").checked,
                allowInnerWhiteDwarfs = document.getElementById("chkAllowInnerWhiteDwarfs").checked,
                populateNonMainworlds = document.getElementById("chkPopulateNonMainworlds").checked;
                var details = 
                generateSystemDetails(tcoord, 
                    ggFrequency, 
                    permitDieback, 
                    maxTechLevel, 0, 
                    mainworldRules, 
                    populateNonMainworlds, 
                    applyHillSphereLimits, 
                    allowInnerWhiteDwarfs);
                for (var i = 0, len = mins.length; i < len; i++) {
                    var currValue;
                    if (i < 8) {
                        currValue = details.mainworld[labels[i]];
                        var currMin = mins[i], currMax = maxes[i];
                        if (currValue < currMin) { mins[i] = currValue; }
                        if (currValue > currMax) { maxes[i] = currValue; }
                    }
                    else if (i === 8) {
                        currValue = details.importance.extension;
                    } else if (i === 9) {
                        currValue = details.totalpop;
                        if (currValue > 0) { currValue = Math.round(Math.log10(currValue)); }
                        var currMin = mins[i], currMax = maxes[i];
                        if (currValue < currMin) { mins[i] = currValue; }
                        if (currValue > currMax) { maxes[i] = currValue; }
                    } else if (i === 10) {
                        currValue = details.economics.RU;
                        var currMin = mins[i], currMax = maxes[i];
                        if (currValue < currMin) { mins[i] = currValue; }
                        if (currValue > currMax) { maxes[i] = currValue; }
                    }
                }
                var system = {
                    name: addCaps(name),
                    mainworld: details.mainworld,
                    uwp: details.uwp.toUpperCase(),
                    gg: details.gg,
                    isAsteroidBelt: details.mainworld.isAsteroidBelt,
                    planetoidBelts: details.planetoidBelts,
                    bases: details.bases,
                    stars: details.stars,
                    economics: details.economics,
                    importance: details.importance,
                    totalpop: details.totalpop,
                    tcoord: tcoord,
                    pbg: details.pbg,
                    allegiance: details.allegiance,
                    isRed: false,
                    isAmber: false,
                    nobility: details.nobility,
                    sysArrayIndex:systemArray.length
                };
                var namesSoFar = {};
                for(var i = 0, len = systemArray.length; i < len; i++){
                    namesSoFar[systemArray[i].name] = true;
                }
                var name = wordMaker.getRandomName("system");
                while (Object.keys(namesSoFar).indexOf(name) >= 0) {
                    console.log(name + " was already taken...")
                    name = wordMaker.getRandomName("system");
                }
                name = addCaps(name);
                system.name = name;
                hex.system = system;
                _systems[tcoord] = system;
                systemArray.push(system);
                namesSoFar[name] = { hexlocation: tcoord, x: hex.x, y: hex.y };
                
                mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, _systems);
                applyTravelCodes(mapContent);
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                document.getElementById("data").value = JSON.stringify(_systems);
                document.getElementById("sectordata").value = getSectorData(mapContent);
                if (document.getElementById("chkGenerateNatives").checked) {
                    var likelihood = document.getElementById("slctNativeLikelihood").value;
                    max = 0;
                    switch (likelihood) {
                        case "rare": // ~1 per sector
                            max = 45;
                            break;
                        case "reasonable": // ~1 per subsector
                            max = 9;
                            break;
                        case "common": // 1 in 2 chance per candidate world
                            max = 2;
                            break;
                        case "everywhere": // every non-exotic candidate world
                            max = 1;
                            break;
                        case "really": // every candidate world
                            max = 1;
                            break;
                    }
                    rollNativeForWorld(system, likelihood, max);
                    sortNatives()
                }else{
                    renderNILSummary([]);
                }
                drawMap(mapContent);
            }
            function deleteSystem(hex){
                if(hex.system){
                    var tcoord = XYCoordToTCoord(hex.x, hex.y);
                    var index = -1;
                    for(var i = 0, len = systemArray.length; i < len; i++){
                        if(systemArray[i].tcoord === tcoord){
                            index = i;
                            break;
                        }
                    }
                    systemArray.splice(i,1);
                    delete _systems[tcoord];
                    generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, _systems);
                    if(hex.system.natives){
                        sortNatives();
                    }
                    applyTravelCodes(mapContent);
                    var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                    var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                    analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                    document.getElementById("data").value = JSON.stringify(_systems);
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    hex.selected = false;
                    drawMap(mapContent);
                }
            }
            function populateSubsector() {
                document.getElementById("SystemDetailsContainer").style.display = "none";
                document.getElementById("AddSystemContainer").style.display = "none";
                var useRandomSeed = document.getElementById("chkUseRandom").checked;
                var seed;
                if (useRandomSeed) {
                    seed1 = Math.floor(Math.random() * 1000000);
                    seed = addCaps(wordMaker.getRandomName("system") + seed1);
                    document.getElementById("txtSeed").value = seed;

                } else {
                    seed = document.getElementById("txtSeed").value
                }

                var $density = document.getElementById("slctStellarDensity").value
                var sizeSelector = document.getElementById("slctMapSize");
                var $size = sizeSelector.value
                var sizeOption = sizeSelector.querySelectorAll("option")[sizeSelector.selectedIndex];
                SUBSECTOR_X_OFFSET = +(sizeOption.getAttribute("data-subsectorxoffset"));
                SUBSECTOR_Y_OFFSET = +(sizeOption.getAttribute("data-subsectoryoffset"));
                window.location.hash = "$seed=" + encodeURI(seed) + "&$density=" + $density + "&$size=" + $size;

                MathRandom = pseudoRandomNumberGenerator(seed.toString());
                wordMaker.setRandom(MathRandom);

                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                var d = 1, target = 3, systems = {};
                switch (density) {
                    case "Extra Galactic": d = 3, target = 3; break;
                    case "Rift": d = 2, target = 2; break;
                    case "Sparse": d = 1, target = 1; break;
                    case "Scattered": d = 1, target = 2; break;
                    case "Standard": d = 1, target = 3; break;
                    case "Dense": d = 1, target = 4; break;
                    case "Cluster": d = 1, target = 5; break;
                    case "Core": d = 2, target = 11; break;
                    case "Clump": d = 1, target = 2; break;
                }
                var namesSoFar = {};
                //  0-7 = UWP, 8 = Importance, 9 = Total Pop, 10 = RUs
                mins = [-1, -1, -1, -1, -1, -1, -1, -1, -3, -1, -1], maxes = [0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0];
                systemArray = [];
                var permitDieback = document.getElementById("chkPermitDieback").checked,
                mainworldRules =  document.getElementById("slctMainworldRules").value,
                applyHillSphereLimits = document.getElementById("chkApplyHillSphereLimits").checked,
                allowInnerWhiteDwarfs = document.getElementById("chkAllowInnerWhiteDwarfs").checked,
                populateNonMainworlds = document.getElementById("chkPopulateNonMainworlds").checked;
                for (var x = 0; x < SUBSECTOR_WIDTH; x++) {
                    for (var y = 0; y < SUBSECTOR_HEIGHT; y++) {
                        if (density === "Clump") {
                            if (x >= SUBSECTOR_WIDTH / 3 && x <= SUBSECTOR_WIDTH * 2 / 3 && y >= SUBSECTOR_HEIGHT / 3 && y <= SUBSECTOR_HEIGHT * 2 / 3) {
                                target = 4;
                            } else if (x >= SUBSECTOR_WIDTH / 4 && x <= SUBSECTOR_WIDTH * 3 / 4 && y >= SUBSECTOR_HEIGHT / 4 && y <= SUBSECTOR_HEIGHT * 3 / 4) {
                                target = 3;
                            } else if (x >= SUBSECTOR_WIDTH / 8 && x <= SUBSECTOR_WIDTH * 7 / 8 && y >= SUBSECTOR_HEIGHT / 8 && y <= SUBSECTOR_HEIGHT * 7 / 8) {
                                target = 2;
                            } else {
                                target = 1;
                            }
                        }
                        if (d6(d) <= target) {

                            var tcoord = XYCoordToTCoord(x, y);
                            var name = tcoord;
                            
                            var details = 
                            generateSystemDetails(tcoord, 
                                ggFrequency, 
                                permitDieback, 
                                maxTechLevel, 0, 
                                mainworldRules, 
                                populateNonMainworlds, 
                                applyHillSphereLimits, 
                                allowInnerWhiteDwarfs);
                            for (var i = 0, len = mins.length; i < len; i++) {
                                var currValue;
                                if (i < 8) {
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }
                                else if (i === 8) {
                                    currValue = details.importance.extension;
                                } else if (i === 9) {
                                    currValue = details.totalpop;
                                    if (currValue > 0) { currValue = Math.round(Math.log10(currValue)); }
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                } else if (i === 10) {
                                    currValue = details.economics.RU;
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }
                            }
                            var system = {
                                name: addCaps(name),
                                mainworld: details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg: details.gg,
                                isAsteroidBelt: details.mainworld.isAsteroidBelt,
                                planetoidBelts: details.planetoidBelts,
                                bases: details.bases,
                                stars: details.stars,
                                economics: details.economics,
                                importance: details.importance,
                                totalpop: details.totalpop,
                                tcoord: tcoord,
                                pbg: details.pbg,
                                allegiance: details.allegiance,
                                isRed: false,
                                isAmber: false,
                                nobility: details.nobility,
                                sysArrayIndex:systemArray.length
                            };
                            systems[tcoord] = system;
                            systemArray.push(system);
                        }
                    }
                }
                for (var i = 0, len = systemArray.length; i < len; i++) {
                    var name = wordMaker.getRandomName("system");
                    while (Object.keys(namesSoFar).indexOf(name) >= 0) {
                        console.log(name + " was already taken...")
                        name = wordMaker.getRandomName("system");
                    }
                    name = addCaps(name);
                    var system = systemArray[i];
                    system.name = name;
                    systems[system.tcoord].name = name;
                    namesSoFar[name] = { hexlocation: tcoord, x: x, y: y };
                }
                mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, systems);
                applyTravelCodes(mapContent);
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                document.getElementById("data").value = JSON.stringify(systems);
                document.getElementById("sectordata").value = getSectorData(mapContent);
                if (document.getElementById("chkGenerateNatives").checked) {
                    generateNatives(mapContent, document.getElementById("slctNativeLikelihood").value);
                }else{
                    renderNILSummary([]);
                }
                drawMap(mapContent);
            }
            function rollNativeForWorld(system, likelihood, max){
                var native = false;
                if (system.mainworld.atmo >= 2 && system.mainworld.pop >= 7) {
                    var isExotic = likelihood !== "really" && system.mainworld.atmo >= 10 && system.mainworld.atmo <= 12;
                    var exoticMod = isExotic ? system.mainworld.atmo - 9 : 0;
                    var check = ((MathRandom() * (max + exoticMod)) >>> 0) + 1;
                    if (check === 1) {
                        var species = { name: addCaps(wordMaker.getRandomName("word")) };
                        species.homeworld = system;
                        generateRandomAlien(species, MathRandom);
                        delete species.homeworld;
                        system.natives = species;
                        native = {system: system,sophont:species};  
                    }
                }
                return native;
            }
            function sortNatives(){
                NIL = [];
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    if (mapContent[i].system) {
                        if(mapContent[i].system.natives){
                            NIL.push({system:mapContent[i].system,sophont:mapContent[i].system.natives})
                        }
                    }
                }
                NIL.sort(function(a,b){
                    if(a.system.importance.extension > b.system.importance.extension){
                        return -1;
                    }else if(b.system.importance.extension > a.system.importance.extension){
                        return 1;
                    }else if(a.system.mainworld.tech > b.system.mainworld.tech){
                        return -1;
                    }else if(b.system.mainworld.tech > a.system.mainworld.tech){
                        return 1;
                    }else if(a.sophont.name < b.sophont.name){
                        return -1;
                    }else{
                        return 1;
                    }
                });
                renderNILSummary(NIL);
            }
            function generateNatives(mapContent, likelihood) {
                var max = 0;
                switch (likelihood) {
                    case "rare": // ~1 per sector
                        max = 45;
                        break;
                    case "reasonable": // ~1 per subsector
                        max = 9;
                        break;
                    case "common": // 1 in 2 chance per candidate world
                        max = 2;
                        break;
                    case "everywhere": // every non-exotic candidate world
                        max = 1;
                        break;
                    case "really": // every candidate world
                        max = 1;
                        break;
                }
                NIL = [];

                var lifecount = 0;
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    if (mapContent[i].system) {
                        var native = rollNativeForWorld(mapContent[i].system,likelihood,max);
                        if(native){
                            lifecount++;
                            NIL.push(native);
                        }
                    }
                }
                NIL.sort(function(a,b){
                    if(a.system.importance.extension > b.system.importance.extension){
                        return -1;
                    }else if(b.system.importance.extension > a.system.importance.extension){
                        return 1;
                    }else if(a.system.mainworld.tech > b.system.mainworld.tech){
                        return -1;
                    }else if(b.system.mainworld.tech > a.system.mainworld.tech){
                        return 1;
                    }else if(a.sophont.name < b.sophont.name){
                        return -1;
                    }else{
                        return 1;
                    }
                });
                renderNILSummary(NIL);
                console.log(lifecount + " natives generated.");
            }
            function getSectorData(map) {
                var sectordata = "Hex\tName\tUWP\tBases\tRemarks\tZone\tPBG\tAllegiance\tStars\t{Ix}\t(Ex)\t[Cx]\tN";
                for (var i = 0, len = map.length; i < len; i++) {
                    if (typeof map[i].system !== "undefined") {
                        var system = map[i].system;
                        sectordata += "\n"
                            + ""+system.tcoord + "\t"
                            + ""+system.name + "\t"
                            + ""+system.uwp + "\t"
                            + ""+getBasesAbbrev(system.bases) + "\t"
                            + ""+system.mainworld.tradecodes.join(" ") + "\t"
                            + ""+(system.isRed ? "R" : (system.isAmber ? "A" : "")) + "\t"
                            + ""+system.pbg + "\t"
                            + ""+system.allegiance + "\t"
                            + ""+getStarsAbbrev(system.stars) + "\t"
                            + ""+"{" + (system.importance.extension > 0 ? "+" : "") + system.importance.extension + "}\t"
                            + ""+"(" + system.economics.extension + ")\t"
                            + ""+"[" + system.mainworld.cultural.extension + "]\t"
                            + ""+system.nobility.join("")+"";
                    }
                }
                return sectordata;
            }
            function renderNILSummary(NIL){
                var columns = [
                    ["Hex","system","tcoord"],
                    ["World","system","name"],
                    ["{Ix}","system","importance","extension"],
                    ["TL","system","mainworld","tech"],
                    ["Species","sophont","name"],
                    ["Genes","sophont","dna"],
                    ["UPP","sophont","geneticprofile"],
                    ["Atmo","sophont","breathes"],
                    ["Locomotion","sophont","locomotion"],
                    ["Height","sophont","height"],
                    ["Kg","sophont","size"],
                    ["Manipulators","sophont","allmanipulators"],
                    ["Language","sophont","language"],
                    ["Symmetry","sophont","symmetry"],
                    ["BodyPlan/Structure","sophont","bodystructure"],
                    ["Niche","sophont","niche"],
                    ["Class","sophont","class"],
                ];
                var applyRegexTo = ["Atmo","Language"];
                var nilOutput = document.getElementById("nilOutput");
                clearElement(nilOutput);
                nilOutput.parentElement.querySelector("legend").innerHTML = "Native Intelligent Life ("+NIL.length+")";
                var table = nilOutput.appendChild(document.createElement("table"));
                var header = table.appendChild(document.createElement("tr"));
                var regex = /(Language)?( \(.+\))/g;
                for(var i = 0, len = columns.length; i < len; i++){
                    header.appendChild(document.createElement("th")).appendChild(document.createTextNode(columns[i][0]));
                }
                for(var i = 0, len = NIL.length; i < len; i++){
                    var row = table.appendChild(document.createElement("tr"));
                    for(var j = 0, jlen = columns.length; j < jlen; j++){
                        var cell = row.appendChild(document.createElement("td"));
                        var obj = NIL[i];
                        for(var k = 1, klen = columns[j].length; k < klen; k++){
                            obj = obj[columns[j][k]];
                        }
                        if(applyRegexTo.indexOf(columns[j][0]) >= 0){
                            obj = obj.toString().replace(regex,"");
                        }
                        cell.appendChild(document.createTextNode(obj));
                        
                    }

                }
                console.log(NIL);
            }
            function getStarsAbbrev(stars) {
                var abbrev = getStarAbbrev(stars.primary);
                if (stars.primary_companion) {
                    abbrev += " " + getStarAbbrev(stars.primary_companion);
                }
                if (stars.close) {
                    abbrev += " " + getStarAbbrev(stars.close);
                    if (stars.close_companion) {
                        abbrev += " " + getStarAbbrev(stars.close_companion);
                    }
                }
                if (stars.near) {
                    abbrev += " " + getStarAbbrev(stars.near);
                    if (stars.near_companion) {
                        abbrev += " " + getStarAbbrev(stars.near_companion);
                    }
                }
                if (stars.far) {
                    abbrev += " " + getStarAbbrev(stars.far);
                    if (stars.far_companion) {
                        abbrev += " " + getStarAbbrev(stars.far_companion);
                    }
                }
                return abbrev;
            }
            function getStarAbbrev(star) {
                var abbrev = "";
                if (star.size === "D") {
                    abbrev =  "D";
                } else if (star.type === "BD") {
                    abbrev = "BD";
                } else {
                    abbrev = star.type.toString() + star.decimal.toString() + " " + star.size;
                }
                return abbrev;
            }
            function getBasesAbbrev(bases) {
                var text = "";
                for (var i = 0, len = bases.length; i < len; i++) {
                    switch (bases[i]) {
                        case "Naval": text += "N"; break;
                        case "Naval Depot": text += "D"; break;
                        case "Scout": text += "S"; break;
                        case "Way Station": text += "W"; break;
                    }
                }
                return text;
            }
            function analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital) {
                var capital, maxImportance = -4, tradeCodeCount = 0;
                routes = [];
                var subsectorMaxImportance =
                    [
                        -4, -4, -4, -4,
                        -4, -4, -4, -4,
                        -4, -4, -4, -4,
                        -4, -4, -4, -4
                    ];
                var subsectorCapitals =
                    [
                        null, null, null, null,
                        null, null, null, null,
                        null, null, null, null,
                        null, null, null, null
                    ];
                var uwpSums = [0, 0, 0, 0, 0, 0, 0],
                    uwpMins = [null, null, null, null, null, null, null],
                    uwpMaxes = [null, null, null, null, null, null, null];
                var ixSum = 0, ixMin = 5, ixMax = -3;
                var labels = ["size", "atmo", "hydro", "pop", "gov", "law", "tech"];
                var tracker = { "size": {}, "atmo": {}, "hydro": {}, "pop": {}, "gov": {}, "law": {}, "tech": {} };
                var maximumtech = 0;
                var maximumcommunitytech = 0;
                var averagetech = 0, sumTech = 0;
                var averagecommunitytech = 0;
                var numImportantWorlds = 0, sumImportantTech = 0;
                for (var i = 0, len = systemArray.length; i < len; i++) {
                    
                    var system = systemArray[i];
                    var mainworld = system.mainworld;
                    var subsectorCapitalCodeIndex = mainworld.tradecodes.indexOf("Cp");
                    if (subsectorCapitalCodeIndex >= 0) {
                        system.mainworld.tradecodes.splice(subsectorCapitalCodeIndex, 1);
                        system.isCapital = false;
                    }
                    for (var j = 0, jlen = labels.length; j < jlen; j++) {
                        var label = labels[j];
                        var value = mainworld[label];
                        uwpSums[j] += value;
                        if (tracker[label][value]) {
                            tracker[label][value] += 1;
                        } else {
                            tracker[label][value] = 1;
                        }
                        if (uwpMins[j] === null || value < uwpMins[j]) { uwpMins[j] = value; }
                        if (uwpMaxes[j] === null || value > uwpMaxes[j]) { uwpMaxes[j] = value; }
                    }
                    
                    if (system.importance.isImportant) {
                        sumImportantTech += mainworld.tech;
                        numImportantWorlds += 1;
                        if(mainworld.tradecodes.indexOf("In") >= 0){
                            if(mainworld.tech > maximumcommunitytech){
                                maximumcommunitytech = mainworld.tech;
                            }
                        }
                        var importance = system.importance.extension;
                        if (system.isRed) { importance -= 3; }
                        if (system.isAmber) { importance -= 1; }
                        if (mainworld.starport === "A") { importance += 1; }
                        var xy = TCoordToXYCoord(system.tcoord);

                        if (designateSubsectorCapitals) {
                            // to do
                            var subsectorIndex = -1;
                            if (xy.y <= 9) {
                                if (xy.x <= 7) {
                                    subsectorIndex = 0;
                                } else if (xy.x > 7 && xy.x <= 15) {
                                    subsectorIndex = 1;
                                } else if (xy.x > 15 <= 23) {
                                    subsectorIndex = 2;
                                } else if (xy.x > 23 <= 31) {
                                    subsectorIndex = 3;
                                }
                            } else if (xy.y > 9 && xy.y <= 19) {
                                if (xy.x <= 7) {
                                    subsectorIndex = 4;
                                } else if (xy.x > 7 && xy.x <= 15) {
                                    subsectorIndex = 5;
                                } else if (xy.x > 15 <= 23) {
                                    subsectorIndex = 6;
                                } else if (xy.x > 23 <= 31) {
                                    subsectorIndex = 7;
                                }
                            } else if (xy.y > 19 && xy.y <= 29) {
                                if (xy.x <= 7) {
                                    subsectorIndex = 8;
                                } else if (xy.x > 7 && xy.x <= 15) {
                                    subsectorIndex = 9;
                                } else if (xy.x > 15 <= 23) {
                                    subsectorIndex = 10;
                                } else if (xy.x > 23 <= 31) {
                                    subsectorIndex = 11;
                                }
                            } else if (xy.y > 29 && xy.y <= 39) {
                                if (xy.x <= 7) {
                                    subsectorIndex = 12;
                                } else if (xy.x > 7 && xy.x <= 15) {
                                    subsectorIndex = 13;
                                } else if (xy.x > 15 <= 23) {
                                    subsectorIndex = 14;
                                } else if (xy.x > 23 <= 31) {
                                    subsectorIndex = 15;
                                }
                            }

                            system.subsectorIndex = subsectorIndex;
                            if (importance > subsectorMaxImportance[subsectorIndex]) {
                                subsectorCapitals[subsectorIndex] = system;
                                subsectorMaxImportance[subsectorIndex] = importance;
                                tradeCodeCount = system.mainworld.tradecodes.length | 0;
                            } else if (importance === subsectorMaxImportance[subsectorIndex]) {
                                if (system.mainworld.tradecodes && system.mainworld.tradecodes.length > tradeCodeCount) {
                                    subsectorCapitals[subsectorIndex] = system;
                                    subsectorMaxImportance[subsectorIndex] = importance;
                                }
                            }
                        }

                        var desiredXFromBorder = SUBSECTOR_WIDTH / 8;
                        var desiredYFromBorder = SUBSECTOR_HEIGHT / 8;
                        var withinDesiredXRange = (xy.x > desiredXFromBorder && xy.x < SUBSECTOR_WIDTH - desiredXFromBorder);
                        var withinDesiredYRange = (xy.y > desiredYFromBorder && xy.y < SUBSECTOR_HEIGHT - desiredYFromBorder);
                        if (withinDesiredXRange) {
                            importance += 1;
                        } else {
                            importance -= 1;
                        }
                        if (withinDesiredYRange) {
                            importance += 1;
                        } else {
                            importance -= 1;
                        }
                        if (withinDesiredXRange && withinDesiredYRange) {
                            importance += 1;
                        }
                        if (importance > maxImportance) {
                            capital = system;
                            maxImportance = importance;
                            tradeCodeCount = capital.mainworld.tradecodes.length | 0;
                        } else if (importance === maxImportance) {
                            if (system.mainworld.tradecodes && system.mainworld.tradecodes.length > tradeCodeCount) {
                                capital = system;
                                maxImportance = importance;
                            }
                        }
                    }
                    // throw in the Mongoose tech codes for good measure
                    var tech = mainworld.tech;
                    sumTech += tech;
                    if(tech > maximumtech){
                        maximumtech = tech;
                    }
                    if (tech >= 12 && system.mainworld.tradecodes.indexOf("Ht") === -1) { system.mainworld.tradecodes.push("Ht"); }
                    else if (tech <= 5 && system.mainworld.tradecodes.indexOf("Lt") === -1) { system.mainworld.tradecodes.push("Lt"); }
                    if (mainworld.tradecodes.indexOf("Cy") > 0) {
                        // figure out the colony owner here!
                    }
                    system.neighbors = getTradePartners(system.tcoord);
                }
                averagetech = sumTech / systemArray.length;
                if(numImportantWorlds === 0){ 
                    averagecommunitytech = "N/A"; 
                }else{
                    averagecommunitytech = (sumImportantTech / numImportantWorlds).toFixed(2);
                }
                if(maximumcommunitytech === 0){ maximumcommunitytech = "N/A";}
                document.querySelector("[data-sector='maximumtech']").innerHTML = maximumtech;
                document.querySelector("[data-sector='averagetech']").innerHTML = averagetech.toFixed(2);
                document.querySelector("[data-sector='averagecommunitytech']").innerHTML = averagecommunitytech;
                document.querySelector("[data-sector='maximumcommunitytech']").innerHTML = maximumcommunitytech;

                if (designateSubsectorCapitals) {
                    for (var i = 0, len = subsectorCapitals.length; i < len; i++) {
                        if (subsectorCapitals[i]) {
                            subsectorCapitals[i].isCapital = true;
                            if(subsectorCapitals[i].mainworld.tradecodes.indexOf("Cp") === -1){
                                subsectorCapitals[i].mainworld.tradecodes.push("Cp");
                            }
                            subsectorCapitals[i].mainworld.tradecodes.sort();
                            var indexOfLesserDuke = subsectorCapitals[i].nobility.indexOf("f");
                            if (indexOfLesserDuke) {
                                subsectorCapitals[i].nobility.splice(indexOfLesserDuke, indexOfLesserDuke + 1)
                            }
                            if(subsectorCapitals[i].nobility.indexOf("F") === -1){
                                subsectorCapitals[i].nobility.push("F");
                            }
                        }
                    }

                }
                if (capital && designateSectorCapital) {
                    capital.isCapital = true;
                    if(capital.mainworld.tradecodes.indexOf("Cs") === -1){
                        capital.mainworld.tradecodes.push("Cs");
                    }
                    var subsectorCapitalCodeIndex = capital.mainworld.tradecodes.indexOf("Cp");
                    if (subsectorCapitalCodeIndex >= 0) {
                        capital.mainworld.tradecodes.splice(subsectorCapitalCodeIndex, 1);
                    }
                    capital.mainworld.tradecodes.sort();
                    var indexOfLesserDuke = capital.nobility.indexOf("f");
                    if (indexOfLesserDuke) {
                        capital.nobility.splice(indexOfLesserDuke, indexOfLesserDuke + 1)
                    }
                    if (capital.nobility.indexOf("F") < 0) {
                        capital.nobility.push("F");
                    }
                }
                
            }

            function generateHexes(x, y, systems) {
                var systemsPredefined = true;
                if (typeof systems === "undefined") {
                    _systems = {};
                    systemsPredefined = false;
                } else {
                    _systems = systems;
                }
                mapContent = [];
                var counter = 0;
                for (var iy = 0; iy < y; iy++) {
                    for (var ix = 0; ix < x; ix++) {
                        var hexLabel = XYCoordToTCoord(ix, iy);
                        var system = _systems[hexLabel];
                        if(system){
                            system.index = counter;
                            system.x = ix;
                            system.y = iy;
                        }
                        counter += 1;
                        addHex(ix, iy, system);
                    }
                }
                return mapContent;
            }
            function addHex(x, y, system) {
                mapContent.push({
                    x: x,
                    y: y,
                    system: system
                });
            }
            function coordsInHexagon(x, y, hex) {
                var isInside = false;
                if(hex.vertx){
                    var numVertices = hex.vertx.length;
                    for (var i = 0, j = numVertices - 1; i < numVertices; j = i++) {
                        if (((hex.verty[i] > y) != (hex.verty[j] > y)) &&
                        (x < (hex.vertx[j] - hex.vertx[i]) * (y - hex.verty[i]) / (hex.verty[j] - hex.verty[i]) + hex.vertx[i])) {
                            isInside = !isInside;
                        }
                    }
                }
                return isInside;
            }
            function drawMap(mapContent, options) {
                if (typeof options === "undefined") {
                    options = {
                        heatMap: +(document.getElementById("slcHeatMap").value),
                        travelCodes: document.getElementById("chkShowTravelCodes").checked
                    };
                }
                ctx.textAlign = "center";
                var fontSize = HEX_SIZE * 1 / 3;
                ctx.font = "" + fontSize + "pt " + FONT;
                var w = canvas.width, h = canvas.height;
                ctx.clearRect(0, 0, w, h);
                if (CANVAS_BACKGROUND_COLOR !== "transparent") {
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                    ctx.fillRect(0, 0, w, h);
                }
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.halfYOffset + CANVAS_PADDING);
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    mapContent[i] = drawHex(mapContent[i], options);
                }
                
                if(document.getElementById("chkShowTradeRoutes").checked){
                    drawRoutes();
                }
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    drawFinal(mapContent[i], options);
                }
                ctx.restore();
                document.getElementById("data").value = JSON.stringify(_systems);
            }
            function selectT5TravelCodes() {
                document.getElementById("slctAmberGovLaw").setAttribute("data-color", document.getElementById("slctAmberGovLaw").value = "Amber");
                document.getElementById("slctRedGovLaw").setAttribute("data-color", document.getElementById("slctRedGovLaw").value = "Red");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color", document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color", document.getElementById("slctRedGovLawThreshold").value = 22);
                //document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color", document.getElementById("slctRedZoneX").value = "Red");

                document.getElementById("slctAmberDieback").setAttribute("data-color", document.getElementById("slctAmberDieback").value = "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color", document.getElementById("slctAmberZoneBa").value = "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color", document.getElementById("slctAmberZoneBaX").value = "Red");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color", document.getElementById("slctAmberZoneAtmo").value = "N/A");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color", document.getElementById("slctAmberZoneLL").value = "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color", document.getElementById("slctAmberZone9LL").value = "N/A");
                document.getElementById("slctLawLevelThreshold").value = 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color", document.getElementById("slctAmberZone0LL").value = "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color", document.getElementById("slctAmberZoneGov0").value = "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color", document.getElementById("slctAmberZoneGov7").value = "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color", document.getElementById("slctAmberZoneGov10").value = "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function selectCETravelCodes() {
                document.getElementById("slctAmberGovLaw").setAttribute("data-color", document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color", document.getElementById("slctRedGovLaw").value = "N/A");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color", document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color", document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color", document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctDangerousAtmoThresholdMax").setAttribute("data-color", document.getElementById("slctDangerousAtmoThresholdMax").value = 15);
                document.getElementById("slctRedZoneX").setAttribute("data-color", document.getElementById("slctRedZoneX").value = "N/A");
                document.getElementById("slctAmberDieback").setAttribute("data-color", document.getElementById("slctAmberDieback").value = "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color", document.getElementById("slctAmberZoneBa").value = "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color", document.getElementById("slctAmberZoneBaX").value = "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color", document.getElementById("slctAmberZoneAtmo").value = "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color", document.getElementById("slctAmberZoneLL").value = "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color", document.getElementById("slctAmberZone9LL").value = "Amber");
                document.getElementById("slctLawLevelThreshold").value = 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color", document.getElementById("slctAmberZone0LL").value = "Amber");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color", document.getElementById("slctAmberZoneGov0").value = "Amber");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color", document.getElementById("slctAmberZoneGov7").value = "Amber");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color", document.getElementById("slctAmberZoneGov10").value = "Amber");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function resetTravelCodes() {
                document.getElementById("slctAmberGovLaw").setAttribute("data-color", document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color", document.getElementById("slctRedGovLaw").value = "Amber");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color", document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color", document.getElementById("slctRedGovLawThreshold").value = 21);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color", document.getElementById("slctDangerousAtmoThreshold").value = 12);
                document.getElementById("slctDangerousAtmoThresholdMax").setAttribute("data-color", document.getElementById("slctDangerousAtmoThresholdMax").value = 12);
                document.getElementById("slctRedZoneX").setAttribute("data-color", document.getElementById("slctRedZoneX").value = "Red");
                document.getElementById("slctAmberDieback").setAttribute("data-color", document.getElementById("slctAmberDieback").value = "Red");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color", document.getElementById("slctAmberZoneBa").value = "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color", document.getElementById("slctAmberZoneBaX").value = "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color", document.getElementById("slctAmberZoneAtmo").value = "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color", document.getElementById("slctAmberZoneLL").value = "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color", document.getElementById("slctAmberZone9LL").value = "N/A");
                document.getElementById("slctLawLevelThreshold").value = 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color", document.getElementById("slctAmberZone0LL").value = "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color", document.getElementById("slctAmberZoneGov0").value = "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color", document.getElementById("slctAmberZoneGov7").value = "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color", document.getElementById("slctAmberZoneGov10").value = "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = true;
            }
            function applyTravelCodes(mapContent, highestLawLevel) {
                var RedGovLaw = document.getElementById("slctRedGovLaw").value;
                var AmberDieback = document.getElementById("slctAmberDieback").value;
                var AmberGovLaw = document.getElementById("slctAmberGovLaw").value;
                var RedGovLawThreshold = document.getElementById("slctRedGovLawThreshold").value;
                var DangerousAtmoThreshold = document.getElementById("slctDangerousAtmoThreshold").value;
                var DangerousAtmoThresholdMax = document.getElementById("slctDangerousAtmoThresholdMax").value;
                var AmberGovLawThreshold = document.getElementById("slctAmberGovLawThreshold").value;
                var RedZoneX = document.getElementById("slctRedZoneX").value;
                var AmberZoneBa = document.getElementById("slctAmberZoneBa").value;
                var AmberZoneBaX = document.getElementById("slctAmberZoneBaX").value;
                var AmberZoneAtmo = document.getElementById("slctAmberZoneAtmo").value;
                var AmberZoneLL = document.getElementById("slctAmberZoneLL").value;
                var AmberZone9LL = document.getElementById("slctAmberZone9LL").value;
                var LLThreshold = document.getElementById("slctLawLevelThreshold").value;
                var MaxLLThreshold = document.getElementById("slctMaxLawLevelThreshold").value;
                var AmberZone0LL = document.getElementById("slctAmberZone0LL").value;
                var AmberZoneGov0 = document.getElementById("slctAmberZoneGov0").value;
                var AmberZoneGov7 = document.getElementById("slctAmberZoneGov7").value;
                var AmberZoneGov10 = document.getElementById("slctAmberZoneGov10").value;
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    if (typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null) {
                        mapContent[i].system.isAmber = false;
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.travelcodenotes = "";
                        if (mapContent[i].system.mainworld.pop > 0) {
                            if (AmberZoneLL !== "N/A") { // amber zone highest law level
                                if (mapContent[i].system.mainworld.law === maxes[6] && maxes[6] >= MaxLLThreshold) {
                                    if (AmberZoneLL === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Among strictest law levels in the subsector.  ";
                                }
                            }
                            if (AmberZone9LL !== "N/A") { // amber zone 9+ law level 
                                if (mapContent[i].system.mainworld.law >= LLThreshold) {
                                    if (AmberZone9LL === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Law levels " + LLThreshold.toString() + "+.  ";
                                }
                            }
                            if (AmberZone0LL !== "N/A") { // amber zone 0 law level
                                if (mapContent[i].system.mainworld.law === 0) {
                                    if (AmberZone0LL === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "No law level enforced.  ";
                                }
                            }

                            if (AmberZoneGov0 !== "N/A") { // amber ungoverned
                                if (mapContent[i].system.mainworld.gov === 0) {
                                    if (AmberZoneGov0 === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Anarchy.  ";
                                }
                            }
                            if (AmberZoneGov7 !== "N/A") { // amber balkanized
                                if (mapContent[i].system.mainworld.gov === 7) {
                                    if (AmberZoneGov7 === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Balkanized local governments.  ";
                                }
                            }
                            if (AmberZoneGov0 !== "N/A") { // amber charismatic dictatorship
                                if (mapContent[i].system.mainworld.gov === 10) {
                                    if (AmberZoneGov0 === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Ruled by charismatic dictatorship.  ";
                                }
                            }
                            if (RedZoneX !== "N/A" && mapContent[i].system.mainworld.starport.toUpperCase() === "X") { // red no starport
                                if (RedZoneX === "Red") {
                                    mapContent[i].system.isRed = true;
                                } else {
                                    mapContent[i].system.isAmber = true;
                                }
                                mapContent[i].system.travelcodenotes += "Population under interdiction.  ";
                            }
                            if (RedGovLaw !== "N/A") {
                                if (mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= RedGovLawThreshold) {
                                    if (RedGovLaw === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }

                            }
                            if (AmberGovLaw !== "N/A") {
                                if (mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= AmberGovLawThreshold) {
                                    if (AmberGovLaw === "Red") {
                                        mapContent[i].system.isRed = true;
                                    } else {
                                        mapContent[i].system.isAmber = true;
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }

                            }
                        } else {
                            if (AmberZoneBa !== "N/A" && mapContent[i].system.mainworld.tech === 0) { // amber zone uninhabited

                                if (AmberZoneBa === "Red") {
                                    mapContent[i].system.isRed = true;
                                } else {
                                    mapContent[i].system.isAmber = true;
                                }
                                mapContent[i].system.travelcodenotes += "Barren/Uninhabited.  ";

                            }
                            if (AmberZoneBaX !== "N/A" && mapContent[i].system.starport === "X") { // amber zone uninhabited

                                if (AmberZoneBaX === "Red") {
                                    mapContent[i].system.isRed = true;
                                } else {
                                    mapContent[i].system.isAmber = true;
                                }
                                if (mapContent[i].system.mainworld.tech <= 5) {
                                    mapContent[i].system.travelcodenotes += "Protected population. No starport facilities.  ";
                                } else {
                                    mapContent[i].system.travelcodenotes += "Under interdiction. No starport facilities.  ";
                                }

                            }
                            if (AmberDieback !== "N/A" && mapContent[i].system.mainworld.tech > 0) {
                                if (AmberDieback === "Red") {
                                    mapContent[i].system.isRed = true;
                                } else {
                                    mapContent[i].system.isAmber = true;
                                }
                                if (mapContent[i].system.mainworld.starport === "E") {
                                    mapContent[i].system.travelcodenotes += "Archaeological site (dieback world).  ";
                                } else {
                                    mapContent[i].system.travelcodenotes += "Dieback world.  ";
                                }
                            }
                        }
                        if (AmberZoneAtmo !== "N/A") { // amber 10+ atmo
                            if (mapContent[i].system.mainworld.atmo >= DangerousAtmoThreshold && mapContent[i].system.mainworld.atmo <= DangerousAtmoThresholdMax) {
                                if (AmberZoneAtmo === "Red") {
                                    mapContent[i].system.isRed = true;
                                } else {
                                    mapContent[i].system.isAmber = true;
                                }
                                mapContent[i].system.travelcodenotes += "Dangerous atmosphere.  ";
                            }
                        }
                        var indexOfFo = mapContent[i].system.mainworld.tradecodes.indexOf("Fo");
                        if (mapContent[i].system.isRed) {
                            mapContent[i].system.travelcodenotes = "RED ZONE: " + mapContent[i].system.travelcodenotes;
                            if (indexOfFo == -1) { mapContent[i].system.mainworld.tradecodes.push("Fo"); mapContent[i].system.mainworld.tradecodes.sort(); }
                        } else {
                            if (indexOfFo >= 0) { mapContent[i].system.mainworld.tradecodes.splice(indexOfFo, 1); }
                            if (mapContent[i].system.isAmber) {
                                mapContent[i].system.travelcodenotes = "AMBER ZONE: " + mapContent[i].system.travelcodenotes;

                            }
                        }
                    }
                }
            }
            function clearTravelCodes(mapContent) {
                for (var i = 0, len = mapContent.length; i < len; i++) {
                    if (typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null) {
                        mapContent[i].system.isRed = false;
                        var indexOfFo = mapContent[i].system.mainworld.tradecodes.indexOf("Fo");
                        if (indexOfFo) {
                            if (indexOfFo >= 0) { mapContent[i].system.mainworld.tradecodes.splice(indexOfFo, 1); }
                        }
                        mapContent[i].system.isAmber = false;
                    }
                }
            }
            function TCoordToXYCoord(tcoord) {
                if (tcoord.length && tcoord.length == 4) {
                    var col = tcoord.substring(0, 2);
                    var row = tcoord.substring(2, 4);
                    if (row[0] == "0") { row = row[1]; }
                    if (col[0] == "0") { col = col[1]; }
                    return { x: +(col) - 1 - SUBSECTOR_X_OFFSET, y: +(row) - 1 - SUBSECTOR_Y_OFFSET}
                }else{return tcoord;}
            }
            function XYCoordToTCoord(x, y) {
                x = (+(x) + 1 + SUBSECTOR_X_OFFSET)
                var col = (x).toString();
                if (x < 10) { col = "0" + col; }
                y = +(y) + 1 + SUBSECTOR_Y_OFFSET;
                var row = (y).toString();
                if (y < 10) { row = "0" + row; }
                return col + row;
            }
            function getHexCorner(center, size, i){
                var angle_deg = 60 * i;
                var angle_rad = Math.PI / 180 * angle_deg;
                return {
                    x: center.x + size * Math.cos(angle_rad),
                    y: center.y + size * Math.sin(angle_rad)
                }
            }
            function drawHex(hex, options) {
                var drawMode = -1;
                if (typeof options.heatMap !== "undefined") { drawMode = options.heatMap; }
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                var coords = {
                    x: hex.x * HEX_MATH.xOffset,
                    y: hex.x % 2 == 0 ? hex.y * HEX_MATH.yOffset : hex.y * HEX_MATH.yOffset + HEX_MATH.halfYOffset
                };
                var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x + HEX_MATH.radius; // top/bottom right vertex
                var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2 - x1) / 2; // middle of the bottom edge
                var y0 = coords.y - HEX_MATH.halfYOffset,
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.halfYOffset;

                ctx.strokeStyle = HEX_BORDER_COLOR;
                var oldLineWidth = ctx.lineWidth;

                ctx.beginPath();
                ctx.moveTo(x4, y2);
                hex.vertx = [x4, x2, x3, x2, x1, x0, x1, x4];
                hex.verty = [y2, y2, y1, y0, y0, y1, y2, y2];
                for (var i = 1; i < hex.vertx.length; i++) {
                    ctx.lineTo(hex.vertx[i], hex.verty[i]);
                }
                ctx.stroke();
                ctx.fillStyle = HEX_BACKGROUND_COLOR;
                ctx.fill();

                if (containsSystem) {
                    if (drawMode >= 0) {
                        var heatMapValue = 0;
                        var bgColor = "black";
                        var minValue = mins[drawMode], maxValue = maxes[drawMode];
                        switch (drawMode) {
                            case 0: // starport
                                switch (hex.system.mainworld.starport) {
                                    case "A": bgColor = "rgb(255,0,0)"; break;
                                    case "B": bgColor = "rgb(200,0,50)"; break;
                                    case "C": bgColor = "rgb(150,0,100)"; break;
                                    case "D": bgColor = "rgb(100,0,150)"; break;
                                    case "E": bgColor = "rgb(50,0,200)"; break;
                                    case "X": bgColor = "rgb(0,0,205)"; break;
                                }

                                break;
                            case 1: heatMapValue = hex.system.mainworld.size;
                                break;
                            case 2: heatMapValue = hex.system.mainworld.atmo;
                                break;
                            case 3: heatMapValue = hex.system.mainworld.hydro;
                                break;
                            case 4: heatMapValue = hex.system.mainworld.pop; break;
                            case 5: heatMapValue = hex.system.mainworld.gov; break;
                            case 6: heatMapValue = hex.system.mainworld.law; break;
                            case 7: heatMapValue = hex.system.mainworld.tech; break;
                            case 8: heatMapValue = hex.system.importance.extension; break;
                            case 9:
                                var currValue = hex.system.totalpop;
                                if (currValue > 0) { currValue = Math.round(Math.log10(currValue)); }
                                heatMapValue = currValue;
                                break;
                            case 10: heatMapValue = hex.system.economics.RU; break;
                            case 11:
                                if (hex.system.natives) { bgColor = "rgb(255,0,0)"; }
                                else { bgColor = "rgb(0,0,205)"; }
                                break;
                        }
                        if (drawMode > 0 && drawMode < 11) {
                            var bValue = 200 - 200 * ((heatMapValue - minValue) / (maxValue - minValue)) >>> 0;
                            var rValue = 255 * ((heatMapValue - minValue) / (maxValue - minValue)) >>> 0;
                            bgColor = "rgb(" + rValue + ",0," + bValue + ")";
                        }
                        ctx.fillStyle = bgColor;
                        ctx.fill();
                    }

                    if (hex.selected || hex.highlighted) {
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if (ctx.strokeStyle.length === 7) {
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if (hex.selected) {
                            ctx.lineWidth = inc;
                        } else if (hex.highlighted) {
                            ctx.lineWidth = inc / 2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2, tx3, tx2,];//tx1,tx0,tx1];
                        var verty = [ty2, y1, ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for (var i = 0; i < vertx.length; i++) {
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1, tx0, tx1];
                        var verty = [ty0, y1, ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for (var i = 0; i < vertx.length; i++) {
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                    var zoneRadius = fontSize * 5;
                    if (options.travelCodes && (hex.system.isRed || hex.system.isAmber)) {

                        if (hex.system.isRed) {
                            ctx.strokeStyle = "red";
                        } else if (hex.system.isAmber) {
                            ctx.strokeStyle = "yellow";
                        }
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x4, y1, zoneRadius, -Math.PI / 2, Math.PI / 4);
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.arc(x4, y1, zoneRadius, -5 * Math.PI / 4, -Math.PI / 2);
                        ctx.stroke();
                        ctx.strokeStyle = HEX_BORDER_COLOR;

                    }


                    if (hex.system.gg > 0) {
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x2, y1 - (y1 - y0) / 2, fontSize / 2, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                    for (var i = 0, len = hex.system.bases.length; i < len; i++) {
                        var base = hex.system.bases[i];
                        drawBase(base, x4, y1);
                    }

                    // draw planet
                    if (hex.system.isAsteroidBelt) {
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1) / 2.5, y1 - (y1 - y0) / 8, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1) / 9, y1, fontSize / 6, 0, 2 * Math.PI);
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1) / 5, y1 - (y1 - y0) / 11, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1) / 6, y1 + (y1 - y0) / 9, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1) / 2.5, y1 + (y1 - y0) / 18, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1) / 2, y1, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1) / 8, y1 - (y1 - y0) / 6, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1) / 7, y1 + (y1 - y0) / 8, fontSize / 6, 0, 2 * Math.PI);
                        ctx.fill();
                    } else if (hex.system.mainworld.hydro > 0) {
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4, y1, fontSize, 0, 2 * Math.PI);
                        ctx.fill();
                    } else {
                        ctx.strokeStyle = TEXT_COLOR;
                        ctx.lineWidth = HEX_SIZE / 10;
                        ctx.beginPath();
                        ctx.arc(x4, y1, fontSize, 0, 2 * Math.PI);
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                    }

                    // write starport
                    var oldFont = ctx.font;
                    ctx.font = "" + (fontSize * 1.2) + "pt " + FONT;
                    ctx.fillStyle = TEXT_COLOR;
                    ctx.fillText(hex.system.uwp[0], x4, y0 + (y1 - y0) / 2 + size*0.2);
                    ctx.font = oldFont;

                    // write coordinates 
                    ctx.font = "" + (fontSize * 0.8) + "pt " + FONT;
                    ctx.fillStyle = (hex.selected || hex.highlighted) ? TEXT_COLOR : COORD_TEXT_COLOR;
                    
                    ctx.fillText(hex.system.tcoord, x4, y0 + (fontSize * 0.9) + size*0.1);
                    ctx.font = oldFont;

                }
                else {
                    if (hex.selected || hex.highlighted) {
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if (ctx.strokeStyle.length === 7) {
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if (hex.selected) {
                            ctx.lineWidth = inc;
                        } else if (hex.highlighted) {
                            ctx.lineWidth = inc / 2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2, tx3, tx2,];//tx1,tx0,tx1];
                        var verty = [ty2, y1, ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for (var i = 0; i < vertx.length; i++) {
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1, tx0, tx1];
                        var verty = [ty0, y1, ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for (var i = 0; i < vertx.length; i++) {
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                }

                ctx.lineWidth = oldLineWidth;
                return hex;
            }
            function drawFinal(hex, options) {
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                if (containsSystem) {

                    var coords = {
                        x: hex.x * HEX_MATH.xOffset,
                        y: hex.x % 2 == 0 ? hex.y * HEX_MATH.yOffset : hex.y * HEX_MATH.yOffset + HEX_MATH.halfYOffset
                    };
                    var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                        x2 = coords.x + HEX_MATH.radius; // top/bottom right vertex
                    var x0 = x1 - HEX_MATH.radius, // center left vertex
                        x3 = x2 + HEX_MATH.radius, // center right vertex
                        x4 = x1 + (x2 - x1) / 2; // middle of the bottom edge
                    var y0 = coords.y - HEX_MATH.halfYOffset,
                        y1 = coords.y,
                        y2 = y1 + HEX_MATH.halfYOffset;
                    var maxWidth = x3 - x0 - (x1 - x0) / 2 - (x3 - x2) / 2 - fontSize * 2;
                    var name = hex.system.name;
                    var oldFontStyle = ctx.font;
                    if (hex.system.importance.isImportant) {
                        ctx.font = "bold " + oldFontStyle;
                        name = name.toUpperCase();
                    }
                    if (hex.system.mainworld.pop >= 9) {
                        //ctx.font = "small-caps "+ oldFontStyle;
                        name = name.toUpperCase();
                    }
                    var lines = [];
                    if (ctx.measureText(name).width > maxWidth) {
                        var words = name.split(" ");
                        var lineSoFar = "";
                        for (var i = words.length - 1; i >= 0; i--) {
                            var proposal = lineSoFar.length > 0 ? words[i] + " " + lineSoFar : words[i];
                            if (ctx.measureText(proposal).width < maxWidth) {
                                lineSoFar = proposal;
                            } else {
                                if (lineSoFar.length > 0) {
                                    lines.push(lineSoFar);
                                }
                                lineSoFar = words[i];
                            }
                            maxWidth += fontSize;
                        }
                        if (lineSoFar.length > 0) { lines.push(lineSoFar); }
                    } else {
                        lines = [name];
                    }
                    // write text
                    ctx.textAlign = "center";
                    if (hex.system.isCapital) {
                        if (hex.system.mainworld.tradecodes.indexOf("Cs") >= 0) {
                            ctx.fillStyle = SECTORCAPITAL_TEXT_COLOR;
                        } else {
                            ctx.fillStyle = CAPITAL_TEXT_COLOR;
                        }
                        ctx.font = "bold " + oldFontStyle;
                        ctx.strokeStyle = CAPITAL_BACKGROUND_COLOR;
                        ctx.lineWidth = fontSize / 8;
                    } else {
                        ctx.fillStyle = TEXT_COLOR;
                    }
                    maxWidth = x3 - x0 - (x1 - x0) / 2 - (x3 - x2) / 2 - fontSize * 2;
                    var height = y2 - lines.length * fontSize;
                    var oldLineWidth = ctx.lineWidth;
                    for (var i = lines.length - 1; i >= 0; i--) {
                        if (hex.system.isCapital) {
                            ctx.lineWidth = fontSize / 8;
                            ctx.strokeText(lines[i], x4, height, maxWidth);
                            ctx.lineWidth = oldLineWidth;
                        }
                        ctx.fillText(lines[i], x4, height, maxWidth);

                        height += fontSize + (fontSize / 4);
                    }
                    ctx.font = oldFontStyle;
                    if (hex.selected || hex.highlighted) {
                        ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                        var backStyle = ctx.fillStyle;

                        ctx.fillStyle = TEXT_COLOR;
                        // write UWP
                        ctx.beginPath();
                        var oldGlobalCompositeOperation = ctx.globalCompositeOperation;
                        ctx.globalCompositeOperation = 'source-over';
                        var uwp = hex.system.uwp.toUpperCase();
                        var uwpSize = ctx.measureText(uwp);
                        ctx.fillStyle = backStyle;
                        var fontHeight = uwpSize.fontBoundingBoxAscent + uwpSize.fontBoundingBoxDescent;
                        ctx.fillRect(x4 - uwpSize.width / 2, y1 - fontHeight / 2 - 2, uwpSize.width, fontSize + 2);
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.fillText(uwp, x4, y1);
                        // write trade codes
                        maxWidth = x3 - x0 - (x1 - x0) / 2 - (x3 - x2) / 2 - fontSize * 2;
                        var codes = hex.system.mainworld.tradecodes.join(" ");
                        var codesSize = ctx.measureText(codes);
                        lines = [codes];
                        if (codesSize.width > maxWidth) {
                            var line1 = hex.system.mainworld.tradecodes.slice(0, hex.system.mainworld.tradecodes.length / 2 >> 0).join(" ");
                            var line2 = hex.system.mainworld.tradecodes.slice(hex.system.mainworld.tradecodes.length / 2 >> 0).join(" ");
                            lines = [line1, line2]
                        }
                        height = y1 + fontHeight;
                        var blockHeight = y1 + fontHeight / 2 - 2;
                        for (var i = lines.length - 1; i >= 0; i--) {
                            var lineWidth = ctx.measureText(lines[i]).width;
                            ctx.fillStyle = backStyle;
                            ctx.fillRect(x4 - lineWidth / 2, blockHeight, lineWidth, fontSize + 2);
                            ctx.fillStyle = TEXT_COLOR;
                            ctx.fillText(lines[i], x4, height, maxWidth);
                            height += fontSize + (fontSize / 3);
                            blockHeight += fontSize + (fontSize / 3);
                        }
                        ctx.globalCompositeOperation = oldGlobalCompositeOperation;
                    }
                }
            }
            function drawBase(baseType, hexX, hexY) {
                switch (baseType) {
                    case "Scout":
                        var scale = fontSize / 2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        var yMod = -1.9;
                        ctx.moveTo(hexX - scale * 8, hexY + scale * (yMod + 4));
                        ctx.lineTo(hexX - scale * 6, hexY + scale * (yMod + 4));
                        ctx.lineTo(hexX - scale * 7, hexY + scale * (yMod + 2));
                        ctx.lineTo(hexX - scale * 8, hexY + scale * (yMod + 4));
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case "Naval":
                        var scale = fontSize / 2;
                        drawStar(hexX - scale * 5, hexY - scale * 5, 5, scale * 0.7, scale * 1.7);
                        break;
                    case "Naval Depot":
                        var scale = fontSize / 2;
                        strokeStar(hexX - scale * 5, hexY - scale * 5, 5, scale * 0.7, scale * 1.7);
                        break;
                    case "Way Station":
                        var scale = fontSize / 2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        var yMod = -1.9;
                        ctx.moveTo(hexX - scale * 8, hexY + scale * (yMod + 4));
                        ctx.lineTo(hexX - scale * 6, hexY + scale * (yMod + 4));
                        ctx.lineTo(hexX - scale * 7, hexY + scale * (yMod + 2));
                        ctx.lineTo(hexX - scale * 8, hexY + scale * (yMod + 4));
                        ctx.closePath();
                        var oldLineWidth = ctx.lineWidth;
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = TEXT_COLOR;
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                        break;
                }
            }
            function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;

                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                ctx.fillStyle = TEXT_COLOR;
                ctx.fill();
            }
            function strokeStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;

                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                var oldLineWidth = ctx.lineWidth;
                ctx.lineWidth = 1;
                ctx.strokeStyle = TEXT_COLOR;
                ctx.stroke();
                ctx.lineWidth = oldLineWidth;
            }
            function updateStyle() {
                var select = document.getElementById("slctStyle");
                var val = select.value;
                if (val === "custom") {
                    document.getElementById("hexBorderColor").value = select.getAttribute("data-hexfg");
                    document.getElementById("hexBackgroundColor").value = select.getAttribute("data-hexbg");
                    document.getElementById("canvasBackgroundColor").value = select.getAttribute("data-canvasbg");
                    document.getElementById("textColor").value = select.getAttribute("data-text");
                    document.getElementById("coordTextColor").value = select.getAttribute("data-ctext");
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";

                } else if (val === "light") {
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "white";
                    document.getElementById("textColor").value = "black";
                    document.getElementById("coordTextColor").value = "rgba(0,0,0,0.8)";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                } else if (val === "dark") {
                    document.getElementById("hexBorderColor").value = "white";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "black";
                    document.getElementById("textColor").value = "white";
                    document.getElementById("coordTextColor").value = "rgba(255,255,255,0.8)";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                } else if (val === "transparent") {
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "transparent";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                    document.getElementById("textColor").value = "black";
                    document.getElementById("coordTextColor").value = "rgba(0,0,0,0.8)";
                }
                updateHexBorderColor(document.getElementById("hexBorderColor").value);
                updateHexBackgroundColor(document.getElementById("hexBackgroundColor").value);
                updateCanvasBackgroundColor(document.getElementById("canvasBackgroundColor").value);
                updateTextColor(document.getElementById("textColor").value);
                updateCoordTextColor(document.getElementById("coordTextColor").value);
                updateFont(document.getElementById("fontFamily").value);
                drawMap(mapContent);
            }
            function updateFont(newFont) {
                FONT = newFont;
                ctx.font = "" + fontSize + "pt " + newFont;
            }
            function updateHexSize(newSize) {
                HEX_SIZE = newSize;
                HEX_MATH.radius = HEX_SIZE;
                HEX_MATH.xOffset = HEX_SIZE * 3;
                HEX_MATH.yOffset = Math.sqrt(3) * HEX_SIZE*2;
                HEX_MATH.halfYOffset = Math.sqrt(3) * HEX_SIZE;
                HEX_MATH.diameter = HEX_SIZE * 2;
                canvas.setAttribute("width", SUBSECTOR_WIDTH * HEX_MATH.xOffset + HEX_MATH.radius + CANVAS_PADDING * 2);
                canvas.setAttribute("height", SUBSECTOR_HEIGHT * HEX_MATH.yOffset + HEX_MATH.halfYOffset + CANVAS_PADDING * 2);
                fontSize = (newSize * 1 / 3);
                ctx.font = "" + fontSize + "pt " + FONT;
                document.getElementById("sizeIndicator").innerHTML = newSize;
            }
            function updateHexBorderColor(newColor) {
                HEX_BORDER_COLOR = newColor;
            }
            function updateHexBackgroundColor(newColor) {
                HEX_BACKGROUND_COLOR = newColor;
            }
            function updateCanvasBackgroundColor(newColor) {
                CANVAS_BACKGROUND_COLOR = newColor;
            }
            function updateTextColor(newColor) {
                TEXT_COLOR = newColor;
            }
            function updateCoordTextColor(newColor){
                COORD_TEXT_COLOR = newColor;
            }
            function addCaps(text) {
                var capitalizedString = "";
                var lastCharacter = null, currCharacter = " ";
                for (var i = 0, len = text.length; i < len; i++) {
                    lastCharacter = currCharacter;
                    currCharacter = text[i];
                    if (lastCharacter === " " || lastCharacter === "-") {
                        capitalizedString += currCharacter.toUpperCase();
                    } else {
                        capitalizedString += currCharacter;
                    }
                }
                return capitalizedString;
            }

            function XYtoIndex(x,y){
                if(x >= SUBSECTOR_WIDTH || y >= SUBSECTOR_HEIGHT || x < 0 || y < 0){ return -1;}
                return x + (y * (SUBSECTOR_WIDTH));
            }
            function getTradePartners(tcoord) {
                var xy = TCoordToXYCoord(tcoord);
                var x = xy.x, y = xy.y;
                var thisSystem = mapContent[x + (y*(SUBSECTOR_WIDTH))].system;
                if(thisSystem.isRed || thisSystem.mainworld.starport > MIN_JUMP1_ROUTE_STARPORT || thisSystem.importance.extension < MIN_JUMP1_ROUTE_IMPORTANCE){ return [];}
                var isGoodStarport = thisSystem.mainworld.starport <= MIN_JUMP2_ROUTE_STARPORT && thisSystem.importance.extension >= MIN_JUMP2_ROUTE_IMPORTANCE;
                var isGreatStarport = thisSystem.mainworld.starport <= MIN_JUMP3_ROUTE_STARPORT && thisSystem.importance.extension >= MIN_JUMP3_ROUTE_IMPORTANCE;
                
                var candidates = [];
                if (x&1 === 1) { // neighbors to left/right are vertically offset down
                    if(isGoodStarport){
                        candidates.push([x-1,y-1,2]);
                        candidates.push([x-1,y+2,2]);
                        candidates.push([x-2,y,2]);
                        candidates.push([x-2,y-1,2]);
                        candidates.push([x-2,y+1,2]);
                        candidates.push([x,y-2,2]);
                        candidates.push([x,y+2,2]);
                        candidates.push([x+1, y-1,2]);
                        candidates.push([x+2,y,2]);
                        candidates.push([x+2,y+1,2]);
                        candidates.push([x+2,y-1,2]);
                        candidates.push([x+1, y+2,2]);
                        if(isGreatStarport){
                            var d = 3;
                            candidates.push([x,y-3,d]);
                            candidates.push([x+1,y-2,d]);
                            candidates.push([x+2,y-2,d]);
                            candidates.push([x+3,y-1,d]);
                            candidates.push([x+3,y,d]);
                            candidates.push([x+3,y+1,d]);
                            candidates.push([x+3,y+2,d]);
                            candidates.push([x+2,y+2,d]);
                            candidates.push([x+1,y+3,d]);
                            candidates.push([x,y+3,d]);
                            candidates.push([x-1,y+3,d]);
                            candidates.push([x-2,y+2,d]);
                            candidates.push([x-3,y+2,d]);
                            candidates.push([x-3,y+1,d]);
                            candidates.push([x-3,y,d]);
                            candidates.push([x-3,y-1,d]);
                            candidates.push([x-2,y-2,d]);
                            candidates.push([x-1,y-2,d]);
                        }
                    }
                    candidates.push([x - 1, y,1]);
                    candidates.push([x - 1, y + 1,1]);
                    candidates.push([x, y - 1,1]);
                    candidates.push([x, y + 1,1]);  
                    candidates.push([x + 1, y,1]);
                    candidates.push([x + 1, y + 1,1]);
                } else { // neighbors to left/right are vertically offset up
                    if(isGoodStarport){
                        candidates.push([x-1,y-2,2]);
                        candidates.push([x-1,y+1,2]);
                        candidates.push([x-2,y,2]);
                        candidates.push([x-2,y-1,2]);
                        candidates.push([x-2,y+1,2]);
                        candidates.push([x,y-2,2]);
                        candidates.push([x,y+2,2]);
                        candidates.push([x+1,y+1,2]);
                        candidates.push([x+2,y+1,2]);
                        candidates.push([x+1,y-2,2]);
                        candidates.push([x+2,y,2]);
                        candidates.push([x+2,y-1,2]);
                        if(isGreatStarport){
                            var d = 3;
                            candidates.push([x,y-3,d]);
                            candidates.push([x+1,y-3,d]);
                            candidates.push([x+2,y-2,d]);
                            candidates.push([x+3,y-2,d]);
                            candidates.push([x+3,y-1,d]);
                            candidates.push([x+3,y,d]);
                            candidates.push([x+3,y+1,d]);
                            candidates.push([x+2,y+2,d]);
                            candidates.push([x+1,y+2,d]);
                            candidates.push([x+0,y+3,d]);
                            candidates.push([x-1,y+2,d]);
                            candidates.push([x-2,y+2,d]);
                            candidates.push([x-3,y+1,d]);
                            candidates.push([x-3,y,d]);
                            candidates.push([x-3,y-1,d]);
                            candidates.push([x-3,y-2,d]);
                            candidates.push([x-2,y-2,d]);
                            candidates.push([x-1,y-3,d]);
                        }
                    }
                    candidates.push([x - 1, y - 1,1]);  
                    candidates.push([x - 1, y,1]);
                    candidates.push([x, y - 1,1]);
                    candidates.push([x, y + 1,1]);
                    candidates.push([x + 1, y - 1,1]);  
                    candidates.push([x + 1, y,1]);  
                }
                var neighbors = [];
                
                for (var i = 0; i < candidates.length; i++) {
                    var candidate = candidates[i];
                    var index = XYtoIndex(candidate[0],candidate[1]);
                    if (index >= 0 & index < mapContent.length && mapContent[index].system) {
                        var target = mapContent[index].system;
                        var targetDistance = candidates[i][2];
                        var profitThreshold = TRADE_ROUTE_THRESHOLD + (targetDistance*TRADE_ROUTE_PREMIUM);
                        var targetIsOkayStarport = target.mainworld.starport <= MIN_JUMP1_ROUTE_STARPORT && target.importance.extension >= MIN_JUMP1_ROUTE_IMPORTANCE;
                        if(targetIsOkayStarport){
                            if(targetDistance === 2){
                                targetIsOkayStarport = target.mainworld.starport <= MIN_JUMP2_ROUTE_STARPORT && target.importance.extension >= MIN_JUMP2_ROUTE_IMPORTANCE;
                            }else if(targetDistance === 3){
                                targetIsOkayStarport = target.mainworld.starport <= MIN_JUMP3_ROUTE_STARPORT && target.importance.extension >= MIN_JUMP3_ROUTE_IMPORTANCE;
                            }
                        }
                        if((!target.isRed) && targetIsOkayStarport ){
                            var exportCargo = getCargo(thisSystem.mainworld.tech,thisSystem.mainworld.tradecodes,false);
                            var importCargo = getCargo(target.mainworld.tech,target.mainworld.tradecodes,false);
                            var exportProfit = calculatePrice( exportCargo,target.mainworld.tech,target.mainworld.tradecodes)-exportCargo.cost,
                            importProfit = calculatePrice( importCargo,thisSystem.mainworld.tech,thisSystem.mainworld.tradecodes)-importCargo.cost;
                            var tradeStrength = importProfit+exportProfit, twoWayTrade = exportProfit>0 && importProfit>0;
                            var neighbor = {
                                tcoord:target.tcoord,
                                export:exportProfit,
                                import:importProfit,
                                mutual:twoWayTrade,
                                trade:tradeStrength,
                                distance: targetDistance,
                                name: target.name
                            }
                            neighbors.push(neighbor);
                            if((twoWayTrade && tradeStrength > profitThreshold) || tradeStrength > 2*profitThreshold){
                                routes.push([thisSystem.tcoord,target.tcoord]);
                            }
                        }                    
                    }
                }
                return neighbors;
            }
            function isConnected(hex1, hex2) {
                for (var i = 0, len = hex1.routes.length; i < len; i++) {
                    if (hex1.routes[i] === hex2.tcoord) {
                        return true;
                    }
                }
                return false;
            }
            function drawRoutes() {
                //ctx.save();
                //ctx.globalCompositeOperation = 'source-over';
                //ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                var keys = Object.keys(_systems);
                var oldStrokeStyle = ctx.strokeStyle;
                var oldLineWidth = ctx.lineWidth;
                ctx.strokeStyle = TRADE_ROUTE_COLOR;
                ctx.lineWidth = HEX_SIZE / 10;
                for (var i = 0, len = routes.length; i < len; i++) {
                    var key = routes[i][0];
                    var destKey = routes[i][1];
                    var hex = TCoordToXYCoord(key);
                    var coords = {
                        x: hex.x * HEX_MATH.xOffset,
                        y: hex.x % 2 == 0 ? hex.y * HEX_MATH.yOffset : hex.y * HEX_MATH.yOffset + HEX_MATH.halfYOffset
                    };
                    ctx.moveTo(coords.x, coords.y);
                    var oldFillStyle = ctx.fillStyle;
                    ctx.fillStyle = TRADE_ROUTE_COLOR;
                    ctx.beginPath();
                    ctx.arc(coords.x, coords.y, fontSize*3/5, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.closePath();
                    ctx.fillStyle = oldFillStyle;
                    ctx.beginPath();
                    ctx.moveTo(coords.x, coords.y);
                    var destHex = TCoordToXYCoord(destKey);
                    var dest = {
                        x: destHex.x * HEX_MATH.xOffset,
                        y: destHex.x % 2 == 0 ? destHex.y * HEX_MATH.yOffset : destHex.y * HEX_MATH.yOffset + HEX_MATH.halfYOffset
                    };
                    ctx.lineTo(dest.x, dest.y);
                    ctx.stroke();
                    ctx.closePath();
                    oldFillStyle = ctx.fillStyle;
                    ctx.fillStyle = TRADE_ROUTE_COLOR;
                    ctx.beginPath();
                    ctx.arc(dest.x, dest.y, fontSize*3/5, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.closePath();
                }
                ctx.strokeStyle = oldStrokeStyle;
                ctx.lineWidth = oldLineWidth;
                //ctx.restore();
            }
            function renderSystem(system) {
                document.getElementById("txtSystemName").style.display = "none";
                document.getElementById("btnSaveSystemName").style.display = "none";
                document.getElementById("btnCancelSystemName").style.display = "none";
                document.getElementById("btnEditSystemName").style.display = "inline-block";
                var lookups = {
                    orbitdistance: {
                        "-1": "<0.2 AU",
                        "0": "0.2 AU",
                        "1": "0.4 AU",
                        "2": "0.7 AU",
                        "3": "1.0 AU",
                        "4": "1.6 AU",
                        "5": "2.8 AU",
                        "6": "5.2 AU",
                        "7": "10 AU",
                        "8": "20 AU",
                        "9": "40 AU",
                        "10": "77 AU",
                        "11": "154 AU",
                        "12": "308 AU",
                        "13": "615 AU",
                        "14": "1230 AU",
                        "15": "2500 AU",
                        "16": "4900 AU",
                        "17": "9800 AU",
                        "18": "19500 AU",
                        "19": "39500 AU",
                        "20": "78700 AU"
                    },
                    tradecode: {
                        "As": "Asteroid Belt",
                        "De": "Desert",
                        "Fl": "Fluid Oceans",
                        "Ga": "Garden World",
                        "He": "Hellworld",
                        "Ic": "Ice-Capped",
                        "Oc": "Ocean World",
                        "Va": "Vacuum",
                        "Wa": "Water World",
                        "Sa": "Satellite (far satellite)",
                        "Lk": "Locked (close satellite)",
                        "Di": "Dieback",
                        "Ba": "Barren",
                        "Lo": "Low Population",
                        "Ni": "Non-Industrial",
                        "Ph": "Pre-High Population",
                        "Hi": "High Population",
                        "Pa": "Pre-Agricultural",
                        "Ag": "Agricultural",
                        "Na": "Non-Agricultural",
                        "Px": "Prison or Exile Camp",
                        "Pi": "Pre-Industrial",
                        "In": "Industrial",
                        "Po": "Poor",
                        "Pr": "Pre-Rich",
                        "Ri": "Rich",
                        "Fr": "Frozen",
                        "Ho": "Hot",
                        "Co": "Cold",
                        "Tr": "Tropic",
                        "Tu": "Tundra",
                        "Tz": "Twilight Zone",
                        "Cy": "Colony",
                        "Lt": "Low Tech",
                        "Ht": "High Tech",
                        "Fo": "Forbidden",
                        "Mr": "Military Rule",
                        "Re": "Reserve",
                        "Cs": "Sector Capital",
                        "Cp": "Subsector Capital",
                        "Cx": "Capital"
                    },
                    "port": {
                        "A": "A - Excellent",
                        "B": "B - Good",
                        "C": "C - Routine",
                        "D": "D - Poor",
                        "E": "E - Frontier",
                        "X": "X - None"
                    },
                    "size": {
                        "0": "Planetoid/Belt (<800 Km) - Microgravity",
                        "1": "Small (200 - 2400 Km) - Very Low Gravity",
                        "2": "Small (2400 - 4000 Km) - Low Gravity (Luna)",
                        "3": "Small (4000 - 5600 Km) - Low Gravity (Mercury)",
                        "4": "Medium (5600 - 7200 Km) - Low Gravity (Mars)",
                        "5": "Medium (7200 - 8800 Km) - Standard/Low Gravity",
                        "6": "Medium (8800 - 10400 Km) - Standard/Low Gravity",
                        "7": "Large (10400 - 12000 Km) - Standard Gravity",
                        "8": "Large (12000 - 13600 Km) - Standard Gravity (Terra)",
                        "9": "Large (13600 - 15200 Km) - Standard Gravity",
                        "10": "Huge (15200 - 16800 Km) - Standard/High Gravity",
                        "11": "Huge (16800 - 18400 Km) - High Gravity",
                        "12": "Huge (18400 - 19400 Km) - High Gravity",
                        "13": "Massive (~20,800 Km) - High Gravity",
                        "14": "Massive (~22,400 Km) - High Gravity",
                        "15": "Massive (~24,000 Km) - High Gravity"

                    },
                    "atmo": {
                        "0": "Vacuum",
                        "1": "Trace",
                        "2": "Very Thin / Tainted",
                        "3": "Very Thin",
                        "4": "Thin / Tainted",
                        "5": "Thin",
                        "6": "Standard",
                        "7": "Standard / Tainted",
                        "8": "Dense",
                        "9": "Dense / Tainted",
                        "10": "Exotic",
                        "11": "Corrosive",
                        "12": "Insidious",
                        "13": "Dense, high",
                        "14": "Ellipsoid",
                        "15": "Thin, low"
                    },
                    "hydro": {
                        "0": "0-5% Desert",
                        "1": "6-15% Dry",
                        "2": "16-25% Dry, A Few Small Seas",
                        "3": "26-35% Wet, Small Seas and Oceans",
                        "4": "36-45% Wet World",
                        "5": "46-55% Wet, A Large Ocean",
                        "6": "56-65% Wet, Large Oceans",
                        "7": "66-75% Wet, Earthlike",
                        "8": "76-85% Very Wet, Marine",
                        "9": "86-95% Very Wet, Almost Entirely Ocean",
                        "10": "96-100% Water World"

                    },
                    "pop": {
                        "0": "",
                        "1": "0",
                        "2": " hundred",
                        "3": " thousand",
                        "4": "0 thousand",
                        "5": " hundred thousand",
                        "6": " million",
                        "7": "0 Million",
                        "8": " hundred million",
                        "9": " billion",
                        "10": "0 billion",
                        "11": " hundred billion",
                        "12": " trillion",
                        "13": "0 trillion",
                        "14": " hundred trillion",
                        "15": " quadrillion"
                    },
                    "gov": {
                        "0": "No government structure",
                        "1": "Company/Corporation",
                        "2": "Participating Democracy",
                        "3": "Self-Perpetuating Oligarchy",
                        "4": "Representative Democracy",
                        "5": "Feudal Technocracy",
                        "6": "Captive Government",
                        "7": "Balkanization",
                        "8": "Civil Service Bureaucracy",
                        "9": "Impersonal Bureaucracy",
                        "10": "Charismatic Dictator",
                        "11": "Non-Charismatic Leader",
                        "12": "Charismatic Oligarchy",
                        "13": "Religious Dictatorship",
                        "14": "Religious Autocracy",
                        "15": "Totalitarian Oligarchy"

                    },
                    "law": {
                        "0": "0 - No Law",
                        "1": "1 - Low Law, No Explosives/Poisons",
                        "2": "2 - Low Law, No Portable Energy Weapons",
                        "3": "3 - Low Law, No Automatic Weapons",
                        "4": "4 - Moderate Law, No Submachine Guns, Energy Weapons",
                        "5": "5 - Moderate Law, No Concealable Firearms, EMP Weapons, Gauss Weapons",
                        "6": "6 - Moderate Law, No Firearms Except Shotguns",
                        "7": "7 - Moderate Law, No Firearms Including Shotguns",
                        "8": "8 - High Law, Blades controlled, No open display of weapons",
                        "9": "9 - High Law, No Weapons Outside Home",
                        "10": "10 - Extreme Law, No Weapon Possession",
                        "11": "11 - Extreme Law, Civilian movement controlled",
                        "12": "12 - Extreme Law, Unrestricted invasion of privacy",
                        "13": "13 - Extreme Law, Paramilitary law enforcement",
                        "14": "14 - Extreme Law, Full-fledged police state",
                        "15": "15 - Extreme Law, All facets of daily life rigidly controlled",
                        "16": "16 - Extreme Law, Severe punishment for petty infractions",
                        "17": "17 - Extreme Law, Legalized oppression",
                        "18": "18 - Extreme Law, Routinely oppressive and restrictive",
                    },
                    "tech": {
                        "0": "TL0 - Neolithic",
                        "1": "TL1 - Bronze/Iron Age",
                        "2": "TL2 - Age of Sail",
                        "3": "TL3 - Industrial Revolution",
                        "4": "TL4 - Mechanized Age",
                        "5": "TL5 - Broadcast Age",
                        "6": "TL6 - Atomic Age",
                        "7": "TL7 - Space Age",
                        "8": "TL8 - Information Age",
                        "9": "TL9 - Gravitics Age",
                        "10": "TL10 - Basic Fusion Age",
                        "11": "TL11 - FusionPlus Age",
                        "12": "TL12 - Positronics Age",
                        "13": "TL13 - Cloning Age",
                        "14": "TL14 - Geneering Age",
                        "15": "TL15 - Anagathics Age",
                        "16": "TL16 - Artificial Persons Age",
                        "17": "TL17 - Personality Transfer Age",
                        "18": "TL18 - Exotics Age",
                        "19": "TL19 - Antimatter Age",
                        "20": "TL20 - Skip Drive Age",
                        "21": "TL21 - Stasis Age",
                        "22": "TL22 - Planet-scrubber Age",
                        "23": "TL23 - Psychohistory Age",
                        "24": "TL24 - Rosette Age",
                        "25": "TL25 - Psionic Engineering Age",
                        "26": "TL26 - Star Energy Age",
                        "27": "TL27 - Ringworlds Age",
                        "28": "TL28 - Reality Engineering Age",
                        "29": "TL29 - Dyson Sphere Age",
                        "30": "TL30 - Remote Technology Age",
                        "31": "TL31 - Pocket Universes Age"
                    },
                    "heterogeneity": {
                        // pop + flux -> max 20
                        "0": "N/A",
                        "1": "Perfectly homogeneous, ",
                        "2": "Nearly entirely homogenous, ",
                        "3": "Very homogenous, ",
                        "4": "Mostly homogenous, ",
                        "5": "Somewhat homogenous, ",
                        "6": "Slightly homogenous, ",
                        "7": "Average diversity, ",
                        "8": "Slightly diverse, ",
                        "9": "Somewhat diverse, ",
                        "10": "Mostly diverse, ",
                        "11": "Very diverse, ",
                        "12": "Cosmopolitan, ",
                        "13": "Extremely Diverse, ",
                        "14": "Extremely Diverse, ",
                        "15": "Extremely Diverse, ",
                        "16": "Extremely Diverse, ",
                        "17": "Extremely Diverse, ",
                        "18": "Extremely Diverse, ",
                        "19": "Extremely Diverse, ",
                        "20": "Extremely Diverse, "
                    },
                    "acceptance": {
                        // Pop + Importance -> max 20/21
                        "0": "",
                        "1": "Extremely xenophobic, ",
                        "2": "Very Xenophobic, ",
                        "3": "Xenophobic, ",
                        "4": "Somewhat Xenophobic, ",
                        "5": "Very cautious of outsiders, ",
                        "6": "Cautious of outsiders, ",
                        "7": "Reasonably cautious of outsiders, ",
                        "8": "Reasonably tolerant of outsiders, ",
                        "9": "Tolerant of outsiders, ",
                        "10": "Very tolerant of outsiders, ",
                        "11": "Generally friendly toward outsiders, ",
                        "12": "Welcoming toward outsiders, ",
                        "13": "Very welcoming toward outsiders, ",
                        "14": "Extremely welcoming toward outsiders, ",
                        "15": "Excessively welcoming toward outsiders, ",
                        "16": "Xenophilic, ",
                        "17": "Very Xenophilic, ",
                        "18": "Extremely Xenophilic, ",
                        "19": "Excessively Xenophilic, ",
                        "20": "Fanatically Xenophilic, ",
                        "21": "Fanatically Xenophilic, "
                    },
                    "strangeness": {
                        // interstellar norm of 7, max 10
                        "0": "",
                        "1": "No local cultural input, ",
                        "2": "Almost no local cultural input, ",
                        "3": "Very slight local cultural input, ",
                        "4": "Slight local cultural input, ",
                        "5": "Minor local cultural input, ",
                        "6": "Only Modest cultural input and deviation from interstellar standards of behavior, ",
                        "7": "Average cultural input and deviation from interstellar standards of behavior, ",
                        "8": "Somewhat strange and deviant from interstellar standards of behavior, ",
                        "9": "Considerably strange and deviant from interstellar standards of behavior, ",
                        "10": "Strange culture, extremely deviant from interstellar standards of behavior, "
                    },

                    "symbols": {
                        // max of 27
                        "0": "",
                        "1": "Only concrete symbols",
                        "2": "Extremely concrete symbols",
                        "3": "Mostly concrete symbols",
                        "4": "Strong tendency toward more concrete symbols",
                        "5": "Tendency toward more concrete symbols",
                        "6": "Slight tendency toward more concrete symbols",
                        "7": "Normal complexity of symbols",
                        "8": "Slight tendency toward more abstract symbols",
                        "9": "Tendency toward more abstract symbols",
                        "10": "Strong tendency toward more abstract symbols",
                        "11": "Unusually abstract symbols",
                        "12": "Unusually abstract symbols",
                        "13": "Extremely abstract symbols",
                        "14": "Extremely abstract symbols",
                        "15": "Extremely abstract symbols",
                        "16": "Extremely abstract symbols",
                        "17": "Extremely abstract symbols",
                        "18": "Extremely abstract symbols",
                        "19": "Extremely abstract symbols",
                        "20": "Extremely abstract symbols",
                        "21": "Extremely abstract symbols",
                        "22": "Extremely abstract symbols",
                        "23": "Extremely abstract symbols",
                        "24": "Extremely abstract symbols",
                        "25": "Extremely abstract symbols",
                        "26": "Extremely abstract symbols",
                        "27": "Extremely abstract symbols",
                    },
                    "nobility": {
                        "B": "Knight",
                        "c": "Baronet",
                        "C": "Baron",
                        "D": "Marquis",
                        "e": "Viscount",
                        "E": "Count",
                        "f": "Duke",
                        "F": "Duke",
                        "G": "Archduke"
                    }
                };
                if (system.natives) {
                    document.getElementById("nativedetailscontainer").style.display = "block";
                    document.querySelectorAll("[data-detail]").forEach(function (elmt) {
                        var source = elmt.getAttribute("data-source");
                        var detail = elmt.getAttribute("data-detail");
                        var value = source === "species" ? system.natives[detail] : (source === "mainworld" ? system.mainworld[detail] : system.natives[source][detail]);
                        if (elmt.getAttribute("data-index")) {
                            value = value[+(elmt.getAttribute("data-index"))];
                        }
                        removeChildElements(elmt);
                        if (typeof value !== "undefined") {
                            if (elmt.getAttribute("data-html")) {
                                elmt.insertAdjacentHTML("beforeend", value);
                            } else {

                                elmt.appendChild(document.createTextNode(value));
                            }
                        }

                    });
                    var noteContainer = document.querySelector(".statnotes");
                    if (noteContainer) {
                        removeChildElements(noteContainer);
                        var notes = system.natives.statnotes;
                        for (var i = 0; i < notes.length; i++) {
                            var note = notes[i];
                            var noteElmt = document.createElement("li");
                            noteElmt.classList.add("note");
                            note = note.replace(/(?<=\[)(Str)?(Agi)?(Gra)?(Vig)?(Sta)?(Ins)?(Tra)?(Cas)?(Cha)?(?=\])/g, "<strong>$&</strong>");
                            note = note.replace(/(?<=\. ).+/g, "<p style=\"font-size:smaller; margin-top:0px; max-width:520px\">$&</p>")
                            noteElmt.insertAdjacentHTML("beforeend", note);
                            noteContainer.appendChild(noteElmt);
                        }
                    }
                } else {
                    document.getElementById("nativedetailscontainer").style.display = "none";
                }
                var systemTokens = document.querySelectorAll("[data-system]");
                for (var i = 0, len = systemTokens.length; i < len; i++) {
                    var el = systemTokens[i];
                    var key = el.getAttribute("data-system");
                    var val = {};
                    if (typeof system[key] === "string" || typeof system[key] === "number") {
                        val = system[key];
                    } else {
                        Object.assign(val, system[key]);
                        if (el.getAttribute("data-lookup")) {
                            var keys = Object.keys(val);
                            for (var j = 0, jlen = keys.length; j < jlen; j++) {
                                if (lookups[el.getAttribute("data-lookup")][val[keys[j]]]) {
                                    val[keys[j]] = lookups[el.getAttribute("data-lookup")][val[keys[j]]];
                                }
                            }
                        }
                        if (typeof el.getAttribute("data-join") !== "undefined") {
                            if (!val.join) {
                                val = Object.values(val);
                            }
                            val = val.join(el.getAttribute("data-join"));
                        }
                    }
                    if (val.toString() == "") {
                        if (el.getAttribute("data-ifblank")) {
                            val = el.getAttribute("data-ifblank");
                        }
                    }
                    el.innerHTML = val;
                }
                var mainworldTokens = document.querySelectorAll("[data-mainworld]");

                for (var i = 0, len = mainworldTokens.length; i < len; i++) {
                    var el = mainworldTokens[i];
                    var key = el.getAttribute("data-mainworld");

                    var val = {};

                    if (typeof system.mainworld[key] === "string" || typeof system.mainworld[key] === "number") {
                        val = system.mainworld[key];
                        if (el.getAttribute("data-lookup")) {
                            val = lookups[el.getAttribute("data-lookup")][val];
                        }
                        if (el.getAttribute("data-format") === "number") {
                            val = +val;
                            val = val.toLocaleString((navigator.languages && navigator.languages.length ? navigator.languages[0] : navigator.language) || 'en-us');
                        }
                    } else if (typeof system.mainworld[key] === "boolean") {
                        if (system.mainworld[key]) {
                            val = el.getAttribute("data-iftrue");
                        } else {
                            val = el.getAttribute("data-iffalse");
                        }
                    } else {
                        Object.assign(val, system.mainworld[key]);
                        if (el.getAttribute("data-lookup")) {
                            var keys = Object.keys(val);
                            for (var j = 0, jlen = keys.length; j < jlen; j++) {
                                if (lookups[el.getAttribute("data-lookup")][val[keys[j]]]) {
                                    val[keys[j]] = lookups[el.getAttribute("data-lookup")][val[keys[j]]];
                                }
                            }
                        }
                    }
                    if (typeof val === "undefined" || val.toString() == "") {
                        if (el.getAttribute("data-ifblank")) {
                            val = el.getAttribute("data-ifblank");
                        }
                    }
                    if (el.getAttribute("data-join")) {
                        if (!val.join) {
                            val = Object.values(val);
                        }
                        val = val.join(el.getAttribute("data-join"));
                    }
                    el.innerHTML = val;
                }
                var importanceTokens = document.querySelectorAll("[data-importance]");
                for (var i = 0, len = importanceTokens.length; i < len; i++) {
                    var el = importanceTokens[i];
                    var key = el.getAttribute("data-importance");
                    var val = system.importance[key]
                    if (el.getAttribute("data-showsign")) {
                        val = (+val >= 0 ? "+" : "") + val;
                    }
                    el.innerHTML = val;

                }
                var economicsTokens = document.querySelectorAll("[data-economics]");
                for (var i = 0, len = economicsTokens.length; i < len; i++) {
                    var el = economicsTokens[i];
                    var key = el.getAttribute("data-economics");
                    var val = system.economics[key]
                    if (el.getAttribute("data-showsign")) {
                        val = (+val >= 0 ? "+" : "") + val;
                    }
                    el.innerHTML = val;
                }
                var cultureTokens = document.querySelectorAll("[data-culture]");
                for (var i = 0, len = cultureTokens.length; i < len; i++) {
                    var el = cultureTokens[i];
                    var key = el.getAttribute("data-culture");
                    var val = system.mainworld.cultural[key]
                    if (el.getAttribute("data-showsign")) {
                        val = (+val >= 0 ? "+" : "") + val;
                    }
                    if (el.getAttribute("data-lookup")) {
                        val = lookups[el.getAttribute("data-lookup")][val];
                    }
                    el.innerHTML = val;
                }
                var list = document.getElementById("maplist");
                clearElement(list);
                var description;
                if (system.stars.primary.size == "D") {
                    description = "White Dwarf";
                } else {
                    description = system.stars.primary.type + (typeof system.stars.primary.decimal === "undefined" ? "" : system.stars.primary.decimal.toString()) + " " + system.stars.primary.size;
                }
                description += ". ";// + getLimitString(system.stars.primary);
                var primli = list.appendChild(document.createElement("li"));
                primli.appendChild(document.createTextNode( "Primary Star: " + description ));
                addLineToElement(primli, getLimitString(system.stars.primary));
                primli.classList.add("star");
                for (var i = 0, len = system.stars.primary.satellites.length; i < len; i++) {
                    var slot = system.stars.primary.satellites[i];
                    if (slot && typeof slot !== "undefined") {
                        var description = "";
                        var orbitingStar = false;
                        var types = slot.worldtype.split(" ");
                        if (slot.worldtype.toLowerCase().indexOf("star") >= 0) {
                            orbitingStar = true;
                            if (slot.type === "BD") {
                                description = "Brown Dwarf";
                            } else {
                                if (slot.size == "D") {
                                    description = "White Dwarf";
                                } else {
                                    description = slot.type + (typeof slot.decimal === "undefined" ? "" : slot.decimal.toString()) + " " + slot.size;
                                }
                            }
                            description += "; " + getLimitString(slot)
                        } else {
                            orbitingStar = false;
                            description = slot.uwp;
                            if (typeof description === "undefined") { console.log("undefined uwp."); console.log(slot); }
                        }
                        if(slot.tradecodes && slot.tradecodes.length > 0){
                            description += " [" + slot.tradecodes.join(",") + "]";
                        }
                        var li = list.appendChild(document.createElement("li"));
                        for (var s = 0; s < types.length; s++) {
                            li.classList.add(types[s]);
                        }
                        li.appendChild(document.createTextNode(
                            "Orbit " + slot.decimalOrbit + " (" + slot.au + " AU) "+addCaps(slot.worldtype)
                        ));
                        addLineToElement(li,description);
                        //addLineToElement(li,description);
                        if (!orbitingStar && slot.worldtype !== "Occupied" && slot.worldtype !== "Solar Surface" && slot.uwp) {
                            var pop = dext(slot.uwp[4]);
                            if (pop > 0) {
                                li.classList.add("populated");
                                li.appendChild(document.createTextNode("üë§"));
                            } else if (slot.uwp[8] !== "0") {

                                li.classList.add("dieback");
                                li.appendChild(document.createTextNode("üíÄ"));
                            }
                            if (+(slot.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")) {
                                li.classList.add("Worldlet");
                            }
                        }
                        if (slot.satellites) {
                            var subOrbitingStar = false;
                            var sublist = list.appendChild(document.createElement("ul"));
                            for (var j = 0, jlen = slot.satellites.length; j < jlen; j++) {
                                if (typeof slot.satellites[j] !== "undefined" && slot.satellites[j]) {
                                    var subslot = slot.satellites[j];
                                    var desc = "";
                                    var subtypes = subslot.worldtype.split(" ");
                                    if (subslot.worldtype.toLowerCase().indexOf("star") >= 0) {
                                        subOrbitingStar = true;
                                        if (subslot.type === "BD") {
                                            desc = "Brown Dwarf";
                                        } else {
                                            if (subslot.size == "D") {
                                                desc = "White Dwarf";
                                            } else {
                                                desc = subslot.type + (typeof subslot.decimal === "undefined" ? "" : subslot.decimal.toString()) + " " + subslot.size;
                                            }

                                        }
                                        desc += "; " + getLimitString(subslot)
                                    } else {
                                        subOrbitingStar = false;
                                        if(subslot.worldtype.indexOf("Ring System") >= 0){
                                            desc = "";
                                        }else{
                                            desc = subslot.uwp;
                                            if(subslot.tradecodes && subslot.tradecodes.length > 0){
                                                desc += " [" + subslot.tradecodes.join(",") + "]";
                                            }
                                        }
                                    }
                                    var text = "";
                                    if (!orbitingStar) {
                                        text = "Orbit " + sat(j) + " (" + satDistance(j, subslot.primarysize, slot.worldtype.indexOf("Giant") > 0).toString() + ")";
                                    } else {
                                        text = "Orbit " + subslot.decimalOrbit + " (" + subslot.au + " AU)";
                                    }
                                    text += " " + addCaps(subslot.worldtype);
                                    var li = sublist.appendChild(document.createElement("li"));
                                    li.appendChild(document.createTextNode(text));
                                    addLineToElement(li,desc);
                                    for (var s = 0; s < subtypes.length; s++) {
                                        li.classList.add(subtypes[s]);
                                    }
                                    if (subslot.isMainworld) { li.classList.add("mainworld"); }
                                    if (!subOrbitingStar && subslot.worldtype !== "Occupied" && subslot.worldtype !== "Solar Surface" && subslot.uwp) {
                                        var pop = dext(subslot.uwp[4]);
                                        if (pop > 0) {
                                            li.classList.add("populated");
                                            li.appendChild(document.createTextNode("üë§"));
                                        } else if (subslot.uwp[8] !== "0") {

                                            li.classList.add("dieback");
                                            li.appendChild(document.createTextNode("üíÄ"));
                                        }
                                        if (+(subslot.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")) {
                                            li.classList.add("Worldlet");
                                        }
                                    }
                                    if (subslot.satellites) {
                                        subsublist = sublist.appendChild(document.createElement("ul"));
                                        for (var k = 0, klen = subslot.satellites.length; k < klen; k++) {
                                            var subsub = subslot.satellites[k];
                                            var desc = "";
                                            if (typeof subsub !== "undefined" && subsub) {
                                                if (subsub.worldtype.indexOf("star") >= 0) {
                                                    if (subsub.type === "BD") {
                                                        desc = "Brown Dwarf";
                                                    } else {
                                                        if (subsub.size == "D") {
                                                            desc = "White Dwarf";
                                                        } else {
                                                            desc = subsub.type + (typeof subsub.decimal === "undefined" ? "" : subsub.decimal.toString()) + " " + subsub.size;
                                                        }

                                                    }
                                                    desc += "; " + getLimitString(subsub)
                                                } else {
                                                    if(subsub.worldtype.indexOf("Ring System") >= 0){
                                                        desc = "";
                                                    }else{
                                                        desc = subsub.uwp;
                                                        if(subsub.tradecodes && subsub.tradecodes.length > 0){
                                                            desc += " [" + subsub.tradecodes.join(",") + "]";
                                                        }
                                                    }                                                    
                                                }
                                                
                                                var subsubtypes = subsub.worldtype.split(" ");
                                                var text = "";
                                                if (subOrbitingStar) {
                                                    text = "Orbit " + subsub.decimalOrbit + " (" + subsub.au + " AU)";
                                                } else {
                                                    text = "Orbit " + sat(k) + " (" + satDistance(k, subsub.primarysize, subslot.worldtype.indexOf("Giant") >= 0).toString() + ")";
                                                }
                                                text += " " + subsub.worldtype;
                                                var li = subsublist.appendChild(document.createElement("li"))
                                                li.appendChild(document.createTextNode(text));
                                                addLineToElement(li,addCaps(desc));
                                                for (var s = 0; s < subsubtypes.length; s++) {
                                                    li.classList.add(subsubtypes[s]);
                                                }
                                                if (subsub.isMainworld) { li.classList.add("mainworld"); }
                                                if (!subOrbitingStar && subsub.worldtype !== "Occupied" && subsub.worldtype !== "Solar Surface" && subsub.uwp) {
                                                    var pop = dext(subsub.uwp[4]);
                                                    if (pop > 0) {
                                                        li.classList.add("populated");
                                                        li.appendChild(document.createTextNode("üë§"));
                                                    } else if (subsub.uwp[8] !== "0") {

                                                        li.classList.add("dieback");
                                                        li.appendChild(document.createTextNode("üíÄ"));
                                                    }
                                                    if (+(subsub.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")) {
                                                        li.classList.add("Worldlet");
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                console.log(system);
                function getLimitString(star) {
                    return "100D=Orbit " + star.jlimit.toString() + " (" + lookups["orbitdistance"][star.jlimit.toString()] + ") 1000D=Orbit " + star.mlimit + " (" + lookups["orbitdistance"][star.mlimit.toString()] + ")"
                }
                var tradePartners = document.getElementById("TradePartners");
                clearElement(tradePartners);
                if(system.neighbors){
                    system.neighbors.sort(function(a,b){
                        if(a.trade > b.trade){
                            return -1;
                        }else if(b.trade > a.trade){
                            return 1;
                        }else if(a.name < b.name){
                            return -1;
                        }else{
                            return 1;
                        }
                    });
                    var ul = tradePartners.appendChild(document.createElement(ul));
                    for(var i = 0, len = system.neighbors.length; i < len; i++){
                        var neighbor = system.neighbors[i];
                        var li = ul.appendChild(document.createElement("li"));
                        var details;
                        if(neighbor.mutual){
                            details = "Mutual trade with ";
                        }else if(neighbor.export > 0){
                            details = "Exports to ";
                        }else if(neighbor.import > 0){
                            details = "Imports from ";
                        }else{
                            details = "Incidental traffic from ";
                        }
                        details +=  neighbor.name + " (" + neighbor.tcoord + ", Jump-"+neighbor.distance+")";
                        li.appendChild(document.createTextNode(
                            details
                        ))
                    }
                }
                
            }
            function addLineToElement(el,text){
                el.appendChild(document.createElement("br"));
                el.appendChild(document.createTextNode(text));
            }
            function dext(txt) {
                var tempInt = parseInt(txt, 36);
                if (tempInt <= 17) {
                    return tempInt;
                } else if (tempInt <= 23) {
                    return tempInt - 1;
                } else {
                    return tempInt - 2;
                }
            }

            function sat(i) {
                var orbits = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
                return orbits[i];
            }
            function satDistance(i, primarySize, isGasGiant) {
                if (typeof isGasGiant == "undefined") { isGasGiant = false; }
                var multipliers = [1, 2, 3, 4, 5, 6, 8, 10, 20, 30, 40, 50, 60, 70, 80, 100, 150, 200, 250, 300, 400, 500, 600, 700, 800, 1000];
                if (isGasGiant) {
                    var sizeCalc = primarySize;
                    switch (sizeCalc) {
                        case 21: primarySize = 30; break;
                        case 22: primarySize = 40; break;
                        case 23: primarySize = 50; break;
                        case 24: primarySize = 60; break;
                        case 25: primarySize = 70; break;
                        case 26: primarySize = 80; break;
                        case 27: primarySize = 90; break;
                        case 28: primarySize = 125; break;
                        case 29: primarySize = 180; break;
                        case 30: primarySize = 220; break;
                        case 31: primarySize = 250; break;
                        default: break;
                    }
                }
                var distance = multipliers[i] * 1000 * primarySize;
                if (distance < 1495978) {
                    var strDistanceUnformatted = distance.toString();
                    var strDistance = "";
                    var cursor = strDistanceUnformatted.length - 1;

                    if (strDistanceUnformatted.length > 3) {
                        var counter = 0;
                        while (cursor >= 0) {
                            var digit = strDistanceUnformatted[cursor];
                            cursor -= 1;

                            if (counter % 3 == 0 && counter > 0) {
                                strDistance = digit + "," + strDistance;
                            } else {
                                strDistance = digit + strDistance;
                            }
                            counter += 1;
                        }

                    } else {
                        strDistance = strDistanceUnformatted;
                    }
                    /*for(var j = strDistance.length-1; j >= 0; j--){
                        if(j % 3 === 0 && j !== 0){
                            strDistance = strDistance.substring(0,j) + "," + strDistance.substring(j);
                        }
                    }*/
                    strDistance += " km";
                } else {
                    strDistance = (distance / 149597871).toFixed(2) + " AU";
                }
                return strDistance;// / 149 597 871;
            }
            function generateShipTraffic(){
                var shipList = [];
                var shipNames = {};
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(mapContent[i].system){
                        var system = mapContent[i].system;
                        var numShips = Number(system.importance.weeklytraffic);
                        for(var n = 0; n < numShips; n++){
                            var shipName = addCaps(wordMaker.getRandomName("ship"));
                            while (Object.keys(shipNames).indexOf(shipName) >= 0) {
                                shipName = addCaps(wordMaker.getRandomName("ship"));
                            }
                            shipNames[shipName] = true;
                            shipList.push({name:shipName,port:system.name+" ("+numShips+")",hex:system.tcoord});
                        }
                    }
                }
                //console.log(shipList.concat());
                shipList.sort(function(a,b){
                    if(a.port < b.port){return -1;}
                    else if(b.port < a.port){ return 1;}
                    else if(a.name < b.name){ return -1;}
                    else if(b.name < a.name){ return 1;}
                    else{ return 0; }
                });
                console.log(shipList);
                var listContainer = document.getElementById("shipList");
                clearElement(listContainer);
                var lastSystem = null, systemNode = null;
                for(var i = 0, len = shipList.length; i < len; i++){
                    var ship = shipList[i];
                    if(ship.port !== lastSystem){
                        var systemLabel = listContainer.appendChild(document.createElement("h2"));
                        systemLabel.className = "collapsed";
                        systemLabel.appendChild(document.createTextNode(ship.hex + " " + ship.port));
                        systemLabel.addEventListener("click",function(el){
                            if(el.target.className !== "collapsed"){
                                el.target.className = "collapsed";
                            }else{el.target.classList.remove("collapsed");}
                        });
                        systemNode = listContainer.appendChild(document.createElement("ol"));
                        lastSystem = ship.port;
                    }
                    systemNode.appendChild(document.createElement("li")).appendChild(document.createTextNode(ship.name));
                }
                document.getElementById("btnExpandCollapseTraffic").style.display = "inline-block";
            }
            
            function getCargo(tl,tradeCodes,allowImbalances){
                if(typeof allowImbalances === "undefined"){ allowImbalances = true;}
                
                var cost = 3000;
                var relevantCodes =[];
                var labelCodes = [];
                var details = [""];
                for(var i = 0, len = tradeCodes.length; i < len; i++){
                    var code = tradeCodes[i];
                    switch(code){
                        case "Ag": 
                        case "As": 
                        case "Po": 
                        case "In": relevantCodes.push(code);
                        case "Hi": cost -= 1000; labelCodes.push(code); break;
                        case "Fl": 
                        case "Ri": 
                        case "Va": 
                        case "De": relevantCodes.push(code);
                        case "Lo": 
                        case "Ni":
                        case "Ba": cost += 1000;  labelCodes.push(code); break;
                        case "Fa":
                        case "Ic": 
                        case "Na": 
                        case "Cp": 
                        case "Cs": 
                        case "Cx": 
                        case "Ga": relevantCodes.push(code);break;
                        case "Po": labelCodes.push(code);
                        default: break;
                    }
                }
                if(tradeCodes.indexOf("As") >= 0){ details.push("Strange"); }
                if(tradeCodes.indexOf("Ba") >= 0){ details.push("Gathered"); }
                if(tradeCodes.indexOf("De") >= 0){ details.push("Mineral"); }
                if(tradeCodes.indexOf("Di") >= 0){ details.push("Artifact"); }
                if(tradeCodes.indexOf("Fl") >= 0){ details.push("Unusual"); }
                if(tradeCodes.indexOf("Fl") >= 0){ details.push("Unusual"); }
                if(tradeCodes.indexOf("Ga") >= 0){ details.push("Premium"); }
                if(tradeCodes.indexOf("He") >= 0){ details.push("Strange"); }
                if(tradeCodes.indexOf("Hi") >= 0 && tradeCodes.indexOf("In") === -1){ details.push("Processed"); }
                if(tradeCodes.indexOf("Ic") >= 0){ details.push("Cryo"); }
                //if(tradeCodes.indexOf("Lo") >= 0){ details.push("Unlabeled"); }
                if(tradeCodes.indexOf("Ni") >= 0){ details.push("Unprocessed"); }
                // if(tradeCodes.indexOf("Oc") >= 0){ details.push("Obscure"); }
                if(tradeCodes.indexOf("Po") >= 0){ details.push("Obscure"); }
                if(tradeCodes.indexOf("Ri") >= 0){ details.push("Quality"); }
                if(tradeCodes.indexOf("Va") >= 0 && tradeCodes.indexOf("As") === -1){ details.push("Exotic"); }
                if(tradeCodes.indexOf("Wa") >= 0){ details.push("Infused"); }
                
                if(relevantCodes.length === 0){ relevantCodes = ["Na"]; }
                
                var tableCode = relevantCodes[(Math.random()*relevantCodes.length) >>> 0]
                var prefix = (details.length > 0 ? (details[(Math.random()*details.length) >>> 0]) : "");
                if(prefix.length > 0){ prefix += " ";}
                
                cost += tl*100;
                var cargocode = tl.toString() + " - " + labelCodes.join(" ");
                if(labelCodes.length == 0 || labelCodes[0].length === 0){
                    cargocode += "(No Trade Codes)"
                }
                cargocode += " - Cr " + cost;
                var description = "typical cargo";
                if(allowImbalances){
                    description = getTradeGood(prefix, tableCode);
                }
                return {code:cargocode, cost:cost, tradeCodes:tradeCodes, description:description, tl:tl};
            }

            function getTradeGood(prefix, tableCode){
                var d6 = function d6(num){
                    if(!num){ num = 1;}
                    var sum = 0;
                    for(var i = 0; i < num; i++){
                        sum += ((Math.random()*6) >>> 0) + 1;
                    }           
                    return sum;
                }
                if(tableCode === "Ag"){ 
                    tableCode = (Math.random()*2) >>> 0 == 1 ? "Ga" : "Fa";
                }else if(tableCode === "Cs" || tableCode === "Cx"){ tableCode = "Cp";}
                var goods = {
                    "Ga":{
                        types:["Raws","Consumables","Pharma","Novelties","Rares","Imbalances"],
                        tables:[
                            ["Bulk Protein","Bulk Carbs","Bulk Fats", "Bulk Pharma", "Livestock", "Seedstock"],
                            ["Flavored Waters","Wines","Juices","Nectars","Decoctions","Drinkable Lymphs"],
                            ["Health Foods","Nutraceuticals","Fast Drug","Painkillers","Antiseptic","Antibiotics"],
                            ["Incenses","Iridescents","Photonics","Pigments","Noisemakers","Soundmakers"],
                            ["Fine Furs","Meat Delicacies","Fruit Delicacies","Candies","Textiles","Exotic Sauces"],
                            ["As","De","Fl","Ic","Na","In"]
                        ]},
                    "Fa":{
                        types:["Raws","Consumables","Pharma","Novelties","Rares","Imbalances"],
                        tables:[
                            ["Bulk Woods","Bulk Pelts","Bulk Herbs","Bulk Spices","Bulk Nitrates","Foodstuffs"],
                            ["Flowers","Aromatics","Pheromones","Secretions","Adhesives","Novel Flavorings"],
                            ["Antifungals","Antivirals","Panacea","Pseudomones","Anagathics","Slow Drug"],
                            ["Strange Seeds","Motile Plants","Reactive Plants","Reactive Woods","IR Emitters","Lek Emitters"],
                            ["Spices","Organic Gems","Flavorings","Aged Meats","Fermented Fluids","Fine Aromatics"],
                            ["Po","Ri","Va","Ic","Na","In"]
                        ]
                    },
                    "As":{
                        types:["Raws","Samples","Valuta","Novelties","Rares","Imbalances"],
                        tables:[
                            ["Bulk Nitrates","Bulk Carbon","Bulk Iron","Bulk Copper","Radioactive Ores","Bulk Ices"],
                            ["Ores","Ices","Carbons","Metals","Uranium","Chelates"],
                            ["Platinum","Gold","Gallium","Silver","Thorium","Radium"],
                            ["Unusual Rocks","Fused Metals","Strange Crystals","Fine Dusts","Magnetics","Light-Sensitives"],
                            ["Gemstones","Alloys","Iridium Sponge","Lanthanum","Isotopes","Anti-Matter"],
                            ["Ag","De","Na","Po","Ri","Ic"]
                        ]
                    },
                    "De":{
                        types:["Raws","Samples","Pharma","Novelties","Rares","Uniques"],
                        tables:[
                            ["Bulk Nitrates","Bulk Minerals","Bulk Abrasives","Bulk Particulates","Exotic Fauna","Exotic Flora"],
                            ["Archeologicals","Fauna","Flora","Minerals","Ephemerals","Polymers"],
                            ["Stimulants","Bulk Herbs","Palliatives","Pheromones","Antibiotics","Combat Drug"],
                            ["Envirosuits","Reclamation Suits","Navigators","Dupe Masterpieces","ShimmerCloth","ANIFX Blocker"],
                            ["Excretions","Flavorings","Nectars","Pelts","ANIFX Dyes","Seedstock"],
                            ["Pheromones","Artifacts","Sparx","Repulsant","Dominants","Fossils"]
                        ]
                    },
                    "Fl":{
                        types:["Raws","Samples","Pharma","Novelties","Rares","Imbalances"],
                        tables:[
                            ["Bulk Carbon","Bulk Petros","Bulk Precipitates","Exotic Fluids","Organic Polymers","Bulk Synthetics"],
                            ["Archeologicals","Fauna","Flora","Germanes","Flill","Chelates"],
                            ["Antifungals","Antivirals","Palliatives","Counter-prions","Antibiotics","Cold Sleep Pills"],
                            ["Silanes","Lek Emitters","Aware Blockers","Soothants","Self-Solving Puzzles","Fluidic Timepieces"],
                            ["Flavorings","Unusual Fluids","Encapsulants","Insidiants","Corrosives","Exotic Aromatics"],
                            ["In","Ri","Ic","Na","Ag","Po"]
                        ]
                    },
                    "Ic":{
                        types:["Raws","Samples","Pharma","Novelties","Rares","Uniques"],
                        tables:[
                            ["Bulk Ices","Bulk Precipitates","Bulk Ephemerals","Exotic Flora","Bulk Gases","Bulk Oxygen"],
                            ["Archeologicals","Fauna","Flora","Minerals","Luminescents","Polymers"],
                            ["Antifungals","Antivirals","Palliatives","Restoratives","Antibiotics","Antiseptics"],
                            ["Heat Pumps","Mag Emitters","Percept Blockers","Silanes","Cold Light Blocks","VHDUS Blocker"],
                            ["Unusual Ices","Cryo Alloys","Rare Minerals","Unusual Fluids","Cryogems","VHDUS Dyes"],
                            ["Fossils","Cryogems","Vision Suppressant","Fission Suppressant","Wafers","Cold Sleep Pills"]
                        ]
                    },
                    "Na":{
                        types:["Raws","Samples","Novelties","Rares","Uniques","Imbalances"],
                        tables:[
                            ["Bulk Abrasives","Bulk Gases","Bulk Minerals","Bulk Precipitates","Exotic Fauna","Exotic Flora"],
                            ["Archeologicals","Fauna","Flora","Minerals","Ephemerals","Polymers"],
                            ["Branded Tools","Drinkable Lymphs","Strange Seeds","Pattern Creators","Pigments","Warm Leather"],
                            ["Hummingsand","Masterpieces","Fine Carpets","Isotopes","Pelts","Seedstock"],
                            ["Masterpieces","Unusual Rocks","Artifacts","Non-Fossil Carca","Replicating Clays", "ANIFX Emitter"],
                            ["Ag","Ri","In","Ic","De","Fl"]
                        ]
                    },
                    "In":{
                        types:["Manufactureds","Scrap/Waste","Manufactureds","Pharma","Data","Consumables"],
                        tables:[
                            ["Electronics","Photonics","Magnetics","Fluidics","Polymers","Gravitics"],
                            ["Obsoletes","Used Goods","Reparables","Radioactives","Metals","Sludges"],
                            ["Biologics","Mechanicals","Textiles","Weapons","Armor","Robots"],
                            ["Nostrums","Restoratives","Palliatives","Chelates","Antidotes","Antitoxins"],
                            ["Software","Databases","Expert Systems","Upgrades","Backups","Raw Sensings"],
                            ["Disposables","Respirators","Filter Masks","Combination","Parts","Improvements"]
                        ]
                    },
                    "Po":{
                        types:["Raws","Entertainments","Novelties","Rares","Uniques","Imbalances"],
                        tables:[
                            ["Bulk Nutrients","Bulk Fibers","Bulk Organics","Bulk Minerals","Bulk Textiles","Exotic Flora"],
                            ["Art","Recordings","Writings","Tactiles","Osmancies","Wafers"],
                            ["Strange Crystals","Strange Seeds","Pigments","Emotion Lighting","Silanes","Flora"],
                            ["Gemstones","Antiques","Collectibles","Allotropes","Spices","Seedstock"],
                            ["Masterpieces","Exotic Flora","Antiques","Incomprehensibles","Fossils","VHDUS Emitter"],
                            ["In","Ri","Fl","Ic","Ag","Va"]
                        ]
                    },
                    "Ri":{
                        types:["Raws","Novelties","Consumables","Rares","Uniques","Entertainments"],
                        tables:[
                            ["Bulk Foodstuffs","Bulk Protein","Bulk Carbs","Bulk Fats","Exotic Flora","Exotic Fauna"],
                            ["Echostones","Self-Defenders","Attractants","Sophont Cuisine","Sophont Hats","Variable Tattoos"],
                            ["Branded Foods","Branded Drinks","Branded Clothes","Flavored Drinks","Flowers","Music"],
                            ["Delicacies","Spices","Tisanes","Nectars","Pelts","Variable Tattoos"],
                            ["Antique Art","Masterpieces","Artifacts","Fine Art","Meson Barriers","Famous Wafers"],
                            ["Edutainments","Recordings","Writings","Tactiles","Osmancies","Wafers"]
                        ]
                    },
                    "Va":{
                        types:["Raws","Novelties","Consumables","Rares","Samples","Scrap/Waste"],
                        tables:[
                            ["Bulk Dusts","Bulk Minerals","Bulk Metals","Radioactive Ores","Bulk Particulates","Ephemerals"],
                            ["Branded Vacc Suits","Awareness Pinger","Strange Seeds","Pigments","Unusual Minerals","Exotic Crystals"],
                            ["Branded Oxygen","Vacc Suit Scents","Vacc Suit Patches","Branded Tools","Holo-Companions","Flavored Air"],
                            ["Vacc Gems","Unusual Dusts","Insulants","Crafted Devices","Rare Minerals","Catalysts"],
                            ["Archeologicals","Fauna","Flora","Minerals","Ephemerals","Polymers"],
                            ["Obsoletes","Used Goods","Reparables","Plutonium","Metals","Sludges"]
                        ]
                    },
                    "Cp":{
                        types:["Data","Novelties","Consumables","Rares","Valuta","Red Tape"],
                        tables:[
                            ["Software","Expert Systems","Databases","Upgrades","Backups","Raw Sensings"],
                            ["Incenses","Contemplatives","Cold Welders","Polymer Sheets","Has","Skin Tones"],
                            ["Branded Clothes","Branded Devices","Flavored Drinks","Flavorings","Decorations","Group Symbols"],
                            ["Monumental Art","Holo Sculpture","Collectible Books","Jewelry","Museum Items","Monumental Art"],
                            ["Coinage","Currency","Money Cards","Gold","Silver","Platinum"],
                            ["Reguations","Synchronizations","Expert Systems","Educationals","Mandates","Accountings"]
                        ]
                    }
                }
                var roll1 = d6()-1, roll2 = d6()-1;
                var type = goods[tableCode].types[roll1];
                if(type !== "Imbalances"){
                    return type + " (" + prefix + goods[tableCode].tables[roll1][roll2] + ")";
                }else{
                    var imbalanceCategory = goods[tableCode].tables[roll1][roll2];
                    return "Imbalance [+"+imbalanceCategory+"] " + getTradeGood(prefix,imbalanceCategory);
                }
            }
            function calculatePrice(cargo,destTl,destCodes){
                var tl = cargo.tl;
                var tradeCodes = cargo.tradeCodes;
                var price = 5000;
                destLen = destCodes.length;
                for(var i = 0, len = tradeCodes.length; i < len ; i++){
                    var code = tradeCodes[i];
                    var bonusCodes = [];
                    switch(code){
                        case "Ag": bonusCodes = ["Ag","As","De","Hi","In","Ri","Va"]; break;
                        case "As": bonusCodes = ["As","In","Ri","Va"]; break;
                        case "Ba": bonusCodes = ["In"]; break;
                        case "De": bonusCodes = ["De"]; break;
                        case "Fl": bonusCodes = ["Fl","In"]; break;
                        case "Hi": bonusCodes = ["Hi"]; break;
                        case "In": bonusCodes = ["Ag","As","De","Fl","Hi","In","Ri","Va"]; break;
                        case "Na": bonusCodes = ["As","De","Va"]; break;
                        case "Ri": bonusCodes = ["Ag","De","Hi","In","Ri"]; break;
                        case "Va": bonusCodes = ["As","In","Va"]; break;
                    }
                    for(var j = 0; j < destLen; j++){
                        if(bonusCodes.indexOf(destCodes[j]) >= 0){
                            price += 1000;
                        }
                    }
                    if(code === "Po"){
                        var penaltyCodes =["Ag","Hi","In","Ri"]; 
                        for(var j = 0; j < destLen; j++){
                            if(penaltyCodes.indexOf(destCodes[j]) >= 0){
                                price -= 1000;
                            }
                        }
                    }
                }
                var tlEffect = (tl-destTl)*.1*price;
                price += tlEffect;

                if(cargo.description.indexOf("[+") >= 0){
                    var re = /(?<=\[\+).*(?=\])/g
                    var imbalanceCodes = cargo.description.match(re);
                    for(var i = 0, len = imbalanceCodes.length; i < len; i++){
                        iCode = imbalanceCodes[i];
                        if(destCodes.indexOf(iCode) >= 0){
                            price += 1000;
                        }
                    }
                }
                price = Math.round(price);
                return price;
            }
            function updateSystemName(name){
                var tcoord = lastSelectedHex.system.tcoord;
                var xycoord = TCoordToXYCoord(tcoord);
                var index = XYtoIndex(xycoord.x,xycoord.y);
                mapContent[index].system.name = name;
                _systems[tcoord].name = name;
                systemArray[mapContent[index].system.sysArrayIndex].name = name;
                applyTravelCodes(mapContent);
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                drawMap(mapContent);
                renderSystem(mapContent[index].system);
                document.getElementById("sectordata").value = getSectorData(mapContent);
            }
            function updateSystemUWP(uwp){
                var tcoord = lastSelectedHex.system.tcoord;
                var xycoord = TCoordToXYCoord(tcoord);
                var index = XYtoIndex(xycoord.x,xycoord.y);
                mapContent[index].system.uwp = uwp;
                mapContent[index].system.starport = uwp[0];
                mapContent[index].system.mainworld.starport = uwp[0];
                mapContent[index].system.size = revExt(uwp[1]);
                mapContent[index].system.mainworld.size = revExt(uwp[1]);
                mapContent[index].system.atmo = revExt(uwp[2]);
                mapContent[index].system.mainworld.atmo = revExt(uwp[2]);
                mapContent[index].system.hydro = revExt(uwp[3]);
                mapContent[index].system.mainworld.hydro = revExt(uwp[3]);
                mapContent[index].system.pop = revExt(uwp[4]);
                mapContent[index].system.mainworld.pop = revExt(uwp[4]);
                mapContent[index].system.gov = revExt(uwp[5]);
                mapContent[index].system.mainworld.gov = revExt(uwp[5]);
                mapContent[index].system.law = revExt(uwp[6]);
                mapContent[index].system.mainworld.law = revExt(uwp[6]);
                mapContent[index].system.tech = uwp.length > 9 ? Number(uwp[8] + uwp[9]) : revExt(uwp[8]);
                mapContent[index].system.mainworld.tech = uwp.length > 9 ? Number(uwp[8] + uwp[9]) : revExt(uwp[8]);
                mapContent[index].system = updateTradeCodes(mapContent[index].system);
                _systems[tcoord] = mapContent[index].system;
                systemArray[mapContent[index].system.sysArrayIndex] = mapContent[index].system;
                applyTravelCodes(mapContent);
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                drawMap(mapContent);
                renderSystem(mapContent[index].system);
                document.getElementById("sectordata").value = getSectorData(mapContent);
            }
            function rerollSystemWithPredefinedUWP(uwp){
                var tcoord = lastSelectedHex.system.tcoord;
                var xycoord = TCoordToXYCoord(tcoord);
                var index = XYtoIndex(xycoord.x,xycoord.y);
                var name = mapContent[index].system.name;
                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked,
                mainworldRules =  document.getElementById("slctMainworldRules").value,
                applyHillSphereLimits = document.getElementById("chkApplyHillSphereLimits").checked,
                allowInnerWhiteDwarfs = document.getElementById("chkAllowInnerWhiteDwarfs").checked,
                populateNonMainworlds = document.getElementById("chkPopulateNonMainworlds").checked;
                var details = 
                            generateSystemDetails(tcoord, 
                                ggFrequency, 
                                permitDieback, 
                                maxTechLevel, 0, 
                                mainworldRules, 
                                populateNonMainworlds, 
                                applyHillSphereLimits, 
                                allowInnerWhiteDwarfs,uwp);
                            for (var i = 0, len = mins.length; i < len; i++) {
                                var currValue;
                                if (i < 8) {
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }
                                else if (i === 8) {
                                    currValue = details.importance.extension;
                                } else if (i === 9) {
                                    currValue = details.totalpop;
                                    if (currValue > 0) { currValue = Math.round(Math.log10(currValue)); }
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                } else if (i === 10) {
                                    currValue = details.economics.RU;
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }

                            }
                            var system = {
                                name: name,
                                mainworld: details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg: details.gg,
                                isAsteroidBelt: details.mainworld.isAsteroidBelt,
                                planetoidBelts: details.planetoidBelts,
                                bases: details.bases,
                                stars: details.stars,
                                economics: details.economics,
                                importance: details.importance,
                                totalpop: details.totalpop,
                                tcoord: tcoord,
                                pbg: details.pbg,
                                allegiance: details.allegiance,
                                isRed: false,
                                isAmber: false,
                                nobility: details.nobility,
                                sysArrayIndex:mapContent[index].system.sysArrayIndex,
                                index:mapContent[index].system.index 
                            };
                            var max = 0;
                            var likelihood = document.getElementById("slctNativeLikelihood").value
                            switch (likelihood) {
                                case "rare": // ~1 per sector
                                    max = 45;
                                    break;
                                case "reasonable": // ~1 per subsector
                                    max = 9;
                                    break;
                                case "common": // 1 in 2 chance per candidate world
                                    max = 2;
                                    break;
                                case "everywhere": // every non-exotic candidate world
                                    max = 1;
                                    break;
                                case "really": // every candidate world
                                    max = 1;
                                    break;
                            }
                            var native = rollNativeForWorld(system,likelihood,max);                            
                            mapContent[index].system = system;
                            _systems[tcoord] = system;
                            systemArray[mapContent[index].system.sysArrayIndex] = system;
                            if(native){
                                sortNatives();
                            }
                            applyTravelCodes(mapContent);
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                drawMap(mapContent);
                renderSystem(mapContent[index].system);
                document.getElementById("sectordata").value = getSectorData(mapContent);
            }
            function randomizerClicked(e){
                var rtype = e.target.getAttribute("data-randomize");
                var tcoord = lastSelectedHex.system.tcoord;
                var xycoord = TCoordToXYCoord(tcoord);
                var index = XYtoIndex(xycoord.x,xycoord.y);
                switch(rtype){
                    case "system": 
                        var name = mapContent[index].system.name;
                        var ggFrequency = document.getElementById("slctGGFrequency").value;
                        var density = document.getElementById("slctStellarDensity").value;
                        var permitDieback = document.getElementById("chkPermitDieback").checked;
                        var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                        var permitDieback = document.getElementById("chkPermitDieback").checked,
                        mainworldRules =  document.getElementById("slctMainworldRules").value,
                        applyHillSphereLimits = document.getElementById("chkApplyHillSphereLimits").checked,
                        allowInnerWhiteDwarfs = document.getElementById("chkAllowInnerWhiteDwarfs").checked,
                        populateNonMainworlds = document.getElementById("chkPopulateNonMainworlds").checked;
                        var details = 
                            generateSystemDetails(tcoord, 
                                ggFrequency, 
                                permitDieback, 
                                maxTechLevel, 0, 
                                mainworldRules, 
                                populateNonMainworlds, 
                                applyHillSphereLimits, 
                                allowInnerWhiteDwarfs);
                            for (var i = 0, len = mins.length; i < len; i++) {
                                var currValue;
                                if (i < 8) {
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }
                                else if (i === 8) {
                                    currValue = details.importance.extension;
                                } else if (i === 9) {
                                    currValue = details.totalpop;
                                    if (currValue > 0) { currValue = Math.round(Math.log10(currValue)); }
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                } else if (i === 10) {
                                    currValue = details.economics.RU;
                                    var currMin = mins[i], currMax = maxes[i];
                                    if (currValue < currMin) { mins[i] = currValue; }
                                    if (currValue > currMax) { maxes[i] = currValue; }
                                }

                            }
                            var system = {
                                name: name,
                                mainworld: details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg: details.gg,
                                isAsteroidBelt: details.mainworld.isAsteroidBelt,
                                planetoidBelts: details.planetoidBelts,
                                bases: details.bases,
                                stars: details.stars,
                                economics: details.economics,
                                importance: details.importance,
                                totalpop: details.totalpop,
                                tcoord: tcoord,
                                pbg: details.pbg,
                                allegiance: details.allegiance,
                                isRed: false,
                                isAmber: false,
                                nobility: details.nobility,
                                sysArrayIndex:mapContent[index].system.sysArrayIndex,
                                index:mapContent[index].system.index 
                            };
                            var max = 0;
                            var likelihood = document.getElementById("slctNativeLikelihood").value
                            switch (likelihood) {
                                case "rare": // ~1 per sector
                                    max = 45;
                                    break;
                                case "reasonable": // ~1 per subsector
                                    max = 9;
                                    break;
                                case "common": // 1 in 2 chance per candidate world
                                    max = 2;
                                    break;
                                case "everywhere": // every non-exotic candidate world
                                    max = 1;
                                    break;
                                case "really": // every candidate world
                                    max = 1;
                                    break;
                            }
                            var native = rollNativeForWorld(system,likelihood,max);                            
                            mapContent[index].system = system;
                            _systems[tcoord] = system;
                            systemArray[mapContent[index].system.sysArrayIndex] = system;
                            if(native){
                                sortNatives();
                            }
                            
                        break;
                    case "systemname":
                        var name = addCaps(wordMaker.getRandomName("system"));
                        mapContent[index].system.name = name;
                        _systems[tcoord].name = name;
                        systemArray[mapContent[index].system.sysArrayIndex].name = name;
                        break;
                    default: break;
                }
                applyTravelCodes(mapContent);
                var designateSubsectorCapitals = document.getElementById("chkDesignateSubsectorCapitals").checked;
                var designateSectorCapital = document.getElementById("chkDesignateSectorCapital").checked;
                analyzeMap(systemArray, designateSubsectorCapitals, designateSectorCapital);
                drawMap(mapContent);
                renderSystem(mapContent[index].system);
                document.getElementById("sectordata").value = getSectorData(mapContent);
            }
            function expandCollapseTraffic(e){
                var nodes = document.querySelectorAll("#shipList h2");
                if(e.target.getAttribute("data-action")==="collapse"){
                    e.target.setAttribute("data-action","expand");
                    for(var i = 0, len = nodes.length; i < len; i++){
                        nodes[i].classList.add("collapsed");
                    }
                    e.target.setAttribute("value","Expand All Systems");
                }else{   
                    e.target.setAttribute("data-action","collapse");
                    for(var i = 0, len = nodes.length; i < len; i++){
                        nodes[i].classList.remove("collapsed");
                    }
                    e.target.setAttribute("value","Collapse All Systems");
                }
            }
            function removeChildElements(element) {
                while (element.childNodes.length > 0) {
                    element.removeChild(element.childNodes[element.childNodes.length - 1]);
                }
            }
            function clearElement(el) {
                while (el.children.length > 0) {
                    el.removeChild(el.children[el.children.length - 1]);
                }
            }
        })();
    </script>
</body>
</html>